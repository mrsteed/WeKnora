# WeKnora 权限管理系统技术开发文档

> **文档版本**: v3.0
> **创建日期**: 2026-02-09
> **更新日期**: 2026-02-10
> **适用项目**: WeKnora 知识库管理平台
> **文档性质**: 技术开发设计文档（与当前代码匹配）

> **v3.0 更新说明**：
> - 文档全面修正以匹配实际代码实现
> - 当前系统采用 **Organization（共享空间）** 模型，而非原设计的 Department + RBAC 模型
> - 权限通过「租户隔离 + 组织角色（admin/editor/viewer）+ KB/Agent 共享」实现
> - 记录已实现的组织管理、知识库共享、Agent 共享全部功能
> - 附录中保留原 RBAC 设计方案作为未来可选扩展参考

---

## 目录

- [1. 项目概述与现状分析](#1-项目概述与现状分析)
  - [1.1 技术架构概览](#11-技术架构概览)
  - [1.2 当前权限模型](#12-当前权限模型)
- [2. 权限模型设计（已实现）](#2-权限模型设计已实现)
  - [2.1 整体权限架构](#21-整体权限架构)
  - [2.2 组织角色定义](#22-组织角色定义)
  - [2.3 知识库共享权限模型](#23-知识库共享权限模型)
  - [2.4 Agent 共享权限模型](#24-agent-共享权限模型)
- [3. 数据库设计（已实现）](#3-数据库设计已实现)
  - [3.1 组织相关表结构](#31-组织相关表结构)
  - [3.2 数据库迁移脚本](#32-数据库迁移脚本)
  - [3.3 ER 关系图](#33-er-关系图)
- [4. 后端 API 设计（已实现）](#4-后端-api-设计已实现)
  - [4.1 组织管理 API](#41-组织管理-api)
  - [4.2 成员管理 API](#42-成员管理-api)
  - [4.3 加入申请 API](#43-加入申请-api)
  - [4.4 知识库共享 API](#44-知识库共享-api)
  - [4.5 Agent 共享 API](#45-agent-共享-api)
  - [4.6 认证 API](#46-认证-api)
- [5. 后端实现方案（已实现）](#5-后端实现方案已实现)
  - [5.1 Go 类型定义](#51-go-类型定义)
  - [5.2 Repository 层](#52-repository-层)
  - [5.3 Service 层](#53-service-层)
  - [5.4 Handler 层](#54-handler-层)
  - [5.5 认证中间件](#55-认证中间件)
  - [5.6 路由注册](#56-路由注册)
  - [5.7 DI 容器注册](#57-di-容器注册)
- [6. 前端实现方案（已实现）](#6-前端实现方案已实现)
  - [6.1 状态管理](#61-状态管理)
  - [6.2 路由与守卫](#62-路由与守卫)
  - [6.3 菜单与页面结构](#63-菜单与页面结构)
  - [6.4 组织管理页面](#64-组织管理页面)
  - [6.5 设置页面](#65-设置页面)
  - [6.6 API 服务层](#66-api-服务层)
- [7. 未来扩展方向](#7-未来扩展方向)
- [8. 附录](#8-附录)
  - [8.1 数据字典](#81-数据字典)
  - [8.2 原 RBAC 设计方案（未实现，供参考）](#82-原-rbac-设计方案未实现供参考)

---

## 1. 项目概述与现状分析

### 1.1 技术架构概览

WeKnora 是一个基于知识库的智能问答平台，采用前后端分离架构：

| 层级 | 技术选型 |
|------|----------|
| **前端** | Vue ^3.5.13 + TypeScript ~5.8.0 + Vite ^7.2.2 + TDesign ^1.17.2 + Pinia ^3.0.1 + Vue Router ^4.5.0 + vue-i18n ^11.1.12 |
| **后端** | Go 1.24.0 + Gin v1.11.0 + GORM v1.25.12 + PostgreSQL |
| **DI 框架** | go.uber.org/dig v1.18.1 |
| **认证** | golang-jwt v5.3.0 (HS256) + API Key 双模式 |
| **异步任务** | Asynq (Redis-backed, go-redis v9.14.0) |
| **向量检索** | PostgreSQL pgvector / Elasticsearch v7/v8 / Qdrant |
| **图数据库** | Neo4j (driver v6.0.0-alpha.1) |
| **文件存储** | MinIO / COS / 本地文件系统 |

**后端分层架构**:

```
cmd/server/                      → 应用入口
internal/container/              → DI 容器配置（dig）
internal/router/                 → 路由定义（Gin）
internal/middleware/             → 中间件（CORS、Auth、Logger、Recovery、ErrorHandler、Tracing）
internal/handler/                → HTTP Handler 层
internal/handler/session/        → 会话 Handler（独立子包）
internal/application/service/    → 业务逻辑层（Service）
internal/application/repository/ → 数据访问层（Repository, GORM）
internal/types/                  → 数据模型 + DTO + 常量
internal/types/interfaces/       → Service/Repository 接口定义
internal/agent/                  → Agent 运行时（工具、推理链）
internal/stream/                 → 流式输出管理
internal/mcp/                    → MCP 协议集成
internal/models/                 → LLM 模型调用封装
internal/searchutil/             → 搜索工具
internal/tracing/                → 链路追踪
```

**前端目录结构**:

```
frontend/src/
├── api/              → API 服务层（Axios 封装）
│   ├── agent/            → Agent 管理
│   ├── auth/             → 认证（登录/注册/刷新）
│   ├── chat/             → 聊天对话
│   ├── initialization/   → 系统初始化
│   ├── knowledge-base/   → 知识库管理
│   ├── model/            → 模型管理
│   ├── organization/     → 组织（共享空间）管理
│   ├── skill/            → 技能管理
│   ├── system/           → 系统信息
│   ├── tenant/           → 租户管理
│   ├── mcp-service.ts    → MCP 服务
│   └── web-search.ts     → 网络搜索
├── components/       → 全局组件
│   ├── menu.vue              → 侧边栏菜单
│   ├── UserMenu.vue          → 用户菜单
│   ├── TenantSelector.vue    → 租户选择器
│   ├── AgentSelector.vue     → Agent 选择器
│   ├── AgentShareSettings.vue → Agent 共享设置
│   ├── KnowledgeBaseSelector.vue → 知识库选择器
│   ├── ShareKnowledgeBaseDialog.vue → 知识库共享弹窗
│   ├── ListSpaceSidebar.vue  → 空间列表侧边栏
│   ├── ModelSelector.vue     → 模型选择器
│   ├── Input-field.vue       → 输入组件
│   └── ...
├── router/           → 路由配置 + 守卫
├── stores/           → Pinia 状态管理
│   ├── auth.ts           → 认证状态（用户、令牌、租户）
│   ├── knowledge.ts      → 知识库状态
│   ├── menu.ts           → 菜单状态
│   ├── organization.ts   → 组织状态
│   ├── settings.ts       → 设置状态
│   └── ui.ts             → UI 状态
├── utils/            → 工具函数（request.ts 统一请求封装）
├── views/            → 页面视图
│   ├── auth/             → 登录页
│   ├── knowledge/        → 知识库管理
│   ├── agent/            → 智能体管理
│   ├── chat/             → 聊天对话
│   ├── creatChat/        → 创建会话
│   ├── organization/     → 组织管理
│   ├── settings/         → 系统设置
│   └── platform/         → 主布局
└── i18n/locales/     → 国际化（zh-CN, en-US, ru-RU, ko-KR）
```

### 1.2 当前权限模型

当前系统采用 **租户隔离 + Organization（共享空间）** 权限模型：

| 维度 | 当前实现 | 说明 |
|------|----------|------|
| **租户隔离** | 所有数据通过 `tenant_id` 隔离 | 基础数据边界 |
| **跨租户访问** | `users.can_access_all_tenants` + `X-Tenant-ID` header | 超级管理员跨租户切换 |
| **组织协作** | Organization（共享空间）模型 | 用户创建/加入组织，组织内共享资源 |
| **角色体系** | 组织内三级角色：admin / editor / viewer | 控制组织内操作权限 |
| **知识库共享** | `kb_shares` 表（组织级） | 知识库可共享给指定组织 |
| **Agent 共享** | `agent_shares` 表（组织级） | Agent 可共享给指定组织 |
| **认证方式** | JWT Bearer Token + API Key 双模式 | Auth 中间件统一处理 |
| **路由守卫** | 仅检查 `isLoggedIn` | 前端无角色级路由控制 |

#### 认证流程（中间件链）

```
请求 → CORS → RequestID → Logger → Recovery → ErrorHandler → Health → Auth中间件 → Tracing → Handler
```

Auth 中间件（`internal/middleware/auth.go`）执行逻辑：
1. OPTIONS 请求直接放行
2. 免认证路径直接放行：
   - `GET /health`
   - `POST /api/v1/auth/register`
   - `POST /api/v1/auth/login`
   - `POST /api/v1/auth/refresh`
3. 尝试 JWT Bearer Token → 验证 token → 注入 `TenantID`/`TenantInfo`/`User`/`UserID` 到 context
   - 支持 `X-Tenant-ID` header 跨租户切换（需 `CanAccessAllTenants=true` 且配置启用 `EnableCrossTenantAccess`）
4. 尝试 API Key (`X-API-Key` header) → 获取 tenant → 注入 `TenantID`/`TenantInfo` 到 context
5. 均无 → 返回 401

Context Key 常量（定义于 `internal/types/const.go`）：

```go
TenantIDContextKey        = "TenantID"
TenantInfoContextKey      = "TenantInfo"
UserContextKey            = "User"
UserIDContextKey          = "UserID"
SessionTenantIDContextKey = "SessionTenantID"
```

#### 当前数据模型

```sql
-- users 表
CREATE TABLE users (
    id                      VARCHAR(36) PRIMARY KEY,
    username                VARCHAR(100) UNIQUE,
    email                   VARCHAR(255) UNIQUE,
    password_hash           VARCHAR(255),
    avatar                  VARCHAR(500),
    tenant_id               INTEGER REFERENCES tenants(id) ON DELETE SET NULL,
    is_active               BOOLEAN DEFAULT true,
    can_access_all_tenants  BOOLEAN DEFAULT false,
    created_at              TIMESTAMPTZ,
    updated_at              TIMESTAMPTZ,
    deleted_at              TIMESTAMPTZ
);

-- custom_agents 表（注意：已有 created_by 字段）
CREATE TABLE custom_agents (
    id          VARCHAR(36),
    tenant_id   BIGINT,
    name        VARCHAR(255),
    description TEXT,
    avatar      VARCHAR(64),
    is_builtin  BOOLEAN DEFAULT false,
    created_by  VARCHAR(36),       -- 创建者 ID（已存在）
    config      JSONB,
    created_at  TIMESTAMPTZ,
    updated_at  TIMESTAMPTZ,
    deleted_at  TIMESTAMPTZ,
    PRIMARY KEY (id, tenant_id)
);
```

> **注意**：当前 `users` 表没有 `phone`、`position`、`employee_no` 字段。  
> `knowledge_bases` 表没有 `created_by`、`visibility`、`department_id` 字段。  
> 系统没有 `departments`、`roles`、`user_roles`、`user_departments`、`kb_permissions` 表。

---

## 2. 权限模型设计（已实现）

### 2.1 整体权限架构

采用 **租户隔离 + Organization 共享空间** 模型：

```
┌─────────────────────────────────────────────────────────────────┐
│                       租户（Tenant）                             │
│    所有数据以 tenant_id 为边界，租户间完全隔离                      │
│                                                                  │
│  ┌─────────────┐    ┌──────────────────┐    ┌────────────────┐  │
│  │  知识库      │    │   智能体          │    │    会话        │  │
│  │ KnowledgeBase│    │  CustomAgent     │    │   Session      │  │
│  └──────┬──────┘    └────────┬─────────┘    └────────────────┘  │
│         │                    │                                   │
│         ▼                    ▼                                   │
│  ┌─────────────┐    ┌──────────────────┐                        │
│  │ KB 共享      │    │  Agent 共享      │                        │
│  │ kb_shares   │    │ agent_shares     │                        │
│  └──────┬──────┘    └────────┬─────────┘                        │
│         │                    │                                   │
│         └────────┬───────────┘                                   │
│                  ▼                                                │
│         ┌──────────────┐                                         │
│         │  Organization │  ← 共享空间（可跨租户）                  │
│         │  (共享空间)    │                                         │
│         └──────┬───────┘                                         │
│                │                                                  │
│         ┌──────┴──────────┐                                      │
│         │ OrgMembers       │                                      │
│         │ admin/editor/    │                                      │
│         │ viewer           │                                      │
│         └─────────────────┘                                      │
└─────────────────────────────────────────────────────────────────┘

跨租户访问（CanAccessAllTenants 用户通过 X-Tenant-ID header 切换）
```

**核心设计原则**：
1. **租户隔离**：所有业务数据（知识库、Agent、会话等）通过 `tenant_id` 隔离
2. **组织协作**：通过 Organization 实现跨用户/跨租户的资源共享
3. **三级角色**：组织内 `admin`（管理）/ `editor`（编辑）/ `viewer`（查看）
4. **资源共享**：知识库和 Agent 可通过组织共享，每个共享有独立权限级别
5. **邀请机制**：支持邀请码加入 + 搜索发现 + 审批流程

### 2.2 组织角色定义

| 角色标识 | 角色名称 | 权限范围 |
|----------|----------|----------|
| `admin` | 管理员 | 管理组织设置、邀请/移除成员、审批申请、设置成员角色、共享/取消共享资源、删除组织（仅 owner） |
| `editor` | 编辑者 | 共享知识库/Agent 到组织、查看组织信息和成员、使用共享资源 |
| `viewer` | 查看者 | 查看组织信息、使用共享的知识库和 Agent |

**角色权限等级**（代码中 `HasPermission` 方法）：

```go
// internal/types/organization.go
func (r OrgMemberRole) HasPermission(required OrgMemberRole) bool {
    levelMap := map[OrgMemberRole]int{
        OrgRoleViewer: 1,
        OrgRoleEditor: 2,
        OrgRoleAdmin:  3,
    }
    return levelMap[r] >= levelMap[required]
}
```

**操作权限矩阵**：

| 操作 | admin | editor | viewer |
|------|-------|--------|--------|
| 查看组织信息 | ✅ | ✅ | ✅ |
| 查看成员列表 | ✅ | ✅ | ✅ |
| 使用共享的知识库 | ✅ | ✅ | ✅ |
| 使用共享的 Agent | ✅ | ✅ | ✅ |
| 共享知识库到组织 | ✅ | ✅ | ❌ |
| 共享 Agent 到组织 | ✅ | ✅ | ❌ |
| 更新共享权限 | ✅ | ❌ | ❌ |
| 取消共享 | ✅ | ❌ | ❌ |
| 修改组织设置 | ✅ | ❌ | ❌ |
| 邀请/移除成员 | ✅ | ❌ | ❌ |
| 修改成员角色 | ✅ | ❌ | ❌ |
| 审批加入申请 | ✅ | ❌ | ❌ |
| 生成邀请码 | ✅ | ❌ | ❌ |
| 删除组织 | ✅（仅 owner） | ❌ | ❌ |

### 2.3 知识库共享权限模型

知识库通过 `kb_shares` 表共享到组织：

```
知识库（租户A）──共享──→ Organization ──成员──→ 用户（任意租户）
```

**共享权限级别**（复用 `OrgMemberRole`）：

| 级别 | 标识 | 说明 |
|------|------|------|
| 查看 | `viewer` | 查看知识库内容、搜索知识（默认） |
| 编辑 | `editor` | 查看 + 上传文档、编辑内容 |
| 管理 | `admin` | 编辑 + 管理知识库配置 |

**知识库访问判定逻辑**：

```
用户可访问知识库 =
    知识库属于用户当前租户（tenant_id 匹配）
    OR 知识库通过某个组织共享给用户（用户是该组织的成员）
```

### 2.4 Agent 共享权限模型

Agent 通过 `agent_shares` 表共享到组织：

```
Agent（租户A）──共享──→ Organization ──成员──→ 用户（任意租户）
```

- 共享 Agent 可被目标租户「禁用」（`tenant_disabled_shared_agents` 表）
- 共享 Agent 可携带其关联的知识库（通过 Agent 配置中的 KBSelectionMode）

---

## 3. 数据库设计（已实现）

### 3.1 组织相关表结构

#### 3.1.1 `organizations` —— 组织（共享空间）表

```sql
CREATE TABLE organizations (
    id                          VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid()::text,
    name                        VARCHAR(255) NOT NULL,
    description                 TEXT DEFAULT '',
    avatar                      VARCHAR(500) DEFAULT '',
    owner_id                    VARCHAR(36) NOT NULL,
    invite_code                 VARCHAR(64),
    invite_code_expires_at      TIMESTAMPTZ,
    invite_code_validity_days   INTEGER DEFAULT 7,
    require_approval            BOOLEAN DEFAULT false,
    searchable                  BOOLEAN DEFAULT false,
    member_limit                INTEGER DEFAULT 50,
    created_at                  TIMESTAMPTZ DEFAULT NOW(),
    updated_at                  TIMESTAMPTZ DEFAULT NOW(),
    deleted_at                  TIMESTAMPTZ
);

CREATE UNIQUE INDEX idx_organizations_invite_code
    ON organizations(invite_code)
    WHERE invite_code IS NOT NULL AND deleted_at IS NULL;
CREATE INDEX idx_organizations_owner_id ON organizations(owner_id);
CREATE INDEX idx_organizations_deleted_at ON organizations(deleted_at);
```

#### 3.1.2 `organization_members` —— 组织成员表

```sql
CREATE TABLE organization_members (
    id              VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid()::text,
    organization_id VARCHAR(36) NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    user_id         VARCHAR(36) NOT NULL,
    tenant_id       INTEGER,
    role            VARCHAR(20) NOT NULL DEFAULT 'viewer',   -- 'admin' / 'editor' / 'viewer'
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_org_members_unique ON organization_members(organization_id, user_id);
CREATE INDEX idx_org_members_user_id ON organization_members(user_id);
CREATE INDEX idx_org_members_org_id ON organization_members(organization_id);
```

#### 3.1.3 `kb_shares` —— 知识库共享表

```sql
CREATE TABLE kb_shares (
    id                  VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid()::text,
    knowledge_base_id   VARCHAR(36) NOT NULL REFERENCES knowledge_bases(id) ON DELETE CASCADE,
    organization_id     VARCHAR(36) NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    shared_by_user_id   VARCHAR(36) NOT NULL,
    source_tenant_id    INTEGER NOT NULL,
    permission          VARCHAR(20) NOT NULL DEFAULT 'viewer',
    created_at          TIMESTAMPTZ DEFAULT NOW(),
    updated_at          TIMESTAMPTZ DEFAULT NOW(),
    deleted_at          TIMESTAMPTZ
);

CREATE UNIQUE INDEX idx_kb_shares_unique
    ON kb_shares(knowledge_base_id, organization_id)
    WHERE deleted_at IS NULL;
CREATE INDEX idx_kb_shares_org_id ON kb_shares(organization_id);
CREATE INDEX idx_kb_shares_kb_id ON kb_shares(knowledge_base_id);
```

#### 3.1.4 `organization_join_requests` —— 加入/升级申请表

```sql
CREATE TABLE organization_join_requests (
    id              VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid()::text,
    organization_id VARCHAR(36) NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    user_id         VARCHAR(36) NOT NULL,
    tenant_id       INTEGER,
    status          VARCHAR(20) DEFAULT 'pending',       -- 'pending' / 'approved' / 'rejected'
    requested_role  VARCHAR(20) DEFAULT 'viewer',
    request_type    VARCHAR(20) DEFAULT 'join',          -- 'join' / 'upgrade'
    prev_role       VARCHAR(20) DEFAULT '',
    message         TEXT DEFAULT '',
    reviewed_by     VARCHAR(36),
    reviewed_at     TIMESTAMPTZ,
    review_message  TEXT DEFAULT '',
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    updated_at      TIMESTAMPTZ DEFAULT NOW()
);

CREATE UNIQUE INDEX idx_join_requests_pending
    ON organization_join_requests(organization_id, user_id)
    WHERE status = 'pending';
CREATE INDEX idx_join_requests_org_id ON organization_join_requests(organization_id);
CREATE INDEX idx_join_requests_user_id ON organization_join_requests(user_id);
```

#### 3.1.5 `agent_shares` —— Agent 共享表

```sql
CREATE TABLE agent_shares (
    id                  VARCHAR(36) PRIMARY KEY DEFAULT gen_random_uuid()::text,
    agent_id            VARCHAR(36) NOT NULL,
    organization_id     VARCHAR(36) NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    shared_by_user_id   VARCHAR(36) NOT NULL,
    source_tenant_id    INTEGER NOT NULL,
    permission          VARCHAR(20) NOT NULL DEFAULT 'viewer',
    created_at          TIMESTAMPTZ DEFAULT NOW(),
    updated_at          TIMESTAMPTZ DEFAULT NOW(),
    deleted_at          TIMESTAMPTZ,
    FOREIGN KEY (agent_id, source_tenant_id) REFERENCES custom_agents(id, tenant_id)
);

CREATE UNIQUE INDEX idx_agent_shares_unique
    ON agent_shares(agent_id, source_tenant_id, organization_id)
    WHERE deleted_at IS NULL;
CREATE INDEX idx_agent_shares_org_id ON agent_shares(organization_id);
CREATE INDEX idx_agent_shares_agent_id ON agent_shares(agent_id);
```

#### 3.1.6 `tenant_disabled_shared_agents` —— 租户禁用的共享 Agent

```sql
CREATE TABLE tenant_disabled_shared_agents (
    tenant_id       BIGINT NOT NULL,
    agent_id        VARCHAR(36) NOT NULL,
    source_tenant_id BIGINT NOT NULL,
    created_at      TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (tenant_id, agent_id, source_tenant_id)
);
```

### 3.2 数据库迁移脚本

迁移文件：`migrations/versioned/000012_organizations.up.sql`

该迁移创建了上述 6 张表（organizations, organization_members, kb_shares, organization_join_requests, agent_shares, tenant_disabled_shared_agents）。

回滚文件：`migrations/versioned/000012_organizations.down.sql`

### 3.3 ER 关系图

```
┌─────────────┐     1:N     ┌─────────────────────┐
│   tenants   │────────────→│       users          │
│  id (PK)    │             │  id (PK)             │
│  name       │             │  username            │
│  api_key    │             │  email               │
│             │             │  tenant_id (FK)      │
│             │             │  can_access_all_...  │
└──────┬──────┘             └──────────┬───────────┘
       │                               │
       │     1:N                       │ owner_id / user_id
       ├───────────→┌─────────────────────────────────┐
       │            │       organizations              │
       │            │  id (PK)                         │
       │            │  name                            │
       │            │  owner_id → users.id             │
       │            │  invite_code                     │
       │            │  require_approval                │
       │            │  searchable                      │
       │            │  member_limit                    │
       │            └──────────┬──────────────────────-┘
       │                       │
       │              ┌────────┴─────────┐
       │              │ organization_    │
       │              │ members          │
       │              │  organization_id │──→ organizations.id
       │              │  user_id         │──→ users.id
       │              │  tenant_id       │
       │              │  role            │──→ 'admin'/'editor'/'viewer'
       │              └──────────────────┘
       │
       │     1:N     ┌─────────────────┐          ┌──────────────────┐
       ├────────────→│ knowledge_bases  │   1:N    │    kb_shares     │
       │             │  id (PK)        │─────────→│  kb_id (FK)      │
       │             │  tenant_id      │          │  organization_id │──→ organizations.id
       │             │  name           │          │  shared_by_user_id│
       │             │  type           │          │  source_tenant_id│
       │             └─────────────────┘          │  permission      │──→ 'viewer'/'editor'/'admin'
       │                                          └──────────────────┘
       │
       │     1:N     ┌─────────────────┐          ┌──────────────────┐
       ├────────────→│ custom_agents    │   1:N    │  agent_shares    │
       │             │  id (复合PK)     │─────────→│  agent_id (FK)   │
       │             │  tenant_id (PK) │          │  organization_id │──→ organizations.id
       │             │  name           │          │  shared_by_user_id│
       │             │  created_by     │          │  source_tenant_id│
       │             │  config (JSONB) │          │  permission      │
       │             └─────────────────┘          └──────────────────┘
       │
       │              ┌─────────────────────────────────┐
       │              │ organization_join_requests       │
       │              │  organization_id → organizations │
       │              │  user_id → users                 │
       │              │  request_type: 'join'/'upgrade'  │
       │              │  status: 'pending'/'approved'/   │
       │              │          'rejected'              │
       │              └─────────────────────────────────┘
       │
       │              ┌─────────────────────────────────┐
       │              │ tenant_disabled_shared_agents    │
       │              │  (tenant_id, agent_id,           │
       │              │   source_tenant_id) PK           │
       │              └─────────────────────────────────┘
```

---

## 4. 后端 API 设计（已实现）

### 4.1 组织管理 API

> 前缀：`/api/v1/organizations`

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| `POST` | `/organizations` | 创建组织 | 所有登录用户 |
| `GET` | `/organizations` | 我的组织列表 | 所有登录用户 |
| `GET` | `/organizations/search` | 搜索可发现的组织 | 所有登录用户 |
| `GET` | `/organizations/preview/:code` | 通过邀请码预览组织 | 所有登录用户 |
| `GET` | `/organizations/:id` | 组织详情 | 组织成员 |
| `PUT` | `/organizations/:id` | 更新组织设置 | admin |
| `DELETE` | `/organizations/:id` | 删除组织 | owner |
| `POST` | `/organizations/:id/invite-code` | 生成/刷新邀请码 | admin |
| `POST` | `/organizations/join` | 通过邀请码加入 | 所有登录用户 |
| `POST` | `/organizations/join-by-id` | 通过组织 ID 加入 | 所有登录用户 |
| `POST` | `/organizations/:id/leave` | 离开组织 | 组织成员 |
| `GET` | `/organizations/:id/search-users` | 搜索可邀请的用户 | admin |
| `POST` | `/organizations/:id/invite` | 邀请用户加入 | admin |
| `POST` | `/organizations/:id/request-upgrade` | 申请角色升级 | 组织成员 |

**请求/响应结构**：

```json
// POST /organizations（创建组织）
{
    "name": "技术交流空间",
    "description": "内部技术知识共享",
    "avatar": "",
    "invite_code_validity_days": 7,
    "member_limit": 200
}

// GET /organizations（组织列表响应）
[
    {
        "id": "uuid-xxx",
        "name": "技术交流空间",
        "description": "...",
        "owner_id": "uuid-user1",
        "invite_code": "a1b2c3d4e5f6g7h8",
        "require_approval": false,
        "searchable": true,
        "member_limit": 200,
        "member_count": 15,
        "share_count": 8,
        "agent_share_count": 3,
        "pending_join_request_count": 2,
        "is_owner": true,
        "my_role": "admin",
        "has_pending_upgrade": false,
        "resource_counts": { ... }
    }
]

// PUT /organizations/:id（更新组织）
{
    "name": "新名称",
    "description": "新描述",
    "require_approval": true,
    "searchable": true,
    "invite_code_validity_days": 30,
    "member_limit": 500
}
```

### 4.2 成员管理 API

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| `GET` | `/organizations/:id/members` | 成员列表 | 组织成员 |
| `PUT` | `/organizations/:id/members/:user_id` | 修改成员角色 | admin |
| `DELETE` | `/organizations/:id/members/:user_id` | 移除成员 | admin（自我移除=离开） |

```json
// PUT /organizations/:id/members/:user_id
{
    "role": "editor"    // "admin" / "editor" / "viewer"
}
```

### 4.3 加入申请 API

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| `POST` | `/organizations/join-request` | 提交加入申请 | 所有登录用户 |
| `GET` | `/organizations/:id/join-requests` | 申请列表 | admin |
| `PUT` | `/organizations/:id/join-requests/:request_id/review` | 审批申请 | admin |

```json
// POST /organizations/join-request
{
    "invite_code": "a1b2c3d4e5f6g7h8",
    "message": "希望加入学习",
    "role": "viewer"
}

// PUT /organizations/:id/join-requests/:request_id/review
{
    "approved": true,
    "message": "欢迎加入",
    "role": "viewer"           // admin 可 override 角色
}
```

### 4.4 知识库共享 API

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| `POST` | `/knowledge-bases/:id/shares` | 共享知识库到组织 | editor+ |
| `GET` | `/knowledge-bases/:id/shares` | 该知识库的共享列表 | 所有登录用户 |
| `PUT` | `/knowledge-bases/:id/shares/:share_id` | 更新共享权限 | admin |
| `DELETE` | `/knowledge-bases/:id/shares/:share_id` | 取消共享 | admin |
| `GET` | `/shared-knowledge-bases` | 我可访问的所有共享知识库 | 所有登录用户 |
| `GET` | `/organizations/:id/shares` | 组织内共享的知识库列表 | 组织成员 |
| `GET` | `/organizations/:id/shared-knowledge-bases` | 组织共享的知识库详情（含 Agent 携带的 KB） | 组织成员 |

```json
// POST /knowledge-bases/:id/shares
{
    "organization_id": "uuid-org1",
    "permission": "viewer"      // "viewer" / "editor" / "admin"
}

// PUT /knowledge-bases/:id/shares/:share_id
{
    "permission": "editor"
}
```

### 4.5 Agent 共享 API

| 方法 | 路径 | 描述 | 权限 |
|------|------|------|------|
| `POST` | `/agents/:id/shares` | 共享 Agent 到组织 | editor+ |
| `GET` | `/agents/:id/shares` | Agent 的共享列表 | 所有登录用户 |
| `DELETE` | `/agents/:id/shares/:share_id` | 取消 Agent 共享 | admin |
| `GET` | `/shared-agents` | 我可访问的所有共享 Agent | 所有登录用户 |
| `GET` | `/organizations/:id/agent-shares` | 组织内 Agent 共享列表 | 组织成员 |
| `GET` | `/organizations/:id/shared-agents` | 组织共享的 Agent 详情 | 组织成员 |
| `POST` | `/shared-agents/disabled` | 禁用/启用共享 Agent | 所有登录用户 |

### 4.6 认证 API

> 前缀：`/api/v1/auth`

| 方法 | 路径 | 描述 | 认证要求 |
|------|------|------|----------|
| `POST` | `/auth/register` | 用户注册 | 无需认证 |
| `POST` | `/auth/login` | 用户登录 | 无需认证 |
| `POST` | `/auth/refresh` | 刷新 Token | 无需认证 |
| `GET` | `/auth/validate` | 验证 Token | 需认证 |
| `POST` | `/auth/logout` | 注销 | 需认证 |
| `GET` | `/auth/me` | 获取当前用户信息 | 需认证 |
| `POST` | `/auth/change-password` | 修改密码 | 需认证 |

**`/auth/me` 响应结构**：

```json
{
    "success": true,
    "data": {
        "user": {
            "id": "uuid-xxx",
            "username": "zhangsan",
            "email": "zhang@example.com",
            "avatar": "...",
            "tenant_id": 1,
            "is_active": true,
            "can_access_all_tenants": false,
            "created_at": "2026-01-01T00:00:00Z",
            "updated_at": "2026-01-01T00:00:00Z"
        },
        "tenant": {
            "id": 1,
            "name": "默认租户",
            "api_key": "..."
        }
    }
}
```

> **注意**：`/auth/me` 当前不返回角色（roles）、权限（permissions）或部门（departments）信息。

---

## 5. 后端实现方案（已实现）

### 5.1 Go 类型定义

#### 5.1.1 `internal/types/organization.go` —— 组织相关模型

```go
package types

// 组织成员角色
type OrgMemberRole string

const (
    OrgRoleAdmin  OrgMemberRole = "admin"
    OrgRoleEditor OrgMemberRole = "editor"
    OrgRoleViewer OrgMemberRole = "viewer"
)

// 权限等级判定
func (r OrgMemberRole) HasPermission(required OrgMemberRole) bool {
    levelMap := map[OrgMemberRole]int{OrgRoleViewer: 1, OrgRoleEditor: 2, OrgRoleAdmin: 3}
    return levelMap[r] >= levelMap[required]
}

// 加入申请状态
type JoinRequestStatus string
const (
    JoinRequestStatusPending  JoinRequestStatus = "pending"
    JoinRequestStatusApproved JoinRequestStatus = "approved"
    JoinRequestStatusRejected JoinRequestStatus = "rejected"
)

// 加入申请类型
type JoinRequestType string
const (
    JoinRequestTypeJoin    JoinRequestType = "join"
    JoinRequestTypeUpgrade JoinRequestType = "upgrade"
)

// Organization 组织模型
type Organization struct {
    ID                      string     `json:"id" gorm:"primaryKey;type:varchar(36)"`
    Name                    string     `json:"name" gorm:"type:varchar(255);not null"`
    Description             string     `json:"description" gorm:"type:text"`
    Avatar                  string     `json:"avatar" gorm:"type:varchar(500)"`
    OwnerID                 string     `json:"owner_id" gorm:"type:varchar(36);not null"`
    InviteCode              string     `json:"invite_code" gorm:"type:varchar(64)"`
    InviteCodeExpiresAt     *time.Time `json:"invite_code_expires_at"`
    InviteCodeValidityDays  int        `json:"invite_code_validity_days" gorm:"default:7"`
    RequireApproval         bool       `json:"require_approval" gorm:"default:false"`
    Searchable              bool       `json:"searchable" gorm:"default:false"`
    MemberLimit             int        `json:"member_limit" gorm:"default:50"`
    CreatedAt               time.Time  `json:"created_at"`
    UpdatedAt               time.Time  `json:"updated_at"`
    DeletedAt               *time.Time `json:"deleted_at,omitempty" gorm:"index"`
    // 关联
    Owner   *User                `json:"owner,omitempty" gorm:"foreignKey:OwnerID"`
    Members []OrganizationMember `json:"members,omitempty" gorm:"foreignKey:OrganizationID"`
    Shares  []KnowledgeBaseShare `json:"shares,omitempty" gorm:"foreignKey:OrganizationID"`
}

// OrganizationMember 组织成员
type OrganizationMember struct {
    ID             string        `json:"id" gorm:"primaryKey;type:varchar(36)"`
    OrganizationID string        `json:"organization_id" gorm:"type:varchar(36);not null"`
    UserID         string        `json:"user_id" gorm:"type:varchar(36);not null"`
    TenantID       uint64        `json:"tenant_id"`
    Role           OrgMemberRole `json:"role" gorm:"type:varchar(20);default:'viewer'"`
    CreatedAt      time.Time     `json:"created_at"`
    UpdatedAt      time.Time     `json:"updated_at"`
}

// KnowledgeBaseShare 知识库共享
type KnowledgeBaseShare struct {
    ID              string        `json:"id" gorm:"primaryKey;type:varchar(36)"`
    KnowledgeBaseID string        `json:"knowledge_base_id" gorm:"type:varchar(36);not null"`
    OrganizationID  string        `json:"organization_id" gorm:"type:varchar(36);not null"`
    SharedByUserID  string        `json:"shared_by_user_id" gorm:"type:varchar(36);not null"`
    SourceTenantID  uint64        `json:"source_tenant_id" gorm:"not null"`
    Permission      OrgMemberRole `json:"permission" gorm:"type:varchar(20);default:'viewer'"`
    CreatedAt       time.Time     `json:"created_at"`
    UpdatedAt       time.Time     `json:"updated_at"`
    DeletedAt       *time.Time    `json:"deleted_at,omitempty"`
}

// AgentShare Agent 共享
type AgentShare struct {
    ID              string        `json:"id" gorm:"primaryKey;type:varchar(36)"`
    AgentID         string        `json:"agent_id" gorm:"type:varchar(36);not null"`
    OrganizationID  string        `json:"organization_id" gorm:"type:varchar(36);not null"`
    SharedByUserID  string        `json:"shared_by_user_id" gorm:"type:varchar(36);not null"`
    SourceTenantID  uint64        `json:"source_tenant_id" gorm:"not null"`
    Permission      OrgMemberRole `json:"permission" gorm:"type:varchar(20);default:'viewer'"`
    CreatedAt       time.Time     `json:"created_at"`
    UpdatedAt       time.Time     `json:"updated_at"`
    DeletedAt       *time.Time    `json:"deleted_at,omitempty"`
}

// OrganizationJoinRequest 加入申请
type OrganizationJoinRequest struct {
    ID              string            `json:"id" gorm:"primaryKey;type:varchar(36)"`
    OrganizationID  string            `json:"organization_id"`
    UserID          string            `json:"user_id"`
    TenantID        uint64            `json:"tenant_id"`
    RequestType     JoinRequestType   `json:"request_type" gorm:"default:'join'"`
    PrevRole        OrgMemberRole     `json:"prev_role"`
    RequestedRole   OrgMemberRole     `json:"requested_role" gorm:"default:'viewer'"`
    Status          JoinRequestStatus `json:"status" gorm:"default:'pending'"`
    Message         string            `json:"message"`
    ReviewedBy      string            `json:"reviewed_by"`
    ReviewedAt      *time.Time        `json:"reviewed_at"`
    ReviewMessage   string            `json:"review_message"`
    CreatedAt       time.Time         `json:"created_at"`
    UpdatedAt       time.Time         `json:"updated_at"`
}

// TenantDisabledSharedAgent 租户禁用的共享 Agent
type TenantDisabledSharedAgent struct {
    TenantID       uint64    `json:"tenant_id" gorm:"primaryKey"`
    AgentID        string    `json:"agent_id" gorm:"primaryKey;type:varchar(36)"`
    SourceTenantID uint64    `json:"source_tenant_id" gorm:"primaryKey"`
    CreatedAt      time.Time `json:"created_at"`
}
```

> **完整请求/响应类型**：文件中还定义了 20+ 个 Request/Response 结构体（CreateOrganizationRequest、UpdateOrganizationRequest、OrganizationResponse、JoinByOrganizationIDRequest 等），详见源码。

#### 5.1.2 `internal/types/user.go` —— 用户模型

```go
type User struct {
    ID                  string     `json:"id" gorm:"primaryKey;type:varchar(36)"`
    Username            string     `json:"username" gorm:"uniqueIndex;type:varchar(100)"`
    Email               string     `json:"email" gorm:"uniqueIndex;type:varchar(255)"`
    PasswordHash        string     `json:"-" gorm:"type:varchar(255)"`
    Avatar              string     `json:"avatar" gorm:"type:varchar(500)"`
    TenantID            uint64     `json:"tenant_id" gorm:"index"`
    IsActive            bool       `json:"is_active" gorm:"default:true"`
    CanAccessAllTenants bool       `json:"can_access_all_tenants" gorm:"default:false"`
    CreatedAt           time.Time  `json:"created_at"`
    UpdatedAt           time.Time  `json:"updated_at"`
    DeletedAt           *time.Time `json:"deleted_at,omitempty" gorm:"index"`
    Tenant              *Tenant    `json:"tenant,omitempty" gorm:"foreignKey:TenantID"`
}

type UserInfo struct {
    ID                  string    `json:"id"`
    Username            string    `json:"username"`
    Email               string    `json:"email"`
    Avatar              string    `json:"avatar"`
    TenantID            uint64    `json:"tenant_id"`
    IsActive            bool      `json:"is_active"`
    CanAccessAllTenants bool      `json:"can_access_all_tenants"`
    CreatedAt           time.Time `json:"created_at"`
    UpdatedAt           time.Time `json:"updated_at"`
}

type LoginResponse struct {
    Success      bool    `json:"success"`
    Message      string  `json:"message,omitempty"`
    User         *User   `json:"user,omitempty"`
    Tenant       *Tenant `json:"tenant,omitempty"`
    Token        string  `json:"token,omitempty"`
    RefreshToken string  `json:"refresh_token,omitempty"`
}
```

> **注意**：`User` 结构体当前没有 `Phone`、`Position`、`EmployeeNo` 字段。`UserInfo` 没有 `RoleCodes`、`IsAdmin` 字段。

#### 5.1.3 `internal/types/knowledgebase.go` —— 知识库模型

```go
type KnowledgeBase struct {
    ID                        string     `json:"id" gorm:"primaryKey;type:varchar(36)"`
    Name                      string     `json:"name" gorm:"type:varchar(255)"`
    Type                      string     `json:"type" gorm:"type:varchar(50);default:'document'"`
    IsTemporary               bool       `json:"is_temporary" gorm:"default:false"`
    Description               string     `json:"description" gorm:"type:text"`
    TenantID                  uint64     `json:"tenant_id" gorm:"index"`
    ChunkingConfig            ChunkingConfig            `json:"chunking_config" gorm:"type:jsonb"`
    ImageProcessingConfig     ImageProcessingConfig     `json:"image_processing_config" gorm:"type:jsonb"`
    EmbeddingModelID          string                    `json:"embedding_model_id"`
    SummaryModelID            string                    `json:"summary_model_id"`
    VLMConfig                 VLMConfig                 `json:"vlm_config" gorm:"type:jsonb"`
    StorageConfig             StorageConfig             `json:"storage_config" gorm:"type:jsonb;column:cos_config"`
    ExtractConfig             ExtractConfig             `json:"extract_config" gorm:"type:jsonb"`
    FAQConfig                 FAQConfig                 `json:"faq_config" gorm:"type:jsonb"`
    QuestionGenerationConfig  QuestionGenerationConfig  `json:"question_generation_config" gorm:"type:jsonb"`
    CreatedAt                 time.Time                 `json:"created_at"`
    UpdatedAt                 time.Time                 `json:"updated_at"`
    DeletedAt                 *time.Time                `json:"deleted_at,omitempty" gorm:"index"`
    // 计算字段（非数据库列）
    KnowledgeCount  int64 `json:"knowledge_count" gorm:"-"`
    ChunkCount      int64 `json:"chunk_count" gorm:"-"`
    IsProcessing    bool  `json:"is_processing" gorm:"-"`
    ProcessingCount int64 `json:"processing_count" gorm:"-"`
    ShareCount      int64 `json:"share_count" gorm:"-"`
}
```

> **注意**：`KnowledgeBase` 结构体当前没有 `CreatedBy`、`Visibility`、`DepartmentID` 字段。知识库权限通过 `TenantID` 隔离 + `kb_shares` 组织级共享实现。

#### 5.1.4 `internal/types/custom_agent.go` —— Agent 模型

```go
type CustomAgent struct {
    ID          string            `json:"id" gorm:"primaryKey;type:varchar(36)"`
    Name        string            `json:"name" gorm:"type:varchar(255)"`
    Description string            `json:"description" gorm:"type:text"`
    Avatar      string            `json:"avatar" gorm:"type:varchar(64)"`
    IsBuiltin   bool              `json:"is_builtin" gorm:"default:false"`
    TenantID    uint64            `json:"tenant_id" gorm:"primaryKey"`
    CreatedBy   string            `json:"created_by" gorm:"type:varchar(36)"`   // ← 已存在
    Config      CustomAgentConfig `json:"config" gorm:"type:jsonb"`
    CreatedAt   time.Time         `json:"created_at"`
    UpdatedAt   time.Time         `json:"updated_at"`
    DeletedAt   *time.Time        `json:"deleted_at,omitempty" gorm:"index"`
}
```

> **注意**：`CustomAgent` 已有 `CreatedBy` 字段。内置 Agent ID：`builtin-quick-answer`、`builtin-smart-reasoning`、`builtin-deep-researcher`、`builtin-data-analyst`、`builtin-knowledge-graph-expert`、`builtin-document-assistant`。

### 5.2 Repository 层

#### 5.2.1 接口定义

组织相关接口定义于 `internal/types/interfaces/organization.go`：

| 接口 | 关键方法 |
|------|----------|
| `OrganizationRepository` | Create, GetByID, GetByInviteCode, ListByUserID, ListSearchable, Update, Delete, AddMember, RemoveMember, UpdateMemberRole, ListMembers, GetMember, ListMembersByUserForOrgs, CountMembers, UpdateInviteCode, CreateJoinRequest, GetJoinRequestByID, GetPendingJoinRequest, GetPendingRequestByType, ListJoinRequests, CountJoinRequests, UpdateJoinRequestStatus |
| `OrganizationService` | CreateOrganization, GetOrganization, GetOrganizationByInviteCode, ListUserOrganizations, UpdateOrganization, DeleteOrganization, AddMember, RemoveMember, UpdateMemberRole, ListMembers, GetMember, GenerateInviteCode, JoinByInviteCode, JoinByOrganizationID, SearchSearchableOrganizations, SubmitJoinRequest, ListJoinRequests, CountPendingJoinRequests, ReviewJoinRequest, RequestRoleUpgrade, GetPendingUpgradeRequest, IsOrgAdmin, GetUserRoleInOrg |
| `KBShareRepository` | Create, GetByID, GetByKBAndOrg, Update, Delete, DeleteByKnowledgeBaseID, DeleteByOrganizationID, ListByKnowledgeBase, ListByOrganization, ListByOrganizations, ListSharedKBsForUser, CountSharesByKnowledgeBaseID/IDs, CountByOrganizations |
| `KBShareService` | ShareKnowledgeBase, UpdateSharePermission, RemoveShare, ListSharesByKnowledgeBase, ListSharesByOrganization, ListSharedKnowledgeBases, ListSharedKnowledgeBasesInOrganization, ListSharedKnowledgeBaseIDsByOrganizations, GetShare, GetShareByKBAndOrg, CheckUserKBPermission, HasKBPermission, GetKBSourceTenant, CountSharesByKnowledgeBaseIDs, CountByOrganizations |
| `AgentShareService` | ShareAgent, RemoveShare, ListSharesByAgent, ListSharesByOrganization, ListSharedAgents, ListSharedAgentsInOrganization, ListSharedAgentsInOrganizations, SetSharedAgentDisabledByMe, GetSharedAgentForUser, UserCanAccessKBViaSomeSharedAgent, GetShare, GetShareByAgentAndOrg, GetShareByAgentIDForUser, CountByOrganizations |
| `AgentShareRepository` | Create, GetByID, GetByAgentAndOrg, Update, Delete, DeleteByAgentIDAndSourceTenant, DeleteByOrganizationID, ListByAgent, ListByOrganization, ListByOrganizations, ListSharedAgentsForUser, CountByOrganizations, GetShareByAgentIDForUser |
| `TenantDisabledSharedAgentRepository` | ListByTenantID, ListDisabledOwnAgentIDs, Add, Remove |

#### 5.2.2 Repository 实现文件

| 文件 | 功能 |
|------|------|
| `internal/application/repository/organization.go` | 组织 CRUD、成员管理、加入申请管理 |
| `internal/application/repository/kbshare.go` | 知识库共享 CRUD、权限查询 |
| `internal/application/repository/agent_share.go` | Agent 共享 CRUD |
| `internal/application/repository/tenant_disabled_shared_agent.go` | 租户禁用共享 Agent |

### 5.3 Service 层

#### 5.3.1 Service 实现文件

| 文件 | 功能 |
|------|------|
| `internal/application/service/organization.go` | 组织业务逻辑（创建、加入、审批、角色管理） |
| `internal/application/service/kbshare.go` | 知识库共享业务逻辑 |
| `internal/application/service/agent_share.go` | Agent 共享业务逻辑 |

**关键业务逻辑 —— 组织创建**：

```go
func (s *organizationService) CreateOrganization(userID string, tenantID uint64, req *types.CreateOrganizationRequest) (*types.Organization, error) {
    org := &types.Organization{
        ID:          uuid.New().String(),
        Name:        req.Name,
        Description: req.Description,
        Avatar:      req.Avatar,
        OwnerID:     userID,
        InviteCode:  generateInviteCode(),  // 16 字符 hex
        MemberLimit: DefaultMemberLimit,     // 200
        // ...
    }
    // 创建组织
    if err := s.orgRepo.Create(org); err != nil { return nil, err }
    // 创建者自动成为 admin
    s.orgRepo.AddMember(&types.OrganizationMember{
        OrganizationID: org.ID,
        UserID:         userID,
        TenantID:       tenantID,
        Role:           types.OrgRoleAdmin,
    })
    return org, nil
}
```

**关键业务逻辑 —— 删除组织时级联清理**：

```go
func (s *organizationService) DeleteOrganization(orgID, userID string) error {
    org, _ := s.orgRepo.GetByID(orgID)
    if org.OwnerID != userID { return ErrOrgPermissionDenied }
    // 软删除所有 KB shares 和 Agent shares
    s.shareRepo.DeleteByOrganizationID(orgID)
    s.agentShareRepo.DeleteByOrganizationID(orgID)
    return s.orgRepo.Delete(orgID)
}
```

### 5.4 Handler 层

`internal/handler/organization.go`（约 1810 行）实现了所有组织管理端点：

| 方法 | 对应路由 |
|------|----------|
| `CreateOrganization` | POST /organizations |
| `GetOrganization` | GET /organizations/:id |
| `ListMyOrganizations` | GET /organizations |
| `UpdateOrganization` | PUT /organizations/:id |
| `DeleteOrganization` | DELETE /organizations/:id |
| `ListMembers` | GET /organizations/:id/members |
| `UpdateMemberRole` | PUT /organizations/:id/members/:user_id |
| `RemoveMember` | DELETE /organizations/:id/members/:user_id |
| `GenerateInviteCode` | POST /organizations/:id/invite-code |
| `PreviewByInviteCode` | GET /organizations/preview/:code |
| `JoinByInviteCode` | POST /organizations/join |
| `SubmitJoinRequest` | POST /organizations/join-request |
| `SearchOrganizations` | GET /organizations/search |
| `JoinByOrganizationID` | POST /organizations/join-by-id |
| `RequestRoleUpgrade` | POST /organizations/:id/request-upgrade |
| `LeaveOrganization` | POST /organizations/:id/leave |
| `ListJoinRequests` | GET /organizations/:id/join-requests |
| `ReviewJoinRequest` | PUT /organizations/:id/join-requests/:request_id/review |
| `ShareKnowledgeBase` | POST /knowledge-bases/:id/shares |
| `ListKBShares` | GET /knowledge-bases/:id/shares |
| `UpdateSharePermission` | PUT /knowledge-bases/:id/shares/:share_id |
| `RemoveShare` | DELETE /knowledge-bases/:id/shares/:share_id |
| `ListOrgShares` | GET /organizations/:id/shares |
| `ListSharedKnowledgeBases` | GET /shared-knowledge-bases |
| `ShareAgent` | POST /agents/:id/shares |
| `ListAgentShares` | GET /agents/:id/shares |
| `RemoveAgentShare` | DELETE /agents/:id/shares/:share_id |
| `ListOrgAgentShares` | GET /organizations/:id/agent-shares |
| `ListSharedAgents` | GET /shared-agents |
| `ListOrganizationSharedKnowledgeBases` | GET /organizations/:id/shared-knowledge-bases |
| `ListOrganizationSharedAgents` | GET /organizations/:id/shared-agents |
| `SetSharedAgentDisabledByMe` | POST /shared-agents/disabled |
| `SearchUsersForInvite` | GET /organizations/:id/search-users |
| `InviteMember` | POST /organizations/:id/invite |

### 5.5 认证中间件

`internal/middleware/auth.go` 实现了统一认证：

- JWT Bearer Token 认证 + API Key 认证
- 将用户信息注入 Gin context 和 request context
- 支持跨租户切换（`X-Tenant-ID` header）

**当前没有 RBAC 中间件**：系统不存在 `RequireRole`、`RequirePermission` 等中间件。组织级权限检查在 Handler/Service 层内部完成。

### 5.6 路由注册

`internal/router/router.go` 通过 `RouterParams`（dig.In）注入所有依赖：

```go
type RouterParams struct {
    dig.In
    Config                *config.Config
    // ... 所有 Service 接口 ...
    KBHandler             *handler.KnowledgeBaseHandler
    KnowledgeHandler      *handler.KnowledgeHandler
    TenantHandler         *handler.TenantHandler
    // ... 所有 Handler ...
    OrganizationHandler   *handler.OrganizationHandler
}
```

路由注册函数（共 18 个 + Organization 路由）：

```go
func NewRouter(p RouterParams) *gin.Engine {
    r := gin.New()
    // 中间件链
    r.Use(cors.New(...))
    r.Use(middleware.RequestIDMiddleware())
    r.Use(middleware.LoggerMiddleware())
    r.Use(middleware.RecoveryMiddleware())
    r.Use(middleware.ErrorHandler())
    r.GET("/health", ...)
    // Swagger（非 release）
    r.Use(middleware.AuthMiddleware(p.UserService, p.TenantService, p.Config))
    r.Use(middleware.TracingMiddleware(p.Tracer))

    v1 := r.Group("/api/v1")

    RegisterAuthRoutes(v1, p)
    RegisterTenantRoutes(v1, p)
    RegisterKnowledgeBaseRoutes(v1, p)
    RegisterKnowledgeTagRoutes(v1, p)
    RegisterKnowledgeRoutes(v1, p)
    RegisterFAQRoutes(v1, p)
    RegisterChunkRoutes(v1, p)
    RegisterSessionRoutes(v1, p)
    RegisterChatRoutes(v1, p)
    RegisterMessageRoutes(v1, p)
    RegisterModelRoutes(v1, p)
    RegisterEvaluationRoutes(v1, p)
    RegisterInitializationRoutes(v1, p)
    RegisterSystemRoutes(v1, p)
    RegisterMCPServiceRoutes(v1, p)
    RegisterWebSearchRoutes(v1, p)
    RegisterCustomAgentRoutes(v1, p)
    RegisterSkillRoutes(v1, p)
    RegisterOrganizationRoutes(v1, p)

    return r
}
```

> **注意**：所有路由组都在 Auth 中间件之后，但没有额外的角色/权限中间件。权限检查在各 Handler/Service 内部完成。

### 5.7 DI 容器注册

`internal/container/container.go` 的 `BuildContainer` 函数注册了完整的依赖链：

**Repository 层注册**：
```go
container.Provide(repository.NewOrganizationRepository)
container.Provide(repository.NewKBShareRepository)
container.Provide(repository.NewAgentShareRepository)
container.Provide(repository.NewTenantDisabledSharedAgentRepository)
```

**Service 层注册**：
```go
container.Provide(service.NewOrganizationService)
container.Provide(service.NewKBShareService)
container.Provide(service.NewAgentShareService)
```

**Handler 层注册**：
```go
container.Provide(handler.NewOrganizationHandler)
```

> **不存在的注册**：没有 DepartmentRepository/Service/Handler、RoleRepository/Service/Handler、KBPermissionRepository/Service/Handler、MemberService/Handler 的注册。

---

## 6. 前端实现方案（已实现）

### 6.1 状态管理

#### `frontend/src/stores/auth.ts` —— 认证状态

```typescript
export const useAuthStore = defineStore('auth', () => {
  // State
  const user = ref<UserInfo | null>(null)
  const tenant = ref<TenantInfo | null>(null)
  const token = ref<string>('')
  const refreshToken = ref<string>('')
  const knowledgeBases = ref<KnowledgeBaseInfo[]>([])
  const currentKnowledgeBase = ref<KnowledgeBaseInfo | null>(null)
  const selectedTenantId = ref<number | null>(null)
  const selectedTenantName = ref<string | null>(null)
  const allTenants = ref<TenantInfoFromAPI[]>([])

  // Computed
  const isLoggedIn = computed(() => !!token.value && !!user.value)
  const hasValidTenant = computed(() => !!tenant.value && !!tenant.value.api_key)
  const canAccessAllTenants = computed(() => user.value?.can_access_all_tenants ?? false)
  const effectiveTenantId = computed(() => selectedTenantId.value || tenant.value?.id)

  // Actions
  function logout() { /* 清空所有 state + localStorage */ }
  function initFromStorage() { /* 从 localStorage 恢复 */ }
  // ...
})
```

> **注意**：auth store 中没有 `roles`、`permissions`、`isAdmin` 等字段。

#### `frontend/src/stores/organization.ts` —— 组织状态

管理用户的组织列表、待审批请求数等状态。

#### 不存在的 Store

- **`permission.ts`** —— 不存在（无独立权限 Store）
- 权限控制通过 `can_access_all_tenants` 和组织角色在各组件内判断

### 6.2 路由与守卫

`frontend/src/router/index.ts` 定义的路由：

| 路径 | name | 组件 |
|------|------|------|
| `/` | — | 重定向 → `/platform/knowledge-bases` |
| `/login` | login | Login.vue（`requiresAuth: false`） |
| `/join` | joinOrganization | 重定向 → `/platform/organizations`（携带 invite_code） |
| `/knowledgeBase` | home | KnowledgeBase.vue（旧入口） |
| `/platform` | Platform | platform/index.vue |
| `/platform/settings` | settings | Settings.vue |
| `/platform/knowledge-bases` | knowledgeBaseList | KnowledgeBaseList.vue |
| `/platform/knowledge-bases/:kbId` | knowledgeBaseDetail | KnowledgeBase.vue |
| `/platform/agents` | agentList | AgentList.vue |
| `/platform/creatChat` | globalCreatChat | creatChat.vue |
| `/platform/knowledge-bases/:kbId/creatChat` | kbCreatChat | creatChat.vue |
| `/platform/chat/:chatid` | chat | chat/index.vue |
| `/platform/organizations` | organizationList | OrganizationList.vue |

**路由守卫**：

```typescript
router.beforeEach(async (to, from, next) => {
  const authStore = useAuthStore()
  // requiresAuth === false → 放行（已登录访问 /login 则重定向到知识库列表）
  // 未登录 → 重定向到 /login
  // 其他 → 放行
})
```

> **注意**：路由守卫仅检查 `isLoggedIn`，没有 `requiresAdmin`、`meta.roles`、`meta.permissions` 等角色/权限级别检查。

### 6.3 菜单与页面结构

`frontend/src/components/menu.vue`（约 1022 行）：

**侧边栏结构**：
1. **Logo**（点击回到知识库列表）
2. **TenantSelector**（仅 `canAccessAllTenants` 时显示）
3. **上部菜单项**：
   - 知识库（knowledge-bases）
   - 智能体（agents）
   - 共享空间（organizations）—— 含待审批 badge
   - 对话（creatChat）—— 含会话列表子菜单（按时间分组）
4. **底部**：UserMenu 组件

> **注意**：菜单中没有「系统管理」「部门管理」「人员管理」「权限管理」等项目。设置页通过 UserMenu 组件中的按钮打开。

### 6.4 组织管理页面

`frontend/src/views/organization/` 目录包含：

| 文件 | 功能 |
|------|------|
| `OrganizationList.vue` | 组织列表（我的组织 + 搜索发现） |
| `OrganizationEditorModal.vue` | 创建/编辑组织弹窗 |
| `OrganizationSettingsModal.vue` | 组织设置弹窗 |
| `JoinOrganization.vue` | 加入组织页面 |

> **不存在的页面**：没有 `admin/` 目录，没有 DepartmentManage、MemberManage、RoleManage、KBPermissionManage 等管理页面。

### 6.5 设置页面

`frontend/src/views/settings/Settings.vue` 以模态框形式展现，左右分栏布局：

| 导航项 | 组件 | 说明 |
|--------|------|------|
| 常规设置 | GeneralSettings.vue | 通用配置 |
| 模型管理 | ModelSettings.vue | LLM、Embedding、Rerank、VLM 子分类 |
| Ollama | OllamaSettings.vue | Ollama 服务配置 |
| 网络搜索 | WebSearchSettings.vue | 搜索引擎配置 |
| MCP 服务 | McpSettings.vue | MCP 协议配置 |
| 系统信息 | SystemInfo.vue | 系统状态信息 |
| 租户信息 | TenantInfo.vue | 租户详情 |
| API 信息 | ApiInfo.vue | API Key 信息 |

> **注意**：Agent 管理（AgentSettings.vue）文件存在但未在设置导航中显示。没有组织管理、权限管理的设置入口。

### 6.6 API 服务层

`frontend/src/api/organization/` 提供组织管理 API 封装。

**已实现的 API 模块**：

| 目录/文件 | 功能 |
|-----------|------|
| `api/agent/` | Agent 管理 |
| `api/auth/` | 认证 |
| `api/chat/` | 聊天对话 |
| `api/initialization/` | 系统初始化 |
| `api/knowledge-base/` | 知识库管理 |
| `api/model/` | 模型管理 |
| `api/organization/` | 组织管理 + KB/Agent 共享 |
| `api/skill/` | 技能管理 |
| `api/system/` | 系统信息 |
| `api/tenant/` | 租户管理 |
| `api/mcp-service.ts` | MCP 服务 |
| `api/web-search.ts` | 网络搜索 |

**不存在的 API 模块**：没有 `department/`、`member/`、`role/`、`kb-permission/` 目录。

**不存在的前端功能**：
- `v-permission` / `v-role` 自定义指令
- `PermissionGuard.vue` 权限包装组件
- `frontend/src/directives/` 目录
- `frontend/src/stores/permission.ts`

---

## 7. 未来扩展方向

当前 Organization 模型满足了跨用户/跨租户的资源共享需求，但尚未实现以下能力：

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **租户内 RBAC** | 管理员/普通用户角色区分，路由级权限控制 | 中 |
| **部门管理** | 树形部门结构，用户-部门关联 | 低 |
| **知识库可见性** | 公开/私有模式，基于部门的知识库归属 | 低 |
| **精细权限码** | `resource:action` 格式的权限码体系 | 低 |
| **RBAC 中间件** | 路由级角色/权限检查中间件 | 中 |
| **前端权限 Store** | 独立的权限状态管理 + 路由守卫增强 | 中 |
| **前端权限指令** | `v-permission`、`v-role` 自定义指令 | 低 |

> 原 RBAC 设计方案详见附录 8.2。

---

## 8. 附录

### 8.1 数据字典

#### organizations（组织表）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | VARCHAR(36) | 是 | UUID 主键 |
| name | VARCHAR(255) | 是 | 组织名称 |
| description | TEXT | 否 | 描述 |
| avatar | VARCHAR(500) | 否 | 头像 URL |
| owner_id | VARCHAR(36) | 是 | 组织创建者 |
| invite_code | VARCHAR(64) | 否 | 邀请码（16 字符 hex） |
| invite_code_expires_at | TIMESTAMPTZ | 否 | 邀请码过期时间 |
| invite_code_validity_days | INTEGER | 否 | 邀请码有效天数（默认 7，可选 0/1/7/30） |
| require_approval | BOOLEAN | 否 | 是否需要审批才能加入（默认 false） |
| searchable | BOOLEAN | 否 | 是否可被搜索发现（默认 false） |
| member_limit | INTEGER | 否 | 成员上限（默认 50，Service 默认 200） |
| created_at | TIMESTAMPTZ | 是 | 创建时间 |
| updated_at | TIMESTAMPTZ | 是 | 更新时间 |
| deleted_at | TIMESTAMPTZ | 否 | 软删除时间 |

#### organization_members（组织成员表）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | VARCHAR(36) | 是 | UUID 主键 |
| organization_id | VARCHAR(36) | 是 | 组织 ID，外键 |
| user_id | VARCHAR(36) | 是 | 用户 ID |
| tenant_id | INTEGER | 否 | 用户所属租户 ID |
| role | VARCHAR(20) | 是 | 角色：admin/editor/viewer（默认 viewer） |
| created_at | TIMESTAMPTZ | 是 | 创建时间 |
| updated_at | TIMESTAMPTZ | 是 | 更新时间 |

> 唯一约束：(organization_id, user_id)

#### kb_shares（知识库共享表）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | VARCHAR(36) | 是 | UUID 主键 |
| knowledge_base_id | VARCHAR(36) | 是 | 知识库 ID，外键 |
| organization_id | VARCHAR(36) | 是 | 目标组织 ID，外键 |
| shared_by_user_id | VARCHAR(36) | 是 | 共享操作人 |
| source_tenant_id | INTEGER | 是 | 知识库所属租户 ID |
| permission | VARCHAR(20) | 是 | 权限级别：viewer/editor/admin（默认 viewer） |
| created_at | TIMESTAMPTZ | 是 | 创建时间 |
| updated_at | TIMESTAMPTZ | 是 | 更新时间 |
| deleted_at | TIMESTAMPTZ | 否 | 软删除时间 |

> 唯一约束：(knowledge_base_id, organization_id) WHERE deleted_at IS NULL

#### organization_join_requests（加入申请表）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | VARCHAR(36) | 是 | UUID 主键 |
| organization_id | VARCHAR(36) | 是 | 组织 ID，外键 |
| user_id | VARCHAR(36) | 是 | 申请人 |
| tenant_id | INTEGER | 否 | 申请人租户 |
| request_type | VARCHAR(20) | 是 | 类型：join（加入）/ upgrade（角色升级） |
| prev_role | VARCHAR(20) | 否 | 升级前角色（仅 upgrade 类型） |
| requested_role | VARCHAR(20) | 是 | 申请的角色（默认 viewer） |
| status | VARCHAR(20) | 是 | 状态：pending/approved/rejected |
| message | TEXT | 否 | 申请理由 |
| reviewed_by | VARCHAR(36) | 否 | 审批人 ID |
| reviewed_at | TIMESTAMPTZ | 否 | 审批时间 |
| review_message | TEXT | 否 | 审批留言 |
| created_at | TIMESTAMPTZ | 是 | 创建时间 |
| updated_at | TIMESTAMPTZ | 是 | 更新时间 |

> 唯一约束：(organization_id, user_id) WHERE status = 'pending'

#### agent_shares（Agent 共享表）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | VARCHAR(36) | 是 | UUID 主键 |
| agent_id | VARCHAR(36) | 是 | Agent ID |
| organization_id | VARCHAR(36) | 是 | 目标组织 ID |
| shared_by_user_id | VARCHAR(36) | 是 | 共享操作人 |
| source_tenant_id | INTEGER | 是 | Agent 所属租户 ID |
| permission | VARCHAR(20) | 是 | 权限级别（默认 viewer） |
| created_at | TIMESTAMPTZ | 是 | 创建时间 |
| updated_at | TIMESTAMPTZ | 是 | 更新时间 |
| deleted_at | TIMESTAMPTZ | 否 | 软删除时间 |

> 唯一约束：(agent_id, source_tenant_id, organization_id) WHERE deleted_at IS NULL
> 外键：(agent_id, source_tenant_id) → custom_agents(id, tenant_id)

#### tenant_disabled_shared_agents（租户禁用的共享 Agent）

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| tenant_id | BIGINT | 是 | 租户 ID（复合主键） |
| agent_id | VARCHAR(36) | 是 | Agent ID（复合主键） |
| source_tenant_id | BIGINT | 是 | Agent 来源租户 ID（复合主键） |
| created_at | TIMESTAMPTZ | 是 | 创建时间 |

### 8.2 原 RBAC 设计方案（未实现，供参考）

> 以下是原 v2.0 文档中设计的 Department + RBAC 权限模型，**尚未在代码中实现**。保留供未来扩展参考。

**计划中的新增表**：
- `departments`（部门表）—— 树形部门结构
- `roles`（角色表）—— admin / user 两种系统角色
- `user_roles`（用户-角色关联表）
- `user_departments`（用户-部门关联表）
- `kb_permissions`（知识库精细授权表）

**计划中的新增字段**：
- `users` 表：`phone`、`position`、`employee_no`
- `knowledge_bases` 表：`created_by`、`visibility`（public/private）、`department_id`

**计划中的新增文件**：
- 后端：`internal/types/department.go`、`internal/types/role.go`、`internal/types/kb_permission.go`、`internal/middleware/rbac.go` 等
- 前端：`stores/permission.ts`、`directives/permission.ts`、`components/PermissionGuard.vue`、`views/admin/*` 等

详见 `docs/权限管理系统技术开发文档.md_bak`（原 v2.0 文档备份）。

---

> **文档结束**
> 本文档为 WeKnora 权限管理系统的实际技术实现文档，与当前代码完全匹配。系统采用 Organization（共享空间）模型实现资源共享和协作，通过租户隔离 + 组织角色（admin/editor/viewer）控制权限。原设计的 Department + RBAC 模型保留在备份文件中供未来参考。

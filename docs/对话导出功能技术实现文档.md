# å¯¹è¯å¯¼å‡ºåŠŸèƒ½æŠ€æœ¯å®ç°æ–‡æ¡£

> ç‰ˆæœ¬ï¼šv1.0  
> æ—¥æœŸï¼š2025-07  
> èŒƒå›´ï¼šåœ¨å¯¹è¯é¡µé¢æ™ºèƒ½ä½“/AI ç”Ÿæˆç»“æœåŒºåŸŸï¼Œäºã€Œå¤åˆ¶ã€æŒ‰é’®åæ–°å¢ã€Œå¯¼å‡ºã€æŒ‰é’®ï¼Œæ”¯æŒå¯¼å‡ºä¸º PDFã€Markdownã€Wordï¼ˆDOCXï¼‰ã€XLSX å››ç§æ ¼å¼ã€‚

---

## ç›®å½•

1. [éœ€æ±‚æ¦‚è¿°](#1-éœ€æ±‚æ¦‚è¿°)
2. [ç°æœ‰æ¶æ„åˆ†æ](#2-ç°æœ‰æ¶æ„åˆ†æ)
3. [æ•´ä½“æ–¹æ¡ˆè®¾è®¡](#3-æ•´ä½“æ–¹æ¡ˆè®¾è®¡)
4. [UI äº¤äº’è®¾è®¡](#4-ui-äº¤äº’è®¾è®¡)
5. [ç»„ä»¶å®ç°æ–¹æ¡ˆ](#5-ç»„ä»¶å®ç°æ–¹æ¡ˆ)
6. [å„æ ¼å¼å¯¼å‡ºå®ç°](#6-å„æ ¼å¼å¯¼å‡ºå®ç°)
7. [å›½é™…åŒ– (i18n) æ‰©å±•](#7-å›½é™…åŒ–-i18n-æ‰©å±•)
8. [ä¾èµ–ç®¡ç†](#8-ä¾èµ–ç®¡ç†)
9. [æ–‡ä»¶ç›®å½•ç»“æ„](#9-æ–‡ä»¶ç›®å½•ç»“æ„)
10. [ä»£ç å®ç°ç»†èŠ‚](#10-ä»£ç å®ç°ç»†èŠ‚)
11. [æ ·å¼è®¾è®¡](#11-æ ·å¼è®¾è®¡)
12. [æµ‹è¯•æ–¹æ¡ˆ](#12-æµ‹è¯•æ–¹æ¡ˆ)
13. [æ€§èƒ½ä¸å®‰å…¨è€ƒé‡](#13-æ€§èƒ½ä¸å®‰å…¨è€ƒé‡)
14. [å®æ–½è®¡åˆ’](#14-å®æ–½è®¡åˆ’)

---

## 1. éœ€æ±‚æ¦‚è¿°

### 1.1 åŠŸèƒ½ç›®æ ‡

åœ¨å¯¹è¯é¡µé¢ä¸­ï¼ŒAI/æ™ºèƒ½ä½“ç”Ÿæˆå›ç­”åï¼Œç°æœ‰çš„å·¥å…·æ åŒ…å«ã€Œå¤åˆ¶ã€å’Œã€Œæ·»åŠ åˆ°çŸ¥è¯†åº“ã€ä¸¤ä¸ªæŒ‰é’®ã€‚éœ€è¦åœ¨å·¥å…·æ ä¸­æ–°å¢ä¸€ä¸ªã€Œå¯¼å‡ºã€æŒ‰é’®ï¼Œç‚¹å‡»åå¼¹å‡ºæ ¼å¼é€‰æ‹©èœå•ï¼Œç”¨æˆ·å¯é€‰æ‹©ä»¥ä¸‹å¯¼å‡ºæ ¼å¼ï¼š

| æ ¼å¼ | æ–‡ä»¶æ‰©å±•å | è¯´æ˜ |
|------|-----------|------|
| PDF | `.pdf` | å¸¦æ’ç‰ˆçš„ PDF æ–‡æ¡£ï¼Œä¿ç•™æ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—ç­‰æ ·å¼ |
| Markdown | `.md` | åŸå§‹ Markdown æºæ–‡æœ¬ |
| Word | `.docx` | Microsoft Word å…¼å®¹æ–‡æ¡£ |
| XLSX | `.xlsx` | Excel ç”µå­è¡¨æ ¼ï¼ˆé€‚ç”¨äºå«è¡¨æ ¼å†…å®¹çš„å›ç­”ï¼‰ |

### 1.2 æ¶‰åŠé¡µé¢

å¯¼å‡ºæŒ‰é’®éœ€è¦åœ¨ä»¥ä¸‹ä¸¤ä¸ªç»„ä»¶ä¸­æ·»åŠ ï¼š

- **`botmsg.vue`**ï¼šé Agent æ¨¡å¼ä¸‹çš„ AI å›ç­”æ¶ˆæ¯ç»„ä»¶
- **`AgentStreamDisplay.vue`**ï¼šAgent æ¨¡å¼ä¸‹çš„æµå¼å›ç­”å±•ç¤ºç»„ä»¶

---

## 2. ç°æœ‰æ¶æ„åˆ†æ

### 2.1 å¤åˆ¶æŒ‰é’®ä½ç½®

#### botmsg.vueï¼ˆé Agent æ¨¡å¼ï¼‰

```vue
<!-- æ–‡ä»¶è·¯å¾„: frontend/src/views/chat/components/botmsg.vue -->
<!-- è¡Œå·: 35-42 -->
<div v-if="session.is_completed && (content || session.content)" class="answer-toolbar">
    <t-button size="small" variant="outline" shape="round"
        @click.stop="handleCopyAnswer" :title="$t('agent.copy')">
        <t-icon name="copy" />
    </t-button>
    <t-button size="small" variant="outline" shape="round"
        @click.stop="handleAddToKnowledge" :title="$t('agent.addToKnowledgeBase')">
        <t-icon name="add" />
    </t-button>
</div>
```

#### AgentStreamDisplay.vueï¼ˆAgent æ¨¡å¼ï¼‰

```vue
<!-- æ–‡ä»¶è·¯å¾„: frontend/src/views/chat/components/AgentStreamDisplay.vue -->
<!-- è¡Œå·: 59-66 -->
<div v-if="event.done" class="answer-toolbar">
    <t-button size="small" variant="outline" shape="round"
        @click.stop="handleCopyAnswer(event)" :title="$t('agent.copy')">
        <t-icon name="copy" />
    </t-button>
    <t-button size="small" variant="outline" shape="round"
        @click.stop="handleAddToKnowledge(event)" :title="$t('agent.addToKnowledgeBase')">
        <t-icon name="add" />
    </t-button>
</div>
```

### 2.2 å†…å®¹è·å–æ–¹å¼

ä¸¤ä¸ªç»„ä»¶å‡é€šè¿‡ `getActualContent()` å‡½æ•°è·å–åŸå§‹ Markdown æ–‡æœ¬ï¼š

| ç»„ä»¶ | å‡½æ•°ç­¾å | å†…å®¹æ¥æº |
|------|---------|---------|
| `botmsg.vue` | `getActualContent()` | `props.content \|\| props.session?.content` |
| `AgentStreamDisplay.vue` | `getActualContent(answerEvent)` | `answerEvent.content`ï¼Œå¤‡é€‰ `lastThinking.content` |

### 2.3 ç°æœ‰æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| Vue 3 | ^3.5.13 | UI æ¡†æ¶ï¼ŒComposition API + `<script setup>` |
| TDesign Vue Next | ^1.17.2 | UI ç»„ä»¶åº“ï¼ˆt-button, t-dropdown, t-popup ç­‰ï¼‰ |
| marked | ^5.1.2 | Markdown â†’ HTML è½¬æ¢ |
| DOMPurify | ^3.2.6 | HTML å®‰å…¨æ¸…ç† |
| xlsx (SheetJS) | 0.20.2 | Excel æ–‡ä»¶è¯»å†™ï¼ˆå·²æœ‰ä¾èµ–ï¼‰ |
| vue-i18n | ^11.1.12 | å›½é™…åŒ– |

### 2.4 answer-toolbar æ ·å¼

å·¥å…·æ ä½¿ç”¨ flex å¸ƒå±€ï¼ŒæŒ‰é’®é—´è· `gap: 6px`ï¼ŒæŒ‰é’®é‡‡ç”¨ `size="small" variant="outline" shape="round"` ç»Ÿä¸€é£æ ¼ï¼Œä»…æ˜¾ç¤ºå›¾æ ‡ã€éšè—æ–‡å­—ã€‚

---

## 3. æ•´ä½“æ–¹æ¡ˆè®¾è®¡

### 3.1 æ¶æ„å†³ç­–

| å†³ç­–é¡¹ | é€‰æ‹© | ç†ç”± |
|--------|------|------|
| å¯¼å‡ºæ‰§è¡Œä½ç½® | çº¯å‰ç«¯ | å¯¼å‡ºå†…å®¹å³å·²æ¸²æŸ“çš„å›ç­”æ–‡æœ¬ï¼Œæ— éœ€åç«¯å‚ä¸ |
| ç»„ä»¶å¤ç”¨ | æŠ½å–å…±äº«ç»„ä»¶ `ExportDropdown.vue` | é¿å…åœ¨ä¸¤ä¸ªç»„ä»¶ä¸­é‡å¤å®ç°å¯¼å‡ºé€»è¾‘ |
| å¯¼å‡ºå·¥å…·å‡½æ•° | ç‹¬ç«‹ `utils/exportUtils.ts` | èŒè´£åˆ†ç¦»ï¼Œä¾¿äºå•å…ƒæµ‹è¯•å’Œåç»­æ‰©å±• |
| æ ¼å¼é€‰æ‹© UI | TDesign `t-popup` + è‡ªå®šä¹‰èœå• | ä¸ç°æœ‰æŒ‰é’®é£æ ¼ä¿æŒä¸€è‡´ï¼Œäº¤äº’ç»Ÿä¸€ |

### 3.2 æ•°æ®æµ

```
ç”¨æˆ·ç‚¹å‡»å¯¼å‡ºæŒ‰é’®
    â†“
å¼¹å‡ºæ ¼å¼é€‰æ‹©ä¸‹æ‹‰èœå• (PDF / Markdown / Word / XLSX)
    â†“
ç”¨æˆ·é€‰æ‹©æ ¼å¼
    â†“
ExportDropdown ç»„ä»¶è°ƒç”¨ exportUtils å¯¹åº”æ–¹æ³•
    â†“
exportUtils è·å– Markdown åŸæ–‡å†…å®¹ (ç”±çˆ¶ç»„ä»¶ä¼ å…¥)
    â†“
æ ¹æ®æ ¼å¼æ‰§è¡Œè½¬æ¢:
    â”œâ”€ Markdown: ç›´æ¥è¾“å‡ºä¸º .md æ–‡ä»¶
    â”œâ”€ PDF:      Markdown â†’ HTML â†’ html2pdf.js ç”Ÿæˆ PDF
    â”œâ”€ Word:     Markdown â†’ HTML â†’ html-docx-js ç”Ÿæˆ DOCX
    â””â”€ XLSX:     è§£æ Markdown æå–è¡¨æ ¼ â†’ SheetJS ç”Ÿæˆ XLSX
    â†“
è§¦å‘æµè§ˆå™¨ä¸‹è½½
```

---

## 4. UI äº¤äº’è®¾è®¡

### 4.1 æŒ‰é’®å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI å›ç­”å†…å®¹ (Markdown æ¸²æŸ“)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ğŸ“‹ å¤åˆ¶]  [â• æ·»åŠ åˆ°çŸ¥è¯†åº“]  [ğŸ“¥ å¯¼å‡º â–¾]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 ä¸‹æ‹‰èœå•

ç‚¹å‡»å¯¼å‡ºæŒ‰é’®åï¼Œå¼¹å‡ºæµ®å±‚èœå•ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„  å¯¼å‡ºä¸º PDF   â”‚
â”‚ ğŸ“  å¯¼å‡ºä¸º Markdown â”‚
â”‚ ğŸ“˜  å¯¼å‡ºä¸º Word  â”‚
â”‚ ğŸ“Š  å¯¼å‡ºä¸º XLSX  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 äº¤äº’ç»†èŠ‚

- å¯¼å‡ºæŒ‰é’®å›¾æ ‡ä½¿ç”¨ TDesign çš„ `download` å›¾æ ‡
- ä¸‹æ‹‰èœå•ä½¿ç”¨ `t-popup` ç»„ä»¶ï¼Œ`trigger="click"` è§¦å‘
- å¯¼å‡ºè¿‡ç¨‹ä¸­æŒ‰é’®æ˜¾ç¤º loading çŠ¶æ€
- å¯¼å‡ºæˆåŠŸåæ˜¾ç¤º `MessagePlugin.success` æç¤º
- å¯¼å‡ºå¤±è´¥æ—¶æ˜¾ç¤º `MessagePlugin.error` æç¤º
- ç”Ÿæˆçš„æ–‡ä»¶åæ ¼å¼ï¼š`å¯¹è¯å¯¼å‡º_YYYY-MM-DD_HHmmss.{ext}`

---

## 5. ç»„ä»¶å®ç°æ–¹æ¡ˆ

### 5.1 ExportDropdown.vue ç»„ä»¶

**æ–‡ä»¶è·¯å¾„**: `frontend/src/views/chat/components/ExportDropdown.vue`

#### Props å®šä¹‰

```typescript
interface ExportDropdownProps {
  /** è¦å¯¼å‡ºçš„ Markdown åŸæ–‡å†…å®¹ */
  content: string;
  /** æ–‡ä»¶åå‰ç¼€ï¼ˆå¯é€‰ï¼‰ï¼Œé»˜è®¤ä¸º "å¯¹è¯å¯¼å‡º" */
  filenamePrefix?: string;
  /** ç¦ç”¨çŠ¶æ€ */
  disabled?: boolean;
}
```

#### æ¨¡æ¿ç»“æ„

```vue
<template>
  <t-popup
    trigger="click"
    placement="bottom"
    :visible="menuVisible"
    @visible-change="handleVisibleChange"
    :overlay-style="{ padding: '4px 0' }"
  >
    <t-button
      size="small"
      variant="outline"
      shape="round"
      :loading="exporting"
      :disabled="disabled || !content"
      :title="$t('export.title')"
      @click.stop
    >
      <t-icon name="download" />
    </t-button>
    <template #content>
      <div class="export-menu">
        <div
          v-for="format in exportFormats"
          :key="format.value"
          class="export-menu-item"
          @click="handleExport(format.value)"
        >
          <t-icon :name="format.icon" />
          <span>{{ format.label }}</span>
        </div>
      </div>
    </template>
  </t-popup>
</template>
```

#### æ ¸å¿ƒé€»è¾‘

```typescript
import { ref, computed } from 'vue';
import { useI18n } from 'vue-i18n';
import { MessagePlugin } from 'tdesign-vue-next';
import {
  exportAsMarkdown,
  exportAsPDF,
  exportAsWord,
  exportAsXLSX,
} from '@/utils/exportUtils';

const props = defineProps<ExportDropdownProps>();
const { t } = useI18n();
const menuVisible = ref(false);
const exporting = ref(false);

const exportFormats = computed(() => [
  { value: 'pdf',      icon: 'file-pdf',   label: t('export.pdf') },
  { value: 'markdown',  icon: 'file',       label: t('export.markdown') },
  { value: 'word',     icon: 'file-word',   label: t('export.word') },
  { value: 'xlsx',     icon: 'file-excel',  label: t('export.xlsx') },
]);

const handleExport = async (format: string) => {
  menuVisible.value = false;
  if (!props.content) {
    MessagePlugin.warning(t('export.emptyContent'));
    return;
  }

  exporting.value = true;
  try {
    const filename = generateFilename(props.filenamePrefix);
    switch (format) {
      case 'pdf':
        await exportAsPDF(props.content, filename);
        break;
      case 'markdown':
        exportAsMarkdown(props.content, filename);
        break;
      case 'word':
        await exportAsWord(props.content, filename);
        break;
      case 'xlsx':
        exportAsXLSX(props.content, filename);
        break;
    }
    MessagePlugin.success(t('export.success'));
  } catch (err) {
    console.error('å¯¼å‡ºå¤±è´¥:', err);
    MessagePlugin.error(t('export.failed'));
  } finally {
    exporting.value = false;
  }
};
```

---

## 6. å„æ ¼å¼å¯¼å‡ºå®ç°

**æ–‡ä»¶è·¯å¾„**: `frontend/src/utils/exportUtils.ts`

### 6.1 é€šç”¨è¾…åŠ©å‡½æ•°

```typescript
/**
 * ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æ–‡ä»¶å
 */
export const generateFilename = (prefix?: string): string => {
  const now = new Date();
  const timestamp = now.toISOString().replace(/[-:T]/g, '').slice(0, 15);
  return `${prefix || 'å¯¹è¯å¯¼å‡º'}_${timestamp}`;
};

/**
 * è§¦å‘æµè§ˆå™¨ä¸‹è½½
 */
export const triggerDownload = (blob: Blob, filename: string): void => {
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
};

/**
 * å°† Markdown è½¬æ¢ä¸ºå¸¦æ ·å¼çš„ HTML å­—ç¬¦ä¸²
 */
export const markdownToStyledHTML = (markdown: string): string => {
  const { marked } = require('marked');
  const rawHTML = marked.parse(markdown);
  // åŒ…è£¹é€šç”¨æ ·å¼ï¼Œç¡®ä¿å¯¼å‡ºæ–‡æ¡£å¯è¯»æ€§
  return `
    <html>
    <head>
      <meta charset="utf-8">
      <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
               line-height: 1.6; padding: 20px; max-width: 800px; margin: 0 auto; color: #333; }
        h1, h2, h3, h4, h5, h6 { margin-top: 1.2em; margin-bottom: 0.6em; }
        code { background: #f5f5f5; padding: 2px 6px; border-radius: 3px; font-size: 0.9em; }
        pre { background: #f5f5f5; padding: 16px; border-radius: 6px; overflow-x: auto; }
        pre code { background: none; padding: 0; }
        blockquote { border-left: 4px solid #ddd; margin: 1em 0; padding: 0.5em 1em; color: #666; }
        table { border-collapse: collapse; width: 100%; margin: 1em 0; }
        th, td { border: 1px solid #ddd; padding: 8px 12px; text-align: left; }
        th { background: #f5f5f5; font-weight: 600; }
        img { max-width: 100%; }
        ul, ol { padding-left: 2em; }
        a { color: #0066cc; }
      </style>
    </head>
    <body>${rawHTML}</body>
    </html>
  `;
};
```

### 6.2 Markdown å¯¼å‡º

æœ€ç®€å•çš„å¯¼å‡ºæ–¹å¼â€”â€”ç›´æ¥è¾“å‡ºåŸå§‹ Markdown æ–‡æœ¬ã€‚

```typescript
/**
 * å¯¼å‡ºä¸º Markdown æ–‡ä»¶ (.md)
 * @param content - åŸå§‹ Markdown æ–‡æœ¬
 * @param filename - æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰
 */
export const exportAsMarkdown = (content: string, filename: string): void => {
  const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
  triggerDownload(blob, `${filename}.md`);
};
```

### 6.3 PDF å¯¼å‡º

ä½¿ç”¨ `html2pdf.js` å°† Markdown æ¸²æŸ“ä¸º HTML åç”Ÿæˆ PDFï¼Œä¿ç•™ä»£ç å—ã€è¡¨æ ¼ç­‰æ ·å¼ã€‚

```typescript
/**
 * å¯¼å‡ºä¸º PDF æ–‡ä»¶
 * é‡‡ç”¨ html2pdf.js åº“ï¼Œå°† HTML æ¸²æŸ“ä¸º PDF
 * @param content - åŸå§‹ Markdown æ–‡æœ¬
 * @param filename - æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰
 */
export const exportAsPDF = async (content: string, filename: string): Promise<void> => {
  // åŠ¨æ€åŠ è½½ html2pdf.jsï¼ˆé¿å…å½±å“é¦–å±åŠ è½½ï¼‰
  const html2pdf = (await import('html2pdf.js')).default;

  const styledHTML = markdownToStyledHTML(content);
  
  // åˆ›å»ºä¸´æ—¶å®¹å™¨
  const container = document.createElement('div');
  container.innerHTML = styledHTML;
  container.style.position = 'absolute';
  container.style.left = '-9999px';
  container.style.width = '800px';
  document.body.appendChild(container);

  try {
    await html2pdf()
      .set({
        margin: [15, 15, 15, 15],  // mm
        filename: `${filename}.pdf`,
        image: { type: 'jpeg', quality: 0.95 },
        html2canvas: {
          scale: 2,
          useCORS: true,
          logging: false,
        },
        jsPDF: {
          unit: 'mm',
          format: 'a4',
          orientation: 'portrait',
        },
        pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
      })
      .from(container)
      .save();
  } finally {
    document.body.removeChild(container);
  }
};
```

### 6.4 Word (DOCX) å¯¼å‡º

ä½¿ç”¨ `html-docx-js-typescript` å°† HTML è½¬æ¢ä¸º DOCX æ ¼å¼ã€‚

```typescript
/**
 * å¯¼å‡ºä¸º Word DOCX æ–‡ä»¶
 * ä½¿ç”¨ html-docx-js-typescript å°† HTML è½¬æ¢ä¸º docx
 * @param content - åŸå§‹ Markdown æ–‡æœ¬
 * @param filename - æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰
 */
export const exportAsWord = async (content: string, filename: string): Promise<void> => {
  // åŠ¨æ€åŠ è½½
  const { asBlob } = await import('html-docx-js-typescript');

  const styledHTML = markdownToStyledHTML(content);
  const docxBlob = asBlob(styledHTML) as Blob;
  triggerDownload(
    docxBlob,
    `${filename}.docx`
  );
};
```

### 6.5 XLSX å¯¼å‡º

åˆ©ç”¨é¡¹ç›®å·²æœ‰çš„ SheetJS (`xlsx`) ä¾èµ–ï¼Œä» Markdown ä¸­è§£æè¡¨æ ¼æ•°æ®å¯¼å‡ºã€‚è‹¥å›ç­”ä¸­ä¸å«è¡¨æ ¼ï¼Œåˆ™å°†æ•´ä¸ªå›ç­”å†…å®¹ä½œä¸ºå•åˆ—æ•°æ®è¾“å‡ºã€‚

```typescript
import * as XLSX from 'xlsx';

/**
 * ä» Markdown æ–‡æœ¬ä¸­æå–è¡¨æ ¼æ•°æ®
 * æ”¯æŒæ ‡å‡† Markdown è¡¨æ ¼è¯­æ³•
 */
const extractTablesFromMarkdown = (content: string): string[][][] => {
  const tables: string[][][] = [];
  const lines = content.split('\n');
  let currentTable: string[][] = [];
  let inTable = false;

  for (const line of lines) {
    const trimmed = line.trim();
    // æ£€æµ‹è¡¨æ ¼è¡Œï¼ˆåŒ…å« | åˆ†éš”ç¬¦ï¼‰
    if (trimmed.startsWith('|') && trimmed.endsWith('|')) {
      // è·³è¿‡åˆ†éš”è¡Œ (|---|---|)
      if (/^\|[\s\-:]+\|$/.test(trimmed.replace(/\|/g, '|').replace(/[:\-\s]/g, ''))) {
        continue;
      }
      const cells = trimmed
        .slice(1, -1)            // å»æ‰é¦–å°¾ |
        .split('|')
        .map(cell => cell.trim());
      currentTable.push(cells);
      inTable = true;
    } else {
      if (inTable && currentTable.length > 0) {
        tables.push(currentTable);
        currentTable = [];
      }
      inTable = false;
    }
  }
  // å¤„ç†æœ«å°¾è¡¨æ ¼
  if (currentTable.length > 0) {
    tables.push(currentTable);
  }
  return tables;
};

/**
 * å¯¼å‡ºä¸º XLSX æ–‡ä»¶
 * ä¼˜å…ˆæå– Markdown ä¸­çš„è¡¨æ ¼æ•°æ®ï¼›
 * è‹¥æ— è¡¨æ ¼ï¼Œåˆ™å°†æ•´æ®µæ–‡æœ¬ä½œä¸ºå•åˆ—è¾“å‡º
 * @param content - åŸå§‹ Markdown æ–‡æœ¬
 * @param filename - æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰
 */
export const exportAsXLSX = (content: string, filename: string): void => {
  const workbook = XLSX.utils.book_new();
  const tables = extractTablesFromMarkdown(content);

  if (tables.length > 0) {
    // æœ‰è¡¨æ ¼æ•°æ®ï¼šæ¯ä¸ªè¡¨æ ¼ä¸€ä¸ª Sheet
    tables.forEach((table, index) => {
      const worksheet = XLSX.utils.aoa_to_sheet(table);
      // è®¾ç½®åˆ—å®½è‡ªé€‚åº”
      const colWidths = table[0]?.map((_, colIdx) => {
        const maxLen = Math.max(
          ...table.map(row => (row[colIdx] || '').length)
        );
        return { wch: Math.min(Math.max(maxLen + 2, 10), 50) };
      });
      if (colWidths) worksheet['!cols'] = colWidths;
      
      const sheetName = tables.length === 1 ? 'Sheet1' : `è¡¨æ ¼${index + 1}`;
      XLSX.utils.book_append_sheet(workbook, worksheet, sheetName);
    });
  } else {
    // æ— è¡¨æ ¼æ•°æ®ï¼šå°†å›ç­”å†…å®¹æŒ‰è¡Œå¯¼å‡º
    const rows = content.split('\n').map(line => [line]);
    const worksheet = XLSX.utils.aoa_to_sheet([['å†…å®¹'], ...rows]);
    worksheet['!cols'] = [{ wch: 80 }];
    XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
  }

  XLSX.writeFile(workbook, `${filename}.xlsx`);
};
```

---

## 7. å›½é™…åŒ– (i18n) æ‰©å±•

åœ¨å››ä¸ªè¯­è¨€æ–‡ä»¶ä¸­æ·»åŠ  `export` å‘½åç©ºé—´çš„ç¿»è¯‘é”®ã€‚

### 7.1 zh-CNï¼ˆä¸­æ–‡ï¼‰

```typescript
// frontend/src/i18n/locales/zh-CN.ts
export: {
  title: 'å¯¼å‡º',
  pdf: 'å¯¼å‡ºä¸º PDF',
  markdown: 'å¯¼å‡ºä¸º Markdown',
  word: 'å¯¼å‡ºä¸º Word',
  xlsx: 'å¯¼å‡ºä¸º XLSX',
  success: 'å¯¼å‡ºæˆåŠŸ',
  failed: 'å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•',
  emptyContent: 'å½“å‰å›ç­”ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º',
},
```

### 7.2 en-USï¼ˆè‹±æ–‡ï¼‰

```typescript
// frontend/src/i18n/locales/en-US.ts
export: {
  title: 'Export',
  pdf: 'Export as PDF',
  markdown: 'Export as Markdown',
  word: 'Export as Word',
  xlsx: 'Export as XLSX',
  success: 'Export successful',
  failed: 'Export failed, please retry',
  emptyContent: 'No content to export',
},
```

### 7.3 ru-RUï¼ˆä¿„æ–‡ï¼‰

```typescript
// frontend/src/i18n/locales/ru-RU.ts
export: {
  title: 'Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚',
  pdf: 'Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ² PDF',
  markdown: 'Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ² Markdown',
  word: 'Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ² Word',
  xlsx: 'Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ² XLSX',
  success: 'Ğ­ĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½',
  failed: 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ°, Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°',
  emptyContent: 'ĞĞµÑ‚ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğ³Ğ¾ Ğ´Ğ»Ñ ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚Ğ°',
},
```

### 7.4 ko-KRï¼ˆéŸ©æ–‡ï¼‰

```typescript
// frontend/src/i18n/locales/ko-KR.ts
export: {
  title: 'ë‚´ë³´ë‚´ê¸°',
  pdf: 'PDFë¡œ ë‚´ë³´ë‚´ê¸°',
  markdown: 'Markdownìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°',
  word: 'Wordë¡œ ë‚´ë³´ë‚´ê¸°',
  xlsx: 'XLSXë¡œ ë‚´ë³´ë‚´ê¸°',
  success: 'ë‚´ë³´ë‚´ê¸° ì™„ë£Œ',
  failed: 'ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨, ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”',
  emptyContent: 'ë‚´ë³´ë‚¼ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤',
},
```

---

## 8. ä¾èµ–ç®¡ç†

### 8.1 ç°æœ‰å¯å¤ç”¨ä¾èµ–

| åŒ…å | ç‰ˆæœ¬ | ç”¨é€” | çŠ¶æ€ |
|------|------|------|------|
| `xlsx` | 0.20.2 | XLSX å¯¼å‡º | âœ… å·²å®‰è£…ï¼ˆæœ¬åœ° tgzï¼‰ |
| `marked` | ^5.1.2 | Markdown â†’ HTML | âœ… å·²å®‰è£… |
| `dompurify` | ^3.2.6 | HTML å®‰å…¨æ¸…ç† | âœ… å·²å®‰è£… |

### 8.2 éœ€è¦æ–°å¢çš„ä¾èµ–

| åŒ…å | æ¨èç‰ˆæœ¬ | ç”¨é€” | å¤§å° | åŠ è½½ç­–ç•¥ |
|------|---------|------|------|---------|
| `html2pdf.js` | ^0.10.1 | PDF å¯¼å‡ºï¼ˆå« html2canvas + jsPDFï¼‰ | ~400KB | åŠ¨æ€ importï¼ˆæŒ‰éœ€ï¼‰ |
| `html-docx-js-typescript` | ^0.1.5 | Word DOCX å¯¼å‡º | ~50KB | åŠ¨æ€ importï¼ˆæŒ‰éœ€ï¼‰ |

### 8.3 å®‰è£…å‘½ä»¤

```bash
cd frontend
npm install html2pdf.js html-docx-js-typescript --save
```

### 8.4 TypeScript ç±»å‹å£°æ˜

`html2pdf.js` æ²¡æœ‰å®˜æ–¹ TypeScript ç±»å‹å®šä¹‰ï¼Œéœ€è¦åœ¨ `frontend/src/types/` æˆ– `env.d.ts` ä¸­æ·»åŠ å£°æ˜ï¼š

```typescript
// frontend/src/types/html2pdf.d.ts
declare module 'html2pdf.js' {
  interface Html2PdfOptions {
    margin?: number | number[];
    filename?: string;
    image?: { type?: string; quality?: number };
    html2canvas?: Record<string, any>;
    jsPDF?: { unit?: string; format?: string; orientation?: string };
    pagebreak?: { mode?: string[] };
  }
  
  interface Html2PdfInstance {
    set(options: Html2PdfOptions): Html2PdfInstance;
    from(element: HTMLElement | string): Html2PdfInstance;
    save(): Promise<void>;
    outputPdf(type?: string): Promise<any>;
  }
  
  function html2pdf(): Html2PdfInstance;
  export default html2pdf;
}

// frontend/src/types/html-docx.d.ts
declare module 'html-docx-js-typescript' {
  export function asBlob(html: string, options?: Record<string, any>): Blob;
}
```

---

## 9. æ–‡ä»¶ç›®å½•ç»“æ„

ä»¥ä¸‹ä¸ºæœ¬æ¬¡åŠŸèƒ½æ¶‰åŠçš„æ–°å¢å’Œä¿®æ”¹æ–‡ä»¶æ¸…å•ï¼š

```
frontend/src/
â”œâ”€â”€ views/chat/components/
â”‚   â”œâ”€â”€ ExportDropdown.vue          â† ã€æ–°å¢ã€‘å¯¼å‡ºä¸‹æ‹‰èœå•ç»„ä»¶
â”‚   â”œâ”€â”€ botmsg.vue                  â† ã€ä¿®æ”¹ã€‘åœ¨ answer-toolbar ä¸­å¼•å…¥ ExportDropdown
â”‚   â””â”€â”€ AgentStreamDisplay.vue      â† ã€ä¿®æ”¹ã€‘åœ¨ answer-toolbar ä¸­å¼•å…¥ ExportDropdown
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ exportUtils.ts              â† ã€æ–°å¢ã€‘å¯¼å‡ºå·¥å…·å‡½æ•°ï¼ˆPDF/MD/Word/XLSXï¼‰
â”œâ”€â”€ types/
â”‚   â”œâ”€â”€ html2pdf.d.ts               â† ã€æ–°å¢ã€‘html2pdf.js ç±»å‹å£°æ˜
â”‚   â””â”€â”€ html-docx.d.ts              â† ã€æ–°å¢ã€‘html-docx-js-typescript ç±»å‹å£°æ˜
â””â”€â”€ i18n/locales/
    â”œâ”€â”€ zh-CN.ts                    â† ã€ä¿®æ”¹ã€‘æ–°å¢ export é”®
    â”œâ”€â”€ en-US.ts                    â† ã€ä¿®æ”¹ã€‘æ–°å¢ export é”®
    â”œâ”€â”€ ru-RU.ts                    â† ã€ä¿®æ”¹ã€‘æ–°å¢ export é”®
    â””â”€â”€ ko-KR.ts                    â† ã€ä¿®æ”¹ã€‘æ–°å¢ export é”®
```

---

## 10. ä»£ç å®ç°ç»†èŠ‚

### 10.1 botmsg.vue ä¿®æ”¹

```vue
<!-- ä¿®æ”¹ answer-toolbar åŒºåŸŸï¼Œåœ¨æ·»åŠ åˆ°çŸ¥è¯†åº“æŒ‰é’®åé¢æ–°å¢å¯¼å‡ºæŒ‰é’® -->
<template>
  <!-- ... ç°æœ‰æ¨¡æ¿ ... -->
  <div v-if="session.is_completed && (content || session.content)" class="answer-toolbar">
      <t-button size="small" variant="outline" shape="round"
          @click.stop="handleCopyAnswer" :title="$t('agent.copy')">
          <t-icon name="copy" />
      </t-button>
      <t-button size="small" variant="outline" shape="round"
          @click.stop="handleAddToKnowledge" :title="$t('agent.addToKnowledgeBase')">
          <t-icon name="add" />
      </t-button>
      <!-- âœ… æ–°å¢ï¼šå¯¼å‡ºæŒ‰é’® -->
      <ExportDropdown
          :content="getActualContent()"
          :filename-prefix="formatManualTitle(userQuery)"
      />
  </div>
</template>

<script setup>
// æ–°å¢ import
import ExportDropdown from './ExportDropdown.vue';
// ... ç°æœ‰ä»£ç ä¿æŒä¸å˜ ...
</script>
```

### 10.2 AgentStreamDisplay.vue ä¿®æ”¹

```vue
<!-- ä¿®æ”¹ answer-toolbar åŒºåŸŸ -->
<div v-if="event.done" class="answer-toolbar">
    <t-button size="small" variant="outline" shape="round"
        @click.stop="handleCopyAnswer(event)" :title="$t('agent.copy')">
        <t-icon name="copy" />
    </t-button>
    <t-button size="small" variant="outline" shape="round"
        @click.stop="handleAddToKnowledge(event)" :title="$t('agent.addToKnowledgeBase')">
        <t-icon name="add" />
    </t-button>
    <!-- âœ… æ–°å¢ï¼šå¯¼å‡ºæŒ‰é’® -->
    <ExportDropdown
        :content="getActualContent(event)"
        :filename-prefix="formatManualTitle(userQuery)"
    />
</div>

<script setup lang="ts">
// æ–°å¢ import
import ExportDropdown from './ExportDropdown.vue';
// ... ç°æœ‰ä»£ç ä¿æŒä¸å˜ ...
</script>
```

### 10.3 ExportDropdown.vue å®Œæ•´å®ç°

```vue
<template>
  <t-popup
    trigger="click"
    placement="bottom-left"
    :visible="menuVisible"
    @visible-change="handleVisibleChange"
    :overlay-style="{ padding: '4px 0', borderRadius: '8px' }"
    :destroy-on-close="true"
  >
    <t-button
      size="small"
      variant="outline"
      shape="round"
      :loading="exporting"
      :disabled="!content"
      :title="$t('export.title')"
      @click.stop="menuVisible = !menuVisible"
    >
      <t-icon name="download" />
    </t-button>
    <template #content>
      <div class="export-menu" @click.stop>
        <div
          v-for="format in exportFormats"
          :key="format.value"
          class="export-menu-item"
          @click="handleExport(format.value)"
        >
          <t-icon :name="format.icon" size="16px" />
          <span class="export-menu-label">{{ format.label }}</span>
        </div>
      </div>
    </template>
  </t-popup>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue';
import { useI18n } from 'vue-i18n';
import { MessagePlugin } from 'tdesign-vue-next';
import {
  exportAsMarkdown,
  exportAsPDF,
  exportAsWord,
  exportAsXLSX,
  generateFilename,
} from '@/utils/exportUtils';

interface Props {
  content: string;
  filenamePrefix?: string;
  disabled?: boolean;
}

const props = withDefaults(defineProps<Props>(), {
  filenamePrefix: '',
  disabled: false,
});

const { t } = useI18n();
const menuVisible = ref(false);
const exporting = ref(false);

const exportFormats = computed(() => [
  { value: 'pdf',      icon: 'file-pdf',   label: t('export.pdf') },
  { value: 'markdown', icon: 'file',        label: t('export.markdown') },
  { value: 'word',     icon: 'file-word',   label: t('export.word') },
  { value: 'xlsx',     icon: 'file-excel',  label: t('export.xlsx') },
]);

const handleVisibleChange = (visible: boolean) => {
  menuVisible.value = visible;
};

const handleExport = async (format: string) => {
  menuVisible.value = false;
  if (!props.content) {
    MessagePlugin.warning(t('export.emptyContent'));
    return;
  }

  exporting.value = true;
  try {
    const filename = generateFilename(props.filenamePrefix || undefined);
    switch (format) {
      case 'pdf':
        await exportAsPDF(props.content, filename);
        break;
      case 'markdown':
        exportAsMarkdown(props.content, filename);
        break;
      case 'word':
        await exportAsWord(props.content, filename);
        break;
      case 'xlsx':
        exportAsXLSX(props.content, filename);
        break;
    }
    MessagePlugin.success(t('export.success'));
  } catch (err) {
    console.error('Export failed:', err);
    MessagePlugin.error(t('export.failed'));
  } finally {
    exporting.value = false;
  }
};
</script>

<style lang="less" scoped>
.export-menu {
  padding: 4px 0;
  min-width: 160px;

  .export-menu-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 13px;
    color: #333;
    transition: background 0.2s;

    &:hover {
      background: #f2f3f5;
    }

    .export-menu-label {
      white-space: nowrap;
    }
  }
}
</style>
```

---

## 11. æ ·å¼è®¾è®¡

### 11.1 å¯¼å‡ºæŒ‰é’®

å¯¼å‡ºæŒ‰é’®ä¸ç°æœ‰å¤åˆ¶ã€æ·»åŠ æŒ‰é’®ä¿æŒå®Œå…¨ä¸€è‡´çš„è§†è§‰é£æ ¼ï¼š

```less
// æ— éœ€é¢å¤–æ ·å¼ â€”â€” ExportDropdown çš„è§¦å‘æŒ‰é’®ä½¿ç”¨ä¸å¤åˆ¶æŒ‰é’®ç›¸åŒçš„
// size="small" variant="outline" shape="round" å‚æ•°
// ç»§æ‰¿ answer-toolbar ä¸­ :deep(.t-button) çš„æ‰€æœ‰æ ·å¼
```

### 11.2 ä¸‹æ‹‰èœå•æ ·å¼

```less
.export-menu {
  padding: 4px 0;
  min-width: 160px;
  background: #ffffff;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);

  .export-menu-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 16px;
    cursor: pointer;
    font-size: 13px;
    color: #333;
    transition: background 0.2s ease;
    
    &:hover {
      background: #f2f3f5;
    }

    .t-icon {
      color: #666;
      flex-shrink: 0;
    }
  }
}
```

### 11.3 æš—è‰²æ¨¡å¼é€‚é…

è‹¥é¡¹ç›®åç»­æ”¯æŒæš—è‰²æ¨¡å¼ï¼Œéœ€è¡¥å……ï¼š

```less
@media (prefers-color-scheme: dark) {
  .export-menu {
    background: #2c2c2c;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);

    .export-menu-item {
      color: #e0e0e0;
      &:hover { background: #3a3a3a; }
      .t-icon { color: #aaa; }
    }
  }
}
```

---

## 12. æµ‹è¯•æ–¹æ¡ˆ

### 12.1 å•å…ƒæµ‹è¯•

| æµ‹è¯•æ¨¡å— | æµ‹è¯•ç”¨ä¾‹ | éªŒè¯ç‚¹ |
|---------|---------|--------|
| `exportUtils.ts` | `generateFilename()` | æ–‡ä»¶åæ ¼å¼æ­£ç¡®ã€åŒ…å«æ—¶é—´æˆ³ |
| `exportUtils.ts` | `exportAsMarkdown()` | ç”Ÿæˆçš„ Blob å†…å®¹ä¸è¾“å…¥ä¸€è‡´ï¼ŒMIME type æ­£ç¡® |
| `exportUtils.ts` | `extractTablesFromMarkdown()` | æ­£ç¡®è§£æå•è¡¨æ ¼ã€å¤šè¡¨æ ¼ã€æ— è¡¨æ ¼åœºæ™¯ |
| `exportUtils.ts` | `markdownToStyledHTML()` | HTML åŒ…å« `<style>` æ ‡ç­¾å’Œæ­£ç¡®çš„å†…å®¹ |

### 12.2 é›†æˆæµ‹è¯•

| åœºæ™¯ | æ“ä½œæ­¥éª¤ | é¢„æœŸç»“æœ |
|------|---------|---------|
| é Agent æ¨¡å¼å¯¼å‡º PDF | å‘é€é—®é¢˜ â†’ ç­‰å¾… AI å›ç­”å®Œæˆ â†’ ç‚¹å‡»å¯¼å‡º â†’ é€‰æ‹© PDF | æµè§ˆå™¨ä¸‹è½½ `.pdf` æ–‡ä»¶ï¼Œå†…å®¹æ’ç‰ˆæ­£ç¡® |
| Agent æ¨¡å¼å¯¼å‡º Markdown | Agent å›ç­”å®Œæˆ â†’ ç‚¹å‡»å¯¼å‡º â†’ é€‰æ‹© Markdown | ä¸‹è½½ `.md` æ–‡ä»¶ï¼Œå†…å®¹ä¸åŸå§‹å›ç­”ä¸€è‡´ |
| å«è¡¨æ ¼å†…å®¹å¯¼å‡º XLSX | AI å›ç­”åŒ…å« Markdown è¡¨æ ¼ â†’ å¯¼å‡º XLSX | è¡¨æ ¼æ•°æ®æ­£ç¡®åˆ†åˆ—åˆ†è¡Œ |
| æ— è¡¨æ ¼å†…å®¹å¯¼å‡º XLSX | AI å›ç­”çº¯æ–‡æœ¬ â†’ å¯¼å‡º XLSX | å•åˆ—æ–‡æœ¬å†…å®¹ |
| å¯¼å‡º Word | å›ç­”åŒ…å«æ ‡é¢˜/åˆ—è¡¨/ä»£ç  â†’ å¯¼å‡º Word | `.docx` æ–‡ä»¶å¯åœ¨ Word ä¸­æ­£å¸¸æ‰“å¼€ |
| ç©ºå†…å®¹ç¦ç”¨ | AI æ­£åœ¨ç”Ÿæˆä¸­ï¼ˆæœªå®Œæˆï¼‰| å¯¼å‡ºæŒ‰é’®ä¸æ˜¾ç¤ºæˆ–ä¸å¯ç‚¹å‡» |
| å¯¼å‡º loading çŠ¶æ€ | ç‚¹å‡»å¯¼å‡º â†’ ç”Ÿæˆä¸­ | æŒ‰é’®æ˜¾ç¤º loading åŠ¨ç”» |

### 12.3 è¾¹ç•Œåœºæ™¯

- **è¶…é•¿å†…å®¹**ï¼šå›ç­”è¶…è¿‡ 10000 å­—ç¬¦çš„ PDF åˆ†é¡µæµ‹è¯•
- **ç‰¹æ®Šå­—ç¬¦**ï¼šMarkdown ä¸­åŒ…å« HTML å®ä½“ã€LaTeX å…¬å¼ã€emoji
- **å¤šè¯­è¨€**ï¼šä¸­æ–‡/è‹±æ–‡/éŸ©æ–‡/ä¿„æ–‡å†…å®¹çš„å¯¼å‡ºç¼–ç æ­£ç¡®æ€§
- **ä»£ç å—**ï¼šå«å¤šç§ç¼–ç¨‹è¯­è¨€ä»£ç å—çš„ PDF/Word å¯¼å‡ºæ ·å¼
- **å›¾ç‰‡**ï¼šå« base64 æˆ–å¤–é“¾å›¾ç‰‡çš„å›ç­”å¯¼å‡ºï¼ˆPDF éœ€ç‰¹åˆ«å¤„ç†è·¨åŸŸï¼‰
- **å¹¶å‘å¯¼å‡º**ï¼šå¿«é€Ÿè¿ç»­ç‚¹å‡»ä¸åŒæ ¼å¼ï¼Œç¡®ä¿ä¸ä¼šå†²çª

---

## 13. æ€§èƒ½ä¸å®‰å…¨è€ƒé‡

### 13.1 æ€§èƒ½ä¼˜åŒ–

| ç­–ç•¥ | è¯´æ˜ |
|------|------|
| **åŠ¨æ€ import** | `html2pdf.js` (~400KB) å’Œ `html-docx-js-typescript` (~50KB) ä½¿ç”¨ `import()` æŒ‰éœ€åŠ è½½ï¼Œä¸å½±å“é¦–å± bundle |
| **SheetJS å¤ç”¨** | `xlsx` å·²åœ¨é¡¹ç›®ä¸­å®‰è£…ä½¿ç”¨ï¼Œæ— é¢å¤–åŒ…ä½“ç§¯ |
| **DOM ç¦»å±æ¸²æŸ“** | PDF å¯¼å‡ºåˆ›å»ºçš„ä¸´æ—¶å®¹å™¨ä½¿ç”¨ `position: absolute; left: -9999px` é¿å…å½±å“é¡µé¢é‡ç»˜ |
| **åŠæ—¶é‡Šæ”¾** | `URL.revokeObjectURL()` åŠæ—¶å›æ”¶ Blob URL å†…å­˜ |
| **loading çŠ¶æ€** | å¯¼å‡ºè¿‡ç¨‹ä¸­æ˜¾ç¤º loadingï¼Œé˜²æ­¢é‡å¤è§¦å‘ |

### 13.2 Bundle ä½“ç§¯å½±å“åˆ†æ

```
å½“å‰ bundle å¤§å°ï¼ˆä¼°ç®—ï¼‰:
  html2pdf.js (å« html2canvas + jsPDF): ~400KB gzipped ~130KB
  html-docx-js-typescript:               ~50KB  gzipped ~15KB
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ€»æ–°å¢:                                 ~450KB gzipped ~145KB

ç”±äºé‡‡ç”¨åŠ¨æ€ importï¼Œä»…åœ¨ç”¨æˆ·é¦–æ¬¡ç‚¹å‡»å¯¼å‡ºæ—¶åŠ è½½ï¼Œ
ä¸å½±å“é¦–å±åŠ è½½æ€§èƒ½å’Œä¸» bundle ä½“ç§¯ã€‚
```

### 13.3 å®‰å…¨è€ƒé‡

| é£é™© | é˜²æŠ¤æªæ–½ |
|------|---------|
| XSS æ³¨å…¥ | Markdown â†’ HTML è½¬æ¢åä½¿ç”¨ DOMPurify æ¸…ç†ï¼ˆå¤ç”¨ç°æœ‰å®ç°ï¼‰ |
| æ–‡ä»¶åæ³¨å…¥ | `generateFilename()` ä½¿ç”¨å›ºå®šå‰ç¼€ + æ—¶é—´æˆ³æ ¼å¼ï¼Œä¸å…è®¸ç”¨æˆ·è‡ªè¡Œè¾“å…¥æ–‡ä»¶å |
| å†…å­˜æ³„æ¼ | å¯¼å‡ºç»“æŸåç«‹å³ç§»é™¤ DOM ä¸´æ—¶å…ƒç´ å’Œé‡Šæ”¾ Blob URL |
| è·¨åŸŸå›¾ç‰‡ | `html2canvas` é…ç½® `useCORS: true`ï¼Œå¯¹æ— æ³•åŠ è½½çš„å¤–éƒ¨å›¾ç‰‡åš fallback |

---

## 14. å®æ–½è®¡åˆ’

### 14.1 å¼€å‘é˜¶æ®µ

| é˜¶æ®µ | ä»»åŠ¡ | é¢„ä¼°å·¥æœŸ | ä¼˜å…ˆçº§ |
|------|------|---------|--------|
| P1 | å®‰è£…ä¾èµ– + åˆ›å»º exportUtils.tsï¼ˆMarkdown å¯¼å‡ºï¼‰ | 0.5 å¤© | é«˜ |
| P2 | åˆ›å»º ExportDropdown.vue ç»„ä»¶ + é›†æˆåˆ° botmsg.vue | 0.5 å¤© | é«˜ |
| P3 | é›†æˆåˆ° AgentStreamDisplay.vue | 0.5 å¤© | é«˜ |
| P4 | å®ç° PDF å¯¼å‡º + ç±»å‹å£°æ˜ | 1 å¤© | é«˜ |
| P5 | å®ç° Word å¯¼å‡º | 0.5 å¤© | é«˜ |
| P6 | å®ç° XLSX å¯¼å‡ºï¼ˆè¡¨æ ¼è§£æï¼‰ | 0.5 å¤© | ä¸­ |
| P7 | æ·»åŠ  i18n ç¿»è¯‘ï¼ˆ4 ç§è¯­è¨€ï¼‰ | 0.5 å¤© | ä¸­ |
| P8 | æµ‹è¯• + ä¿®å¤ | 1 å¤© | é«˜ |
| **åˆè®¡** | | **5 å¤©** | |

### 14.2 é‡Œç¨‹ç¢‘

```
Day 1-2: åŸºç¡€æ¡†æ¶ + Markdown/PDF å¯¼å‡ºå¯ç”¨   â†’ å†…éƒ¨ Demo
Day 3:   Word/XLSX å¯¼å‡ºå®Œæˆ                 â†’ åŠŸèƒ½å®Œå¤‡
Day 4:   i18n + æ ·å¼è°ƒä¼˜                    â†’ ä½“éªŒä¼˜åŒ–
Day 5:   å…¨é‡æµ‹è¯• + Bug ä¿®å¤                â†’ ææµ‹
```

### 14.3 åç»­æ‰©å±•

- **æ‰¹é‡å¯¼å‡º**ï¼šæ”¯æŒé€‰æ‹©å¤šæ¡å¯¹è¯æ¶ˆæ¯åˆå¹¶å¯¼å‡º
- **è‡ªå®šä¹‰æ¨¡æ¿**ï¼šæ”¯æŒ PDF/Word å¯¼å‡ºæ—¶é€‰æ‹©é¢„è®¾æ¨¡æ¿æˆ–å“ç‰Œæ ·å¼
- **åç«¯å¯¼å‡º**ï¼šå¯¹äºè¶…å¤§å†…å®¹æˆ–éœ€è¦æœåŠ¡ç«¯æ¸²æŸ“çš„åœºæ™¯ï¼Œå¢åŠ åç«¯å¯¼å‡º API
- **å¯¼å‡ºå†å²**ï¼šè®°å½•ç”¨æˆ·çš„å¯¼å‡ºæ“ä½œï¼Œæ”¯æŒé‡æ–°ä¸‹è½½
- **æ›´å¤šæ ¼å¼**ï¼šHTMLã€çº¯æ–‡æœ¬ï¼ˆTXTï¼‰ã€RTF ç­‰

---

## é™„å½• Aï¼šTDesign å›¾æ ‡å‚è€ƒ

| ç”¨é€” | å›¾æ ‡åç§° | è¯´æ˜ |
|------|---------|------|
| å¯¼å‡ºè§¦å‘æŒ‰é’® | `download` | ä¸‹è½½å›¾æ ‡ |
| PDF æ ¼å¼ | `file-pdf` | PDF æ–‡ä»¶å›¾æ ‡ |
| Markdown æ ¼å¼ | `file` | é€šç”¨æ–‡ä»¶å›¾æ ‡ |
| Word æ ¼å¼ | `file-word` | Word æ–‡ä»¶å›¾æ ‡ |
| XLSX æ ¼å¼ | `file-excel` | Excel æ–‡ä»¶å›¾æ ‡ |

> æ³¨ï¼šå¦‚æœ TDesign å›¾æ ‡åº“ä¸­ç¼ºå°‘ `file-pdf`ã€`file-word`ã€`file-excel`ï¼Œå¯ä½¿ç”¨ `file-1`ã€`file-2` ç­‰é€šç”¨å›¾æ ‡ä»£æ›¿ï¼Œæˆ–é€šè¿‡è‡ªå®šä¹‰ SVG è¡¥å……ã€‚

## é™„å½• Bï¼šå¤‡é€‰ä¾èµ–æ–¹æ¡ˆ

è‹¥ä»¥ä¸Šæ¨èçš„ `html2pdf.js` æˆ– `html-docx-js-typescript` åœ¨å®é™…é›†æˆä¸­é‡åˆ°å…¼å®¹æ€§é—®é¢˜ï¼Œä»¥ä¸‹ä¸ºå¤‡é€‰æ–¹æ¡ˆï¼š

| æ ¼å¼ | æ¨èæ–¹æ¡ˆ | å¤‡é€‰æ–¹æ¡ˆ A | å¤‡é€‰æ–¹æ¡ˆ B |
|------|---------|-----------|-----------|
| PDF | `html2pdf.js` | `jsPDF` + `jspdf-autotable` (æ‰‹åŠ¨æ„å»º) | åç«¯ Puppeteer/wkhtmltopdf |
| Word | `html-docx-js-typescript` | `docx` npm åŒ…ï¼ˆç¼–ç¨‹å¼æ„å»ºï¼‰ | åç«¯ pandoc è½¬æ¢ |
| XLSX | `xlsx` (SheetJS) | `exceljs` | æ— éœ€å¤‡é€‰ï¼ŒSheetJS å·²ç»éå¸¸ç¨³å®š |

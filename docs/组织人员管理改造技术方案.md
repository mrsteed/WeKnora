# 组织人员管理改造技术方案

> 版本：v1.0  
> 日期：2026-02-11  
> 状态：草案

---

## 一、改造目标

| # | 目标 | 说明 |
|---|------|------|
| 1 | **系统管理 → 组织人员管理** | 前端菜单、路由、i18n 全面改名 |
| 2 | **注册制 → 创建制** | 取消/关闭公开注册入口，改由管理员在后台创建用户 |
| 3 | **先建组织，再建人员** | 在组织树节点下直接创建人员并指定角色，用户与组织绑定 |

---

## 二、现状分析

### 2.1 现有架构

```
┌─────────────────────────────────────────────────┐
│                   前端                            │
│  Login.vue (含注册表单) ──> POST /auth/register   │
│  AdminLayout.vue ("系统管理")                      │
│    ├─ OrgTreeManage.vue (组织管理)                 │
│    └─ MemberManage.vue (人员管理 → 搜索已有用户分配) │
└─────────────────────────────────────────────────┘
                      │
┌─────────────────────────────────────────────────┐
│                   后端                            │
│  AuthHandler.Register() → 自注册 + 自动创建租户    │
│  OrgTreeHandler.AssignUser() → 分配已注册用户到组织 │
│  无"后台创建用户"接口                              │
└─────────────────────────────────────────────────┘
                      │
┌─────────────────────────────────────────────────┐
│                  数据库                           │
│  users (is_super_admin, tenant_id)               │
│  organizations (parent_id, path, level, tenant_id)│
│  organization_members (org_id, user_id, role)    │
│  无独立 roles/permissions 表                      │
└─────────────────────────────────────────────────┘
```

### 2.2 当前用户创建流程

```
用户自行访问登录页 → 点击"注册" → 填写 username/email/password 
  → POST /api/v1/auth/register 
  → 后端创建 user + 自动创建 tenant（"{username}'s Workspace"）
  → 注册成功 → 回到登录页手动登录
```

### 2.3 当前用户-组织关联流程

```
超级管理员进入"系统管理" → "人员管理" → 选择组织 → 添加成员
  → 搜索已注册用户（GET /org-tree/search-users?q=xxx）
  → 选择目标用户 + 角色（admin/editor/viewer）
  → POST /org-tree/{orgId}/members
```

**核心问题**：用户必须先通过公开注册才存在于系统中，管理员才能将其分配到组织。无法做到"先建组织，再在组织下创建人员"。

---

## 三、整体设计

### 3.1 改造后架构

```
┌─────────────────────────────────────────────────────┐
│                     前端                              │
│  Login.vue (纯登录，移除注册入口)                       │
│  AdminLayout.vue ("组织人员管理")                       │
│    ├─ OrgTreeManage.vue (组织管理 — 不变)               │
│    └─ MemberManage.vue (人员管理 — 增强)                │
│         ├── 添加已有用户（保留现有搜索分配逻辑）           │
│         └── 创建新用户（新功能：在组织下直接建人）         │
│              └── CreateUserDialog.vue (新组件)          │
└─────────────────────────────────────────────────────┘
                        │
┌─────────────────────────────────────────────────────┐
│                     后端                              │
│  AuthHandler.Register() → 添加 disablePublic 参数      │
│  OrgTreeHandler.CreateUserInOrg() → 新接口              │
│  UserService.CreateUserByAdmin() → 新方法               │
└─────────────────────────────────────────────────────┘
```

### 3.2 目标用户创建流程

```
超级管理员进入"组织人员管理" → "人员管理" → 选择组织 → "创建用户"
  → 填写 username/email/password/role
  → POST /api/v1/org-tree/{orgId}/create-user
  → 后端：创建 user（绑定同一 tenant）→ 创建 organization_member
  → 用户即刻可用：用分配的邮箱和密码登录
```

---

## 四、详细设计

### 4.1 模块一：重命名「系统管理」→「组织人员管理」

#### 4.1.1 涉及文件与修改项

| 文件 | 修改 |
|------|------|
| `frontend/src/i18n/locales/zh-CN.ts` | `menu.admin`: `"系统管理"` → `"组织人员管理"` |
| `frontend/src/i18n/locales/zh-CN.ts` | `admin.title`: `"系统管理"` → `"组织人员管理"` |
| `frontend/src/i18n/locales/en-US.ts` | `menu.admin`: `"Admin"` → `"Org & Member Management"` |
| `frontend/src/i18n/locales/en-US.ts` | `admin.title`: `"Admin"` → `"Org & Member Management"` |

**改动量**：4 处字符串替换，无逻辑变更。

---

### 4.2 模块二：关闭公开注册

#### 4.2.1 前端：移除注册入口

**文件**：`frontend/src/views/auth/Login.vue`

| 修改项 | 说明 |
|--------|------|
| 移除/隐藏注册表单切换链接 | 删除"没有账号？立即注册"的入口 |
| 移除注册表单部分 | 删除 `isRegisterMode` 相关的注册表单 HTML 和 JS |
| 保留登录逻辑不变 | |

> **可选保留策略**：不删除注册代码，仅在 UI 上隐藏入口，通过环境变量 `VITE_DISABLE_REGISTRATION=true` 控制显隐。这样可以在需要时恢复。

#### 4.2.2 后端：加强注册接口管控

**文件**：`internal/handler/auth.go` — `Register()` 方法

当前已有 `DISABLE_REGISTRATION` 环境变量检查，方案如下：

| 策略 | 做法 |
|------|------|
| **方案 A：默认关闭** | 将 `DISABLE_REGISTRATION` 默认值改为 `"true"`，管理员需显式设为 `"false"` 才能开放注册 |
| **方案 B：完全移除路由** | 从 `router.go` 中注释/删除 `POST /auth/register` 路由 |
| **方案 C（推荐）：保留接口但默认禁用** | `config.yaml` 新增 `auth.disable_public_registration: true`，Register handler 检查此配置 |

**推荐方案 C**，改动最小且可配置：

```go
// auth.go Register() 方法开头添加
if cfg.Auth.DisablePublicRegistration {
    c.Error(apperrors.NewForbiddenError("Public registration is disabled"))
    return
}
```

```yaml
# config.yaml
auth:
  disable_public_registration: true
```

---

### 4.3 模块三：在组织下创建用户

这是本方案的核心模块。

#### 4.3.1 新增 API 接口

| 方法 | 路径 | 说明 |
|------|------|------|
| `POST` | `/api/v1/org-tree/{id}/create-user` | 在指定组织下创建新用户并自动加为成员 |

**请求体**：

```json
{
  "username": "zhangsan",
  "email": "zhangsan@company.com",
  "phone": "13800138000",
  "password": "P@ssw0rd123",
  "role": "editor",
  "is_admin": false
}
```

> `email` 和 `phone` 至少提供一个。提供了哪个，用户就用哪个作为登录凭证。
```

**响应体**（201）：

```json
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid",
      "username": "zhangsan",
      "email": "zhangsan@company.com",
      "is_active": true,
      "tenant_id": 10000,
      "created_at": "..."
    },
    "member": {
      "organization_id": "org-uuid",
      "user_id": "uuid",
      "role": "editor",
      "is_admin": false
    }
  }
}
```

#### 4.3.2 后端实现

##### 4.3.2.1 类型定义

**文件**：`internal/types/user.go`

新增请求类型：

```go
// CreateUserInOrgRequest is the request for admin to create a user within an organization
type CreateUserInOrgRequest struct {
    Username string `json:"username" binding:"required,min=2,max=100"`
    Email    string `json:"email"`
    Phone    string `json:"phone"`
    Password string `json:"password" binding:"required,min=8,max=128"`
    Role     string `json:"role" binding:"required,oneof=admin editor viewer"`
    IsAdmin  bool   `json:"is_admin"`
}
// 校验逻辑：email 和 phone 至少提供一个
```

新增响应类型：

```go
type CreateUserInOrgResponse struct {
    User   *UserInfo            `json:"user"`
    Member *OrganizationMember  `json:"member"`
}
```

##### 4.3.2.2 Handler 层

**文件**：`internal/handler/org_tree.go`

新增 `CreateUserInOrg` 方法：

```go
func (h *OrgTreeHandler) CreateUserInOrg(c *gin.Context) {
    ctx := c.Request.Context()
    orgID := c.Param("id")
    tenantID := c.GetUint64(types.TenantIDContextKey.String())

    var req types.CreateUserInOrgRequest
    if err := c.ShouldBindJSON(&req); err != nil {
        c.Error(apperrors.NewBadRequestError("Invalid request").WithDetails(err.Error()))
        return
    }

    // 1. 验证组织存在且属于当前 tenant
    // 2. 调用 service 层创建用户并加入组织
    // 3. 返回创建结果
}
```

##### 4.3.2.3 Service 层

**文件**：`internal/application/service/user.go`

新增 `CreateUserByAdmin` 方法：

```go
func (s *userService) CreateUserByAdmin(ctx context.Context, req *types.CreateUserInOrgRequest, tenantID uint64) (*types.User, error) {
    // 1. 检查 username 唯一性
    // 2. 检查 email 唯一性
    // 3. 密码哈希
    // 4. 创建 user 记录（tenant_id = 管理员的 tenantID，不再自动创建新 tenant）
    // 5. 返回 user 对象
}
```

**关键区别**：与现有 `Register()` 方法不同，`CreateUserByAdmin` **不创建新 tenant**，而是将新用户绑定到管理员所在的 tenant。

**文件**：`internal/application/service/org_tree.go`

新增 `CreateUserInOrg` 方法（编排层）：

```go
func (s *orgTreeService) CreateUserInOrg(ctx context.Context, orgID string, tenantID uint64, req *types.CreateUserInOrgRequest) (*types.CreateUserInOrgResponse, error) {
    // 1. 验证组织存在且属于 tenant
    org, err := s.orgTreeRepo.GetByIDAndTenant(ctx, orgID, tenantID)
    
    // 2. 调用 userService 创建用户
    user, err := s.userService.CreateUserByAdmin(ctx, req, tenantID)
    
    // 3. 将用户加入组织
    member, err := s.orgRepo.AddMember(ctx, orgID, user.ID, tenantID, types.OrgMemberRole(req.Role))
    
    // 4. 如果指定了 is_admin，设置组织管理员
    if req.IsAdmin {
        s.orgRepo.UpdateMemberRole(ctx, orgID, user.ID, "admin")
    }
    
    return &types.CreateUserInOrgResponse{User: user.ToUserInfo(), Member: member}, nil
}
```

##### 4.3.2.4 路由注册

**文件**：`internal/router/router.go`

在 `RegisterOrgTreeRoutes` 函数的 `orgTree` 路由组中添加：

```go
// Create a new user within an organization
orgTree.POST("/:id/create-user", orgTreeHandler.CreateUserInOrg)
```

#### 4.3.3 前端实现

##### 4.3.3.1 新增 API 函数

**文件**：`frontend/src/api/org-tree/index.ts`

```typescript
export interface CreateUserInOrgRequest {
  username: string
  email: string
  password: string
  role: 'admin' | 'editor' | 'viewer'
  is_admin?: boolean
}

export interface CreateUserInOrgResponse {
  user: {
    id: string
    username: string
    email: string
    is_active: boolean
    tenant_id: number
    created_at: string
  }
  member: OrgMember
}

export async function createUserInOrg(
  orgId: string, 
  data: CreateUserInOrgRequest
): Promise<ApiResponse<CreateUserInOrgResponse>> {
  try {
    return await post(`/api/v1/org-tree/${orgId}/create-user`, data) as unknown as ApiResponse<CreateUserInOrgResponse>
  } catch (error: any) {
    return { success: false, message: error.message || 'Failed to create user' }
  }
}
```

##### 4.3.3.2 新增组件 CreateUserDialog.vue

**文件**：`frontend/src/views/admin/components/CreateUserDialog.vue`

功能要求：
- 弹窗表单，包含字段：用户名、邮箱（可选）、手机号（可选，至少填一个）、密码、确认密码、角色选择
- 角色下拉选项：`admin`（管理员）/ `editor`（编辑）/ `viewer`（只读）
- 密码强度校验：8 位以上，含字母和数字
- 邮箱格式校验
- 用户名校验：2-20 字符，字母/数字/下划线/中文
- 提交后调用 `createUserInOrg(orgId, data)`
- 成功后 emit `success` 事件刷新成员列表
- 可选：显示临时密码复制按钮

```vue
<template>
  <t-dialog
    :visible="visible"
    :header="$t('admin.member.createUser')"
    @update:visible="$emit('update:visible', $event)"
    @confirm="handleSubmit"
    :confirm-btn="{ loading: submitting }"
  >
    <t-form ref="formRef" :data="formData" :rules="formRules">
      <t-form-item :label="$t('admin.member.username')" name="username">
        <t-input v-model="formData.username" />
      </t-form-item>
      <t-form-item :label="$t('admin.member.email')" name="email">
        <t-input v-model="formData.email" />
      </t-form-item>
      <t-form-item :label="$t('admin.member.password')" name="password">
        <t-input v-model="formData.password" type="password" />
      </t-form-item>
      <t-form-item :label="$t('admin.member.confirmPassword')" name="confirmPassword">
        <t-input v-model="formData.confirmPassword" type="password" />
      </t-form-item>
      <t-form-item :label="$t('admin.member.role')" name="role">
        <t-select v-model="formData.role">
          <t-option value="viewer" :label="$t('admin.member.roleViewer')" />
          <t-option value="editor" :label="$t('admin.member.roleEditor')" />
          <t-option value="admin" :label="$t('admin.member.roleAdmin')" />
        </t-select>
      </t-form-item>
    </t-form>
  </t-dialog>
</template>
```

##### 4.3.3.3 修改 MemberTable.vue

**文件**：`frontend/src/views/admin/components/MemberTable.vue`

在现有的"添加成员"按钮旁边，新增"创建用户"按钮：

```vue
<!-- 现有按钮 -->
<t-button @click="showAssignDialog = true">
  {{ $t('admin.member.addMember') }}
</t-button>

<!-- 新增按钮 -->
<t-button theme="primary" @click="showCreateUserDialog = true">
  {{ $t('admin.member.createUser') }}
</t-button>
```

引入 `CreateUserDialog` 组件并处理成功事件。

##### 4.3.3.4 i18n 新增翻译条目

**中文** (`zh-CN.ts`)：

```typescript
admin: {
  // 已有 key 改名
  title: '组织人员管理',   // 原 '系统管理'
  
  member: {
    // 新增
    createUser: '创建用户',
    username: '用户名',
    email: '邮箱',
    password: '密码',
    confirmPassword: '确认密码',
    role: '角色',
    createUserSuccess: '用户创建成功',
    createUserFailed: '用户创建失败',
    passwordMismatch: '两次密码输入不一致',
    passwordTooWeak: '密码至少8位，需包含字母和数字',
    usernameInvalid: '用户名只能包含字母、数字、下划线和中文，长度2-20位',
    emailInvalid: '请输入有效的邮箱地址',
    // 已有 key 保留
    ...
  }
}
```

**菜单**

```typescript
menu: {
  admin: '组织人员管理',  // 原 '系统管理'
}
```

**英文** (`en-US.ts`) 同步添加对应翻译。

---

## 五、数据库变更

### 5.1 数据库变更

需要为 `users` 表新增 `phone` 字段：

```sql
-- 000014_add_user_phone.up.sql
ALTER TABLE users ADD COLUMN phone VARCHAR(20);
CREATE UNIQUE INDEX idx_users_phone ON users(phone) WHERE phone IS NOT NULL AND phone != '' AND deleted_at IS NULL;
```

其余表结构满足需求，原因：

| 需求 | 现有支撑 |
|------|----------|
| 用户存储 | `users` 表，`tenant_id` 字段指向管理员所在 tenant |
| 用户-组织关联 | `organization_members` 表 |
| 角色 | `organization_members.role`（admin/editor/viewer） |
| 组织树 | `organizations` 表的 `parent_id` / `path` / `level` |

### 5.2 数据迁移考虑

如果系统中已有通过自注册创建的用户，改造后无需做数据迁移。这些用户仍然可以正常登录使用。管理员可以将他们分配到组织中。

---

## 六、安全设计

### 6.1 权限控制

| 操作 | 权限要求 |
|------|----------|
| 创建用户 | 超级管理员（`RequireSuperAdmin` 中间件） |
| 关闭公开注册 | 配置项 `auth.disable_public_registration` |
| 新用户登录 | 标准认证流程（邮箱 + 密码） |

### 6.2 密码安全

- 管理员设置的初始密码同样经过 bcrypt 哈希存储
- **建议**：后续迭代添加"首次登录强制修改密码"功能（本次不实现）
- 密码复杂度校验与现有注册逻辑一致：8 位以上，含字母和数字

### 6.3 租户隔离

新创建的用户与管理员共享同一 `tenant_id`：
- 超管通过 `org-tree` 路由创建用户 → 用户的 `tenant_id` = 超管的 `tenant_id`
- 保证同一租户内的数据可见性规则不变

---

## 七、接口变更汇总

| 类型 | 接口 | 变更 |
|------|------|------|
| **新增** | `POST /api/v1/org-tree/{id}/create-user` | 在组织下创建新用户 |
| **修改** | `POST /api/v1/auth/register` | 默认禁用（配置控制） |
| 不变 | `POST /api/v1/org-tree/{id}/members` | 保留分配已有用户到组织 |
| 不变 | `GET /api/v1/org-tree/search-users` | 保留搜索已有用户 |

---

## 八、前端文件变更汇总

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `frontend/src/i18n/locales/zh-CN.ts` | 修改 | menu.admin → "组织人员管理"，新增 createUser 相关 key |
| `frontend/src/i18n/locales/en-US.ts` | 修改 | 同步英文翻译 |
| `frontend/src/views/auth/Login.vue` | 修改 | 隐藏注册入口（条件控制） |
| `frontend/src/api/org-tree/index.ts` | 修改 | 新增 `createUserInOrg` API 函数和类型 |
| `frontend/src/views/admin/components/CreateUserDialog.vue` | **新增** | 创建用户弹窗组件 |
| `frontend/src/views/admin/components/MemberTable.vue` | 修改 | 添加"创建用户"按钮 |

---

## 九、后端文件变更汇总

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `internal/types/user.go` | 修改 | 新增 `CreateUserInOrgRequest` / `CreateUserInOrgResponse` |
| `internal/handler/org_tree.go` | 修改 | 新增 `CreateUserInOrg` handler |
| `internal/application/service/user.go` | 修改 | 新增 `CreateUserByAdmin` 方法 |
| `internal/application/service/org_tree.go` | 修改 | 新增 `CreateUserInOrg` 编排方法 |
| `internal/types/interfaces/org_tree.go` | 修改 | 接口新增 `CreateUserInOrg` |
| `internal/router/router.go` | 修改 | 注册新路由 |
| `internal/config/config.go`（如有）| 修改 | 新增 `auth.disable_public_registration` 配置项 |
| `config/config.yaml` | 修改 | 新增配置默认值 |

---

## 十、实施计划

### 阶段一：重命名 + 关闭注册（低风险，可快速上线）

| 步骤 | 任务 | 预估工时 |
|------|------|----------|
| 1 | i18n 改名（4 处字符串替换） | 0.5h |
| 2 | Login.vue 隐藏注册入口 | 0.5h |
| 3 | 后端增加 `disable_public_registration` 配置，Register handler 检查 | 1h |
| 4 | 测试验证 | 1h |
| **小计** | | **3h** |

### 阶段二：组织下创建用户（核心功能）

| 步骤 | 任务 | 预估工时 |
|------|------|----------|
| 1 | 类型定义（request/response） | 0.5h |
| 2 | UserService.CreateUserByAdmin | 1.5h |
| 3 | OrgTreeService.CreateUserInOrg | 1h |
| 4 | OrgTreeHandler.CreateUserInOrg + 路由注册 | 1h |
| 5 | 前端 API 函数 | 0.5h |
| 6 | CreateUserDialog.vue 组件 | 2h |
| 7 | MemberTable.vue 集成 | 1h |
| 8 | i18n 补充翻译 | 0.5h |
| 9 | 端到端测试 | 2h |
| **小计** | | **10h** |

### 阶段三（未来迭代）

| 功能 | 说明 |
|------|------|
| 首次登录强制改密 | `users` 表增加 `must_change_password` 字段 |
| 批量导入用户 | 上传 CSV/Excel，解析后批量创建 |
| 用户启用/停用 | 利用现有 `is_active` 字段 |
| 组织管理员创建用户 | 将创建权限下放到组织管理员（当前仅超管可用） |

---

## 十一、流程图

### 11.1 改造后的用户创建流程

```
超级管理员
    │
    ▼
登录系统 → 进入"组织人员管理"
    │
    ├──▶ 组织管理：创建/编辑组织树节点
    │
    └──▶ 人员管理：选择组织
              │
              ├──▶ "添加成员"   → 搜索已有用户 → 分配到组织（已有功能）
              │
              └──▶ "创建用户" → 填写用户信息 + 选角色
                              → POST /org-tree/{orgId}/create-user
                              → 创建 user + 加入 organization_members
                              → 完成！新用户可立即登录
```

### 11.2 新用户登录流程

```
新用户
    │
    ▼
访问登录页（无注册入口）
    │
    ▼
输入管理员分配的邮箱或手机号 + 密码
    │
    ▼
POST /auth/login → 正常 JWT 认证
    │
    ▼
进入系统（知识库列表页）
    │
    ▼
已自动属于管理员分配的组织，可看到组织可见的知识库
```

---

## 十二、风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 关闭注册后无法创建首个超管 | 系统无法初始化 | 保留环境变量 `DISABLE_REGISTRATION` 作为后门，或提供 CLI 命令创建初始超管 |
| 创建用户不创建 tenant | 新用户无独立工作空间 | 设计上新用户共享管理员 tenant，这正是组织统一管理的预期行为 |
| 密码明文传输 | 安全风险 | HTTPS 强制（已有），前端不存储密码，创建完成后仅显示一次 |
| 组织删除时关联用户处理 | 用户失去组织归属 | 组织删除时 `organization_members` 级联删除（已有 FK），用户本身保留 |

---

## 十三、兼容性说明

| 场景 | 处理方式 |
|------|----------|
| 已注册的存量用户 | 不受影响，正常登录使用 |
| 存量用户未在任何组织中 | 超管可以通过"添加成员"将其分配到组织 |
| 配置开关切换 | `disable_public_registration` 可随时切换，开启后恢复公开注册 |
| 多租户环境 | 创建用户绑定超管的 tenant_id，保持租户隔离 |

---

## 附录 A：关键现有代码引用

| 模块 | 文件路径 | 说明 |
|------|----------|------|
| 用户模型 | `internal/types/user.go:10-42` | User struct |
| 注册 Handler | `internal/handler/auth.go:52-101` | Register() |
| 注册 Service | `internal/application/service/user.go:68-120` | Register() |
| 组织树 Handler | `internal/handler/org_tree.go` | 全部 |
| 组织树 Service | `internal/application/service/org_tree.go` | 全部 |
| 路由注册 | `internal/router/router.go:566-594` | RegisterOrgTreeRoutes |
| 超管中间件 | `internal/middleware/super_admin.go:13-44` | RequireSuperAdmin |
| 前端登录页 | `frontend/src/views/auth/Login.vue` | 含注册表单 |
| 前端管理布局 | `frontend/src/views/admin/AdminLayout.vue` | 侧栏导航 |
| 前端成员表格 | `frontend/src/views/admin/components/MemberTable.vue` | 成员列表 |
| 前端分配弹窗 | `frontend/src/views/admin/components/AssignOrgDialog.vue` | 搜索分配 |
| Auth Store | `frontend/src/stores/auth.ts` | 认证状态管理 |
| Org Store | `frontend/src/stores/organization.ts` | 组织状态管理 |
| OrgTree API | `frontend/src/api/org-tree/index.ts` | 组织树 API |
| 中文 i18n | `frontend/src/i18n/locales/zh-CN.ts` | 全部翻译 |
| 英文 i18n | `frontend/src/i18n/locales/en-US.ts` | 全部翻译 |

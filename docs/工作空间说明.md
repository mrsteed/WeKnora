# 工作空间（共享空间）说明文档

本文档说明 WeKnora 中的**工作空间**（产品中又称「共享空间」）功能，包括空间创建与加入、成员角色与权限、知识库共享规则，以及用户对知识库的最终访问权限计算方式。

---

## 一、工作空间概述

### 1.1 什么是工作空间

工作空间（Organization）是跨租户协作的载体。用户可以在同一系统内属于不同租户（账户），通过**加入同一工作空间**，实现：

- 共享知识库：将本租户的知识库共享到空间，供空间内其他成员使用；
- 访问他人共享的知识库：在「知识库列表」中看到并打开通过空间共享给自己的知识库；
- 在对话、智能体等场景中选择并使用这些共享知识库。

数据与权限关系简要如下：

- **租户**：知识库的归属单位，每个知识库属于一个租户；
- **工作空间**：不拥有知识库，只记录「某知识库被共享到某空间」以及「共享时的权限」；
- **成员**：用户通过邀请码或管理员邀请加入空间，在空间内拥有一个角色（管理员 / 编辑者 / 只读）。

### 1.2 核心概念对照

| 概念 | 说明 |
|------|------|
| 工作空间 / 共享空间 | 同一产品中的「组织」（Organization），用于跨租户共享知识库 |
| 空间创建者 | 创建该空间的用户，自动成为该空间的管理员，且不可被移除或降级 |
| 空间成员 | 通过邀请码加入或由管理员邀请加入的用户，拥有管理员、编辑者或只读之一角色 |
| 知识库归属 | 知识库始终属于一个租户；共享到空间不改变归属，只建立「空间 ↔ 知识库」的共享关系 |
| 共享关系 | 一条记录表示：某知识库以某种权限（只读/可写）被共享到某工作空间 |

---

## 二、工作空间的创建、加入与离开

### 2.1 创建空间

- 任意已登录用户均可创建空间。
- 创建时需填写空间名称；描述、头像、邀请码有效期等为可选项。
- 创建者自动成为该空间的**管理员**，且：
  - 不能将自己移出空间；
  - 不能将自己的角色改为编辑者或只读。

### 2.2 加入空间

加入方式有两种：

1. **邀请码直接加入**
   - 若空间未开启「加入需审批」，用户输入有效邀请码即可加入。
   - 加入后默认角色为**只读**。
2. **提交加入申请（需审批）**
   - 若空间开启了「加入需审批」，用户输入邀请码后提交加入申请。
   - 空间管理员审批通过时可指定角色（管理员/编辑者/只读）；若不指定，则使用申请时填写的角色或默认只读。
   - 审批拒绝后，用户不是成员，无法访问该空间及其共享知识库。

### 2.3 邀请码

- 仅空间**管理员**可生成或刷新邀请码。
- 邀请码可设置有效期（例如 1 天、7 天、30 天或永不过期）；过期后需重新生成才能使用。
- 同一时间一个空间仅有一个有效邀请码；重新生成会使旧邀请码失效。

### 2.4 离开空间

- 成员可主动退出空间（无需管理员同意）。
- 管理员可移除其他成员（不能移除空间创建者）。
- 退出或移除后，该用户不再拥有该空间内的任何角色，也无法再通过该空间访问其共享的知识库。

### 2.5 删除空间

- 仅空间**创建者**可删除空间。
- 删除空间时会解除该空间下所有知识库的共享关系，成员将无法再通过该空间访问这些知识库。

---

## 三、空间内角色与权限

工作空间内共有三种角色，权限从高到低为：**管理员 > 编辑者 > 只读**。

### 3.1 角色定义

| 角色 | 英文标识 | 说明 |
|------|----------|------|
| 管理员 | admin | 空间设置、成员、邀请码及知识库共享的全面管理 |
| 编辑者 | editor | 可编辑空间内共享的知识库内容，可将自己的知识库共享到空间；不可管理空间设置与成员 |
| 只读 | viewer | 仅可查看与检索空间内共享的知识库；不可共享知识库到空间，不可管理空间 |

### 3.2 权限矩阵（空间内能力）

| 能力 | 管理员 | 编辑者 | 只读 |
|------|--------|--------|------|
| 查看、检索空间内共享的知识库 | ✓ | ✓ | ✓ |
| 编辑空间内共享的知识库内容 | ✓ | ✓ | ✗ |
| **将知识库共享到本空间** | ✓ | ✓ | ✗ |
| 管理空间内知识库共享（取消共享、修改共享权限等） | ✓（见下） | 仅限自己发起的共享 | ✗ |
| 管理空间设置（名称、描述、头像、邀请码有效期、是否需审批等） | ✓ | ✗ | ✗ |
| 管理成员（邀请、移除、修改角色） | ✓ | ✗ | ✗ |
| 生成/刷新邀请码 | ✓ | ✗ | ✗ |
| 审批加入申请、权限升级申请 | ✓ | ✗ | ✗ |
| 提交权限升级申请 | — | ✓ | ✓ |
| 退出空间 | ✓ | ✓ | ✓ |

说明：

- **「将知识库共享到本空间」**：仅**管理员**和**编辑者**可以执行；只读成员不能把自己的知识库共享到该空间。
- **管理空间内知识库共享**：
  - 共享的发起人可取消自己发起的共享、修改该条共享的权限；
  - 空间**管理员**可取消任意一条指向本空间的共享（例如内容治理、发起人已离开等）。

---

## 四、知识库共享规则

### 4.1 谁可以发起共享

- 只有**知识库所属租户下的用户**（即「拥有」该知识库的账户下的用户）才能将该知识库共享到某个工作空间。
- 同时，该用户必须是目标工作空间的**成员**，且角色为**管理员**或**编辑者**。  
  即：**只读成员不能把任何知识库（包括自己的）共享到该空间。**

### 4.2 共享时的权限设置

将知识库共享到空间时，需为「该空间」指定一个**共享权限**：

- **只读（viewer）**：空间成员在该知识库上最多只读（实际权限还会受成员在空间内的角色限制，见下）。
- **可写（editor）**：空间成员在该知识库上可被赋予编辑能力（同样受成员角色限制）。

同一知识库可以共享到多个工作空间，且每个空间可以设置不同的共享权限（例如空间 A 只读、空间 B 可写）。

### 4.3 更新与取消共享

- **修改某条共享的权限**：仅**发起该次共享的用户**可以修改（只读 ↔ 可写）。
- **取消某条共享**：
  - **发起该次共享的用户**可随时取消；
  - 目标空间的**管理员**也可取消该空间下的任意共享（包括他人发起的）。

### 4.4 同一知识库共享到多个空间

- 允许将同一知识库共享到多个工作空间。
- 每个空间一条共享记录，各自独立配置权限（只读/可写）。
- 例如：知识库 K 共享到空间 A（只读）、空间 B（可写），互不影响。

---

## 五、用户对知识库的最终访问权限

用户对某个知识库的访问可能来自两种途径，最终权限取「最宽」的一种。

### 5.1 两种访问来源

1. **本租户拥有**  
   知识库属于用户当前所在租户 → 用户对该知识库拥有**完整权限**（创建者/管理端意义上的「所有者」权限：可编辑、管理设置、删除知识库等），无需也不依赖工作空间。
2. **通过工作空间共享获得**  
   知识库不属于当前租户，但被共享到了用户所在的至少一个工作空间 → 用户通过「成员身份 + 共享设置」得到**受限权限**（见下）。

若同时满足 1 和 2（例如先通过空间访问，后来切换到知识库所属租户），系统按「本租户拥有」处理，即完整权限。

### 5.2 单条共享下的「有效权限」

对**某一条**「知识库 ↔ 空间」的共享而言，用户在该空间内对这份知识库的权限为：

- **有效权限 = min( 该条共享的权限, 用户在该空间内的角色 )**

即：取「共享给空间的权限」与「用户在空间内的角色」中**更严格**的一档。

- 共享权限与角色均按：**只读(viewer) < 编辑(editor) < 管理员(admin)** 比较。
- 例如：
  - 共享为「可写」，用户在空间内是「只读」→ 有效权限为**只读**；
  - 共享为「只读」，用户在空间内是「编辑者」→ 有效权限为**只读**；
  - 共享为「可写」，用户在空间内是「编辑者」→ 有效权限为**可写**。

### 5.3 同一用户通过多个空间访问同一知识库（取高）

若用户加入了多个工作空间，且同一知识库被共享到了其中多个空间（可能权限不同），则：

- 先按 5.2 对每个空间分别算出一条「有效权限」；
- 用户对该知识库的**最终权限** = 这些有效权限中的**最高**一档（不取低、不取交集）。

示例：

- 知识库 K 共享到空间 A（只读）、空间 B（可写）；
- 用户同时是 A、B 的成员，在 A、B 内都是编辑者；
- 通过 A 的有效权限 = 只读，通过 B 的有效权限 = 可写；
- 最终用户对 K 的权限 = **可写**。

这样设计可以避免：用户因同时在一个「只读共享」的空间里而被整体降级为只读。

### 5.4 权限层级与可执行操作

| 最终权限 | 可执行操作 |
|----------|------------|
| 本租户拥有 | 完整管理：编辑内容、修改知识库设置、删除知识库、管理共享到哪些空间等 |
| 通过共享获得 · 管理员/编辑 | 在共享范围内：编辑知识库内容（文档/FAQ 等）、检索与问答 |
| 通过共享获得 · 只读 | 仅查看与检索、在对话/智能体中使用该知识库进行问答，不可修改内容 |

（具体接口层是否区分「编辑」与「只读」以该最终权限为准。）

---

## 六、典型场景小结

| 场景 | 结果 |
|------|------|
| 用户是空间内只读成员 | 不能把任何知识库共享到该空间；只能查看/检索该空间内已共享的知识库，且每条共享的有效权限不会超过「只读」 |
| 用户是空间内编辑者 | 可把自己的知识库共享到该空间（可设只读或可写）；可编辑空间内已共享的知识库内容（在共享权限允许的前提下）；不可管理空间设置与成员 |
| 用户是空间内管理员 | 除编辑者能力外，还可管理空间设置、成员、邀请码、审批加入/升级，以及取消空间内任意知识库共享 |
| 同一知识库共享到多空间且权限不同，用户同属多空间 | 用户对该知识库的最终权限 = 各空间有效权限中的**最高**一档 |
| 用户退出或被移出空间 | 立即失去通过该空间访问任何共享知识库的权限 |

---

## 七、与产品术语的对应

- 产品中的「共享空间」= 本文的「工作空间」= 系统中的 Organization。
- 产品中的「创建者」= 空间创建者 = 自动拥有管理员角色且不可被降级或移出的成员。
- 知识库「共享到空间」= 建立一条 KnowledgeBaseShare 记录，并指定该空间下的共享权限（只读/可写）。
- 成员在空间内的「权限说明」中「共享知识库到空间」一项：仅管理员和编辑者具备，只读不具备；与本文第四节、第五节规则一致。

---

## 八、附录：权限判定流程（实现参考）

以下为后端逻辑的简要归纳，便于与实现对照：

1. **判断是否本租户知识库**  
   若 `knowledge_base.tenant_id == current_user.tenant_id` → 直接视为完整权限，不再查共享。

2. **收集所有「该知识库 → 某空间」的共享**  
   查出所有 `kb_id = 该知识库` 的共享记录。

3. **对每条共享**  
   - 若用户不是该空间的成员 → 跳过；
   - 否则：`effective = min(share.permission, user_role_in_org)`（按 admin > editor > viewer 比较取低）。

4. **合并多条有效权限**  
   最终权限 = 所有 `effective` 中的最大值（即取高）。

5. **共享到空间的操作权限**  
   - 发起共享：用户须为空间成员且角色为 admin 或 editor；
   - 取消/修改共享：发起人可操作自己的共享；空间管理员可取消任意指向本空间的共享。

以上规则与 `internal/application/service/kbshare.go` 及 `organization.go` 中的实现一致。产品界面（如成员列表中的「权限说明」、共享知识库时的空间筛选）已按相同规则做了展示与限制。

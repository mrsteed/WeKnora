# 智能体可见性扩展方案

**创建日期**: 2026-02-11  
**目标**: 为智能体（Agent）添加与知识库相同的三级可见性控制（全局/组织/私有）

---

## 1. 需求说明

当前智能体没有可见性控制，所有智能体对租户内所有用户可见。  
需要参照知识库的可见性模型，为智能体添加 `visibility` + `organization_id` 字段，实现：

| 可见性 | 标识 | 可见范围 |
|--------|------|----------|
| **全局可见** | `global` | 租户内所有用户 |
| **组织内可见** | `org` | 归属组织及其祖先/后代组织的成员 |
| **个人私有** | `private` | 仅创建者本人（默认） |

超级管理员始终可见所有智能体。

---

## 2. 当前代码分析

### 2.1 数据结构

**`internal/types/custom_agent.go`** — `CustomAgent` struct：
- 有 `CreatedBy` 字段，但创建时**未赋值**
- **缺少** `Visibility` 字段
- **缺少** `OrganizationID` 字段

### 2.2 Repository 层

**`internal/application/repository/custom_agent.go`**：
- `ListAgentsByTenantID` 仅按 `tenant_id` 过滤，无可见性过滤
- **缺少** `ListAccessibleAgents` 方法

### 2.3 Service 层

**`internal/application/service/custom_agent.go`**：
- `CreateAgent` 未设置 `CreatedBy`
- `ListAgents` 返回租户下全部智能体，无可见性过滤
- **缺少** `AgentVisibilityService`

### 2.4 Handler 层

**`internal/handler/custom_agent.go`**：
- `CreateAgent` 不设置 `CreatedBy`、`Visibility`、`OrganizationID`
- `ListAgents` 直接返回全部，无过滤

### 2.5 前端

**`frontend/src/api/agent/index.ts`**：
- `CreateAgentRequest` 无 `visibility` / `organization_id` 字段
- `CustomAgent` 接口无 `visibility` / `organization_id` 字段

---

## 3. 改动清单

### 3.1 数据库迁移

**新增文件**: `migrations/versioned/000016_agent_visibility.up.sql`

```sql
ALTER TABLE custom_agents ADD COLUMN IF NOT EXISTS visibility VARCHAR(20) DEFAULT 'private';
ALTER TABLE custom_agents ADD COLUMN IF NOT EXISTS organization_id VARCHAR(36) DEFAULT NULL;
CREATE INDEX IF NOT EXISTS idx_custom_agents_visibility ON custom_agents(visibility);
CREATE INDEX IF NOT EXISTS idx_custom_agents_organization_id ON custom_agents(organization_id);
CREATE INDEX IF NOT EXISTS idx_custom_agents_created_by ON custom_agents(created_by);
```

**新增文件**: `migrations/versioned/000016_agent_visibility.down.sql`

```sql
DROP INDEX IF EXISTS idx_custom_agents_created_by;
DROP INDEX IF EXISTS idx_custom_agents_organization_id;
DROP INDEX IF EXISTS idx_custom_agents_visibility;
ALTER TABLE custom_agents DROP COLUMN IF EXISTS organization_id;
ALTER TABLE custom_agents DROP COLUMN IF EXISTS visibility;
```

### 3.2 后端类型

**修改文件**: `internal/types/custom_agent.go`
- 添加 `Visibility` 字段 (`varchar(20)`, 默认 `private`)
- 添加 `OrganizationID` 字段 (`varchar(36)`)
- 添加可见性常量 `AgentVisibilityGlobal/Org/Private`

### 3.3 后端 Repository

**修改文件**: `internal/application/repository/custom_agent.go`
- 添加 `ListAccessibleAgents(ctx, userID, tenantID, orgIDs)` 方法
  - SQL 逻辑与 KB 的 `ListAccessibleKBs` 一致

**修改文件**: `internal/types/interfaces/custom_agent.go`
- 在 `CustomAgentRepository` 接口添加 `ListAccessibleAgents` 方法

### 3.4 后端 Service

**新增文件**: `internal/application/service/agent_visibility.go`
- 实现 `AgentVisibilityService` 接口
- `ListAccessibleAgents(ctx, userID, tenantID, isSuperAdmin)` — 复用 KB 相同的组织树收集逻辑

**新增文件**: `internal/types/interfaces/agent_visibility.go`
- 定义 `AgentVisibilityService` 接口

### 3.5 后端 Handler

**修改文件**: `internal/handler/custom_agent.go`
- `CreateAgentRequest` 添加 `Visibility`、`OrganizationID` 字段
- `CreateAgent` handler 设置 `CreatedBy`、`Visibility`、`OrganizationID`
- `ListAgents` handler 改用 `AgentVisibilityService.ListAccessibleAgents`
- Handler struct 注入 `AgentVisibilityService`

### 3.6 DI 容器

**修改文件**: `internal/container/container.go`
- 注册 `NewAgentVisibilityService`

### 3.7 前端 API

**修改文件**: `frontend/src/api/agent/index.ts`
- `CustomAgent` 接口添加 `visibility` / `organization_id` / `organization_name` 字段
- `CreateAgentRequest` 添加 `visibility` / `organization_id` 字段

---

## 4. 知识库可见性实现参考

KB 可见性核心 SQL 模式（`ListAccessibleKBs`）：

```sql
WHERE tenant_id = ? AND is_temporary = false
  AND (
    (visibility = 'global' OR visibility = '')
    OR (visibility = 'org' AND organization_id IN (?orgIDs))
    OR (visibility = 'private' AND created_by = ?)
  )
```

智能体将复用完全相同的模式，`is_temporary` 改为 `is_builtin = false` 过滤条件后单独追加内置智能体。

---

## 5. 修改优先级

| 步骤 | 文件 | 优先级 |
|------|------|--------|
| 1. DB 迁移 | `migrations/versioned/000016_*` | P0 |
| 2. 类型定义 | `internal/types/custom_agent.go` | P0 |
| 3. Repository | `internal/application/repository/custom_agent.go` | P0 |
| 4. 接口定义 | `internal/types/interfaces/` | P0 |
| 5. Visibility Service | `internal/application/service/agent_visibility.go` | P0 |
| 6. Handler 改造 | `internal/handler/custom_agent.go` | P0 |
| 7. DI 注册 | `internal/container/container.go` | P0 |
| 8. 前端 API 类型 | `frontend/src/api/agent/index.ts` | P1 |

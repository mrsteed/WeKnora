# ç»„ç»‡äººå‘˜ç®¡ç†å±•ç¤ºä¼˜åŒ–æ–¹æ¡ˆ

> ç‰ˆæœ¬ï¼šv2.0  
> æ—¥æœŸï¼š2026-02-12  
> çŠ¶æ€ï¼šè‰æ¡ˆï¼ˆv2.0 æ–°å¢ç®¡ç†å‘˜æƒé™ç»§æ‰¿æ–¹æ¡ˆï¼‰

---

## ã€‡ã€æ ¸å¿ƒé—®é¢˜ï¼šç®¡ç†å‘˜æƒé™ç»§æ‰¿ç¼ºé™·ï¼ˆv2.0 æ–°å¢ï¼‰

### é—®é¢˜æè¿°

**ç”¨æˆ·åé¦ˆ**ï¼šyanfa æ˜¯"ç ”å‘éƒ¨"çš„ç®¡ç†å‘˜ï¼Œåœ¨"ç ”å‘éƒ¨"ä¸‹åˆ›å»ºå­èŠ‚ç‚¹"äº§å“éƒ¨"åï¼Œyanfa ä¼šä½œä¸º"äº§å“éƒ¨"çš„ç®¡ç†å‘˜å‡ºç°åœ¨å…¶æˆå‘˜åˆ—è¡¨ä¸­ã€‚

**æ­£ç¡®é€»è¾‘**ï¼šyanfa ä½œä¸ºçˆ¶èŠ‚ç‚¹ï¼ˆç ”å‘éƒ¨ï¼‰çš„ç®¡ç†å‘˜ï¼Œåº”**è‡ªåŠ¨ç»§æ‰¿**å¯¹æ‰€æœ‰å­èŠ‚ç‚¹ï¼ˆäº§å“éƒ¨ï¼‰çš„ç®¡ç†å‘˜æƒé™ï¼Œè€Œä¸éœ€è¦è¢«é€ä¸ªæ·»åŠ åˆ°å­èŠ‚ç‚¹çš„ `organization_members` è¡¨ä¸­ã€‚

### æ ¹å› åˆ†æ

ç»å…¨é¢å®¡æŸ¥ä»£ç ï¼Œ**æ ¹æœ¬åŸå› æ˜¯ `isOrgAdminOf` æ–¹æ³•åªæ£€æŸ¥ç›®æ ‡èŠ‚ç‚¹çš„ç›´æ¥æˆå‘˜ï¼Œä¸æ£€æŸ¥ç¥–å…ˆèŠ‚ç‚¹**ï¼Œå¯¼è‡´å‰ç«¯æ˜¾ç¤ºä¸åç«¯æƒé™åˆ¤æ–­ä¸ä¸€è‡´ï¼š

| å±‚é¢ | å®ç°æ–¹å¼ | æ˜¯å¦æ”¯æŒç»§æ‰¿ | ä»£ç ä½ç½® |
|------|---------|:----------:|---------|
| **å‰ç«¯æ˜¾ç¤º**ï¼ˆ`GetTreeForUser`ï¼‰ | é€šè¿‡ `copyNodeTree` é€’å½’ä¼ æ’­ `MyIsAdmin=true` åˆ°æ‰€æœ‰å­èŠ‚ç‚¹ | âœ… æ˜¯ | `service/org_tree.go` L347-390 |
| **åç«¯æƒé™åˆ¤æ–­**ï¼ˆ`isOrgAdminOf`ï¼‰ | åªæŸ¥ `organization_members WHERE organization_id = ç›®æ ‡èŠ‚ç‚¹` | âŒ å¦ | `handler/org_tree.go` L48-64 |

**çŸ›ç›¾ç‚¹**ï¼šå‰ç«¯é€šè¿‡ `copyNodeTree` æŠŠ `MyIsAdmin=true` ä¼ æ’­åˆ°å­èŠ‚ç‚¹ï¼Œå¯¼è‡´å‰ç«¯æ˜¾ç¤ºç”¨æˆ·å¯ä»¥ç®¡ç†å­èŠ‚ç‚¹ã€‚ä½†å½“ç”¨æˆ·å®é™…æ“ä½œï¼ˆç¼–è¾‘/åˆ é™¤/åˆ†é…æˆå‘˜ç­‰ï¼‰æ—¶ï¼Œåç«¯ `isOrgAdminOf` ä¸æ£€æŸ¥ç¥–å…ˆèŠ‚ç‚¹ï¼Œè¿”å› `false`ï¼Œæ“ä½œè¢«æ‹’ç»ã€‚

ä¸ºäº†è®©ç³»ç»Ÿæ­£å¸¸è¿ä½œï¼Œ**å˜é€šæªæ–½æ˜¯æŠŠçˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜æ‰‹åŠ¨æ·»åŠ åˆ°æ¯ä¸ªå­èŠ‚ç‚¹**ï¼Œè¿™å°±å¯¼è‡´äº†ç”¨æˆ·åé¦ˆçš„é—®é¢˜â€”â€”ç®¡ç†å‘˜åœ¨æ¯ä¸ªå­èŠ‚ç‚¹éƒ½å‡ºç°ã€‚

### isOrgAdminOf å½“å‰å®ç°ï¼ˆé—®é¢˜ä»£ç ï¼‰

```go
// handler/org_tree.go L48-64
func (h *OrgTreeHandler) isOrgAdminOf(c *gin.Context, user *types.User, orgID string, tenantID uint64) bool {
    if user.IsSuperAdmin {
        return true
    }
    ctx := c.Request.Context()
    // âŒ åªæŸ¥ç›®æ ‡èŠ‚ç‚¹çš„æˆå‘˜ï¼Œä¸æŸ¥ç¥–å…ˆèŠ‚ç‚¹
    orgMembers, err := h.orgTreeService.ListOrgMembers(ctx, orgID, tenantID)
    if err != nil {
        return false
    }
    for _, member := range orgMembers {
        if member.UserID == user.ID && member.Role == types.OrgRoleAdmin {
            return true
        }
    }
    return false  // â† çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜åœ¨æ­¤è¿”å› false
}
```

### å—å½±å“çš„ API æ¥å£ï¼ˆ13 ä¸ªè°ƒç”¨ç‚¹ï¼‰

ä»¥ä¸‹æ‰€æœ‰ API å‡ä½¿ç”¨ `isOrgAdminOf` åšæƒé™åˆ¤æ–­ï¼Œ**å…¨éƒ¨ä¸æ”¯æŒç¥–å…ˆç»§æ‰¿**ï¼š

| æ–¹æ³• | ä»£ç è¡Œ | æ£€æŸ¥ç›®æ ‡ | å½±å“ |
|------|--------|---------|------|
| `CreateOrgNode` | L161 | `*req.ParentID` | æ£€æŸ¥çˆ¶èŠ‚ç‚¹ âœ…ï¼ˆå”¯ä¸€æ­£ç¡®çš„ï¼‰ |
| `GetOrgNode` | L202 | `orgID` | çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜æ— æ³•æŸ¥çœ‹å­èŠ‚ç‚¹è¯¦æƒ… |
| `UpdateOrgNode` | L250 | `orgID` | çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜æ— æ³•ç¼–è¾‘å­èŠ‚ç‚¹ |
| `DeleteOrgNode` | L289 | `orgID` | çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜æ— æ³•åˆ é™¤å­èŠ‚ç‚¹ |
| `MoveOrgNode` | L336, L343 | `orgID` + ç›®æ ‡ `parentID` | çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜æ— æ³•ç§»åŠ¨å­èŠ‚ç‚¹ |
| `AssignUserToOrg` | L395 | `orgID` | çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜æ— æ³•ç»™å­èŠ‚ç‚¹åˆ†é…æˆå‘˜ |
| `CreateUserInOrg` | L443 | `orgID` | çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜æ— æ³•åœ¨å­èŠ‚ç‚¹åˆ›å»ºç”¨æˆ· |
| `UpdateUserInOrg` | L512 | `orgID` | çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜æ— æ³•ç¼–è¾‘å­èŠ‚ç‚¹æˆå‘˜ |
| `RemoveUserFromOrg` | L610 | `orgID` | çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜æ— æ³•ç§»é™¤å­èŠ‚ç‚¹æˆå‘˜ |
| `SetOrgAdmin` | L668 | `orgID` | çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜æ— æ³•è®¾ç½®å­èŠ‚ç‚¹ç®¡ç†å‘˜ |
| `ListOrgMembers` | L736 | `orgID` | çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜æ— æ³•æŸ¥çœ‹å­èŠ‚ç‚¹æˆå‘˜åˆ—è¡¨ |

> æ³¨æ„ï¼š`CreateOrgNode` æ˜¯å”¯ä¸€ "æ°å·§æ­£ç¡®" çš„ï¼Œå› ä¸ºå®ƒæ£€æŸ¥çš„æ˜¯ `*req.ParentID`ï¼ˆçˆ¶èŠ‚ç‚¹ï¼‰ï¼Œè€Œéæ–°å»ºçš„å­èŠ‚ç‚¹æœ¬èº«ã€‚

### CreateNode æœåŠ¡å±‚åˆ†æ

```go
// service/org_tree.go L67-84
// Only add creator as admin for root-level organizations (no parent)
if org.ParentID == nil {
    creatorMember := &types.OrganizationMember{...}
    s.orgRepo.AddMember(ctx, creatorMember)
}
```

`CreateNode` **åªä¸ºæ ¹èŠ‚ç‚¹æ·»åŠ åˆ›å»ºè€…ä¸ºç®¡ç†å‘˜**ï¼Œå­èŠ‚ç‚¹ä¸ä¼šæ·»åŠ ã€‚è¿™ä¸ªè®¾è®¡æ„å›¾æ˜¯æ­£ç¡®çš„â€”â€”å­èŠ‚ç‚¹åº”è¯¥é€šè¿‡ç»§æ‰¿è·å¾—çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜çš„ç®¡ç†æƒé™ã€‚ä½†ç”±äº `isOrgAdminOf` ä¸æ”¯æŒç»§æ‰¿ï¼Œå¯¼è‡´åˆ›å»ºå­èŠ‚ç‚¹åç®¡ç†å‘˜æ— æ³•ç®¡ç†å®ƒã€‚

### Git æäº¤å†å²éªŒè¯

| æäº¤ | å†…å®¹ |
|------|------|
| `7fc899aa` | åˆå§‹ç‰ˆæœ¬ï¼š`CreateNode` ä¸æ·»åŠ ä»»ä½•ç®¡ç†å‘˜æˆå‘˜ |
| `dec2d502` | æ–°å¢æƒé™ç®¡ç†ï¼š`isOrgAdminOf`ï¼ˆåªæŸ¥ç›´æ¥æˆå‘˜ï¼‰+ `GetTreeForUser`/`copyNodeTree`ï¼ˆå‰ç«¯ä¼ æ’­ `MyIsAdmin`ï¼‰+ `CreateNode` ä»…æ ¹èŠ‚ç‚¹æ·»åŠ ç®¡ç†å‘˜ |

ä¸¤ä¸ªæäº¤å‡**æœªå®ç°ç¥–å…ˆèŠ‚ç‚¹çš„æƒé™ç»§æ‰¿æŸ¥è¯¢**ã€‚

---

## ä¸€ã€ç°çŠ¶åˆ†æ

### 1.1 ç³»ç»Ÿæ¶æ„æ¦‚è¿°

å½“å‰ç»„ç»‡äººå‘˜ç®¡ç†åŸºäº **ç»„ç»‡æ ‘ï¼ˆOrgTreeï¼‰** æ¨¡å‹æ„å»ºï¼Œæ ¸å¿ƒæ•°æ®ç»“æ„å¦‚ä¸‹ï¼š

```
æ•°æ®åº“è¡¨å…³ç³»ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     organizations       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ id          (PK)        â”‚
â”‚ name                    â”‚
â”‚ parent_id   (FKâ†’self)   â”‚ â† è‡ªå¼•ç”¨å®ç°æ ‘çŠ¶ç»“æ„
â”‚ path        (ç‰©åŒ–è·¯å¾„)    â”‚ â† å¦‚ /root_id/parent_id/self_id
â”‚ level       (å±‚çº§æ·±åº¦)    â”‚ â† 1=é¡¶çº§
â”‚ tenant_id   (æ‰€å±ç§Ÿæˆ·)    â”‚
â”‚ owner_id    (åˆ›å»ºè€…)      â”‚
â”‚ sort_order  (åŒçº§æ’åº)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ 1:N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  organization_members   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ id             (PK)     â”‚
â”‚ organization_id (FK)    â”‚ â† ä»…å…³è”åˆ°å•ä¸ªç»„ç»‡èŠ‚ç‚¹
â”‚ user_id        (FK)     â”‚
â”‚ tenant_id              â”‚
â”‚ role  (admin/editor/viewer) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å‰ç«¯å±•ç¤ºæ¶æ„

å‰ç«¯ç»„ç»‡æ ‘ç®¡ç†åœ¨ `AdminLayout.vue` ä¸‹ï¼Œå«ä¸¤ä¸ªä¸»è¦å­é¡µé¢ï¼š

| ç»„ä»¶ | è·¯å¾„ | åŠŸèƒ½ |
|------|------|------|
| `OrgTreeManage.vue` | `/admin/org-tree` | ç»„ç»‡æ ‘ç®¡ç†å…¥å£é¡µé¢ |
| `OrgTreeNodeItem.vue` | å­ç»„ä»¶ | é€’å½’æ¸²æŸ“ç»„ç»‡æ ‘èŠ‚ç‚¹ |
| `OrgTreeEditor.vue` | å­ç»„ä»¶ | æ–°å»º/ç¼–è¾‘ç»„ç»‡èŠ‚ç‚¹å¯¹è¯æ¡† |
| `MemberTable.vue` | å­ç»„ä»¶ | å±•ç¤ºç»„ç»‡èŠ‚ç‚¹ä¸‹çš„æˆå‘˜åˆ—è¡¨ |
| `CreateUserDialog.vue` | å­ç»„ä»¶ | åˆ›å»ºç”¨æˆ·å¯¹è¯æ¡† |

### 1.3 å½“å‰ MemberCount è®¡ç®—æ–¹å¼

**åç«¯**ï¼ˆ`org_tree.go` â†’ `GetTree` / `GetTreeForUser`ï¼‰ï¼š

```go
// 1. æŸ¥è¯¢ç§Ÿæˆ·ä¸‹æ‰€æœ‰ç»„ç»‡èŠ‚ç‚¹
orgs, _ := s.orgTreeRepo.ListByTenantID(ctx, tenantID)

// 2. æ‰¹é‡æŸ¥è¯¢æ¯ä¸ªèŠ‚ç‚¹çš„ç›´æ¥æˆå‘˜æ•°
memberCounts, _ := s.orgRepo.BatchCountMembers(ctx, orgIDs)
// BatchCountMembers æ‰§è¡Œ SQLï¼š
// SELECT organization_id, COUNT(*) as count
//   FROM organization_members
//  WHERE organization_id IN (?)
//  GROUP BY organization_id

// 3. ç»„è£…åˆ° OrgTreeNode
node := &types.OrgTreeNode{
    MemberCount: memberCounts[org.ID],  // â† ä»…ç»Ÿè®¡å½“å‰èŠ‚ç‚¹çš„ç›´æ¥æˆå‘˜
    ...
}
```

**å‰ç«¯**ï¼ˆ`OrgTreeNodeItem.vue`ï¼‰ï¼š

```html
<span class="node-member-count">
  <t-icon name="user" size="14px" />
  {{ node.member_count || 0 }}
</span>
```

### 1.4 å½“å‰ ListOrgMembers æŸ¥è¯¢æ–¹å¼

```go
// handler/org_tree.go â†’ ListOrgMembers
members, _ := h.orgTreeService.ListOrgMembers(ctx, orgID, tenantID)

// service/org_tree.go â†’ ListOrgMembers
members, _ := s.orgRepo.ListMembers(ctx, orgID)  // ä»…æŸ¥å½“å‰èŠ‚ç‚¹

// repository/organization.go â†’ ListMembers
SELECT * FROM organization_members
WHERE organization_id = ?
PRELOAD User
```

---

## äºŒã€é—®é¢˜è¯†åˆ«

### é—®é¢˜ 1ï¼šæ ¹èŠ‚ç‚¹äººå‘˜æ•°é‡ä¸å«å­èŠ‚ç‚¹

**ç°çŠ¶**ï¼šæ¯ä¸ªèŠ‚ç‚¹çš„ `member_count` ä»…ç»Ÿè®¡ `organization_members` è¡¨ä¸­ `organization_id` ç­‰äºå½“å‰èŠ‚ç‚¹ ID çš„è®°å½•æ•°ã€‚å³ï¼š

```
æ€»å…¬å¸ (member_count=2)       â† åªæœ‰ç›´æ¥åˆ†é…åˆ°"æ€»å…¬å¸"çš„ 2 äºº
â”œâ”€â”€ æŠ€æœ¯éƒ¨ (member_count=5)   â† åªæœ‰åˆ†é…åˆ°"æŠ€æœ¯éƒ¨"çš„ 5 äºº
â”‚   â”œâ”€â”€ å‰ç«¯ç»„ (member_count=3)
â”‚   â””â”€â”€ åç«¯ç»„ (member_count=4)
â””â”€â”€ å¸‚åœºéƒ¨ (member_count=3)
```

**æœŸæœ›**ï¼šå‚è€ƒå¸¸è§„ç»„ç»‡äººå‘˜ç®¡ç†ï¼Œæ ¹èŠ‚ç‚¹åº”æ˜¾ç¤ºæ‰€æœ‰å­èŠ‚ç‚¹çš„äººå‘˜æ€»æ•°ï¼š

```
æ€»å…¬å¸ (member_count=17)      â† 2 + 5 + 3 + 4 + 3 = 17ï¼ˆå«æ‰€æœ‰å­æ ‘ï¼‰
â”œâ”€â”€ æŠ€æœ¯éƒ¨ (member_count=12)  â† 5 + 3 + 4 = 12
â”‚   â”œâ”€â”€ å‰ç«¯ç»„ (member_count=3)
â”‚   â””â”€â”€ åç«¯ç»„ (member_count=4)
â””â”€â”€ å¸‚åœºéƒ¨ (member_count=3)
```

**æ ¹å› **ï¼š`BatchCountMembers` ä»…æŒ‰ `organization_id` åˆ†ç»„è®¡æ•°ï¼Œæœªåšå­æ ‘é€’å½’èšåˆã€‚

### é—®é¢˜ 2ï¼šå­èŠ‚ç‚¹ä¸æ˜¾ç¤ºå½“å‰èŠ‚ç‚¹çš„ä¸“å±äººå‘˜

**ç°çŠ¶**ï¼šç‚¹å‡»å±•å¼€æŸä¸ªå­èŠ‚ç‚¹æŸ¥çœ‹æˆå‘˜æ—¶ï¼Œ`ListOrgMembers` API åªè¿”å›å½“å‰èŠ‚ç‚¹ `organization_members` ä¸­çš„è®°å½•ã€‚

ä½†å±•ç¤ºé€»è¾‘ä»…åšç®€å•åˆ—è¡¨ï¼Œä¸åŒºåˆ†"æœ¬çº§äººå‘˜"å’Œ"ç®¡ç†äººå‘˜"ï¼Œå¯¼è‡´ç®¡ç†å‘˜çœ‹ä¸æ¸…æ¯ä¸ªèŠ‚ç‚¹çš„å®é™…å½’å±äººå‘˜ã€‚

**æœŸæœ›**ï¼šç‚¹å‡»æŸä¸ªå­èŠ‚ç‚¹æ—¶ï¼Œåº”æ¸…æ™°å±•ç¤º**ç›´æ¥åˆ†é…åˆ°è¯¥èŠ‚ç‚¹**çš„äººå‘˜ï¼Œä½¿ç®¡ç†å‘˜èƒ½å¿«é€Ÿç†è§£"è¿™ä¸ªéƒ¨é—¨æœ‰å“ªäº›äºº"ã€‚

### é—®é¢˜ 3ï¼šäºŒçº§ç»„ç»‡ç®¡ç†å‘˜åœ¨æ¯ä¸ªä¸‰çº§èŠ‚ç‚¹é‡å¤æ˜¾ç¤º

#### 3.4.1 é—®é¢˜æ ¹å› ï¼ˆv2.0 æ›´æ­£ï¼‰

**v1.0 åˆ†ææœ‰è¯¯**ï¼šåŸæ–‡æ¡£ FAQ Q2 é”™è¯¯åœ°è®¤ä¸º"æƒé™åˆ¤æ–­å·²é€šè¿‡ `copyNodeTree` æ­£ç¡®ä¼ æ’­"ã€‚

**å®é™…æ ¹å› **ï¼š`isOrgAdminOf` **ä¸æ”¯æŒç¥–å…ˆç»§æ‰¿**ï¼Œå¯¼è‡´ç³»ç»ŸåŠŸèƒ½å¼‚å¸¸ã€‚ä¸ºäº†è®©çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜èƒ½ç®¡ç†å­èŠ‚ç‚¹ï¼Œå˜é€šæªæ–½æ˜¯å°†ç®¡ç†å‘˜æ‰‹åŠ¨æ·»åŠ åˆ°æ¯ä¸ªå­èŠ‚ç‚¹çš„ `organization_members` ä¸­ï¼Œä»è€Œå¯¼è‡´ç®¡ç†å‘˜åœ¨å­èŠ‚ç‚¹çš„æˆå‘˜åˆ—è¡¨ä¸­é‡å¤å‡ºç°ã€‚

| åŸå› é“¾ | è¯´æ˜ |
|--------|------|
| `isOrgAdminOf` åªæŸ¥ç›´æ¥æˆå‘˜ | çˆ¶èŠ‚ç‚¹ admin æ— æ³•é€šè¿‡ API ç®¡ç†å­èŠ‚ç‚¹ |
| â†’ å˜é€šï¼šæ‰‹åŠ¨æ·»åŠ  admin åˆ°å­èŠ‚ç‚¹ | admin åœ¨ `organization_members` è¡¨ä¸­æœ‰å¤šæ¡è®°å½• |
| â†’ `ListOrgMembers` è¿”å›å­èŠ‚ç‚¹ç›´æ¥æˆå‘˜ | admin å‡ºç°åœ¨å­èŠ‚ç‚¹çš„æˆå‘˜åˆ—è¡¨ä¸­ |
| â†’ **ç®¡ç†å‘˜åœ¨æ¯ä¸ªå­èŠ‚ç‚¹é‡å¤æ˜¾ç¤º** | ç”¨æˆ·åé¦ˆçš„é—®é¢˜ |

**è§£å†³æ–¹æ¡ˆ**ï¼šä¿®å¤ `isOrgAdminOf`ï¼ˆè¯¦è§ç¬¬åèŠ‚ï¼‰ï¼Œæ¶ˆé™¤æ‰‹åŠ¨æ·»åŠ  admin åˆ°å­èŠ‚ç‚¹çš„éœ€æ±‚ã€‚ä¿®å¤åï¼Œ`ListOrgMembers` è¿”å›çš„å­èŠ‚ç‚¹æˆå‘˜åˆ—è¡¨ä¸­ä¸å†åŒ…å«ä»ä¸Šçº§"å€Ÿæ¥"çš„ç®¡ç†å‘˜è®°å½•ã€‚

---

## ä¸‰ã€ä¼˜åŒ–æ–¹æ¡ˆ

### 3.1 æ–¹æ¡ˆæ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¼˜åŒ–é¡¹ä¸€è§ˆ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç¼–å·  â”‚ ä¼˜åŒ–é¡¹                 â”‚ å½±å“èŒƒå›´                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1   â”‚ æ ¹èŠ‚ç‚¹æ˜¾ç¤ºå­æ ‘æ€»äººæ•°     â”‚ åç«¯ Service + å‰ç«¯å±•ç¤º   â”‚
â”‚  2   â”‚ å­èŠ‚ç‚¹æ˜¾ç¤ºç›´å±äººå‘˜       â”‚ åç«¯ API + å‰ç«¯ç»„ä»¶       â”‚
â”‚  3   â”‚ ç®¡ç†å‘˜ä¸ç›´å±æˆå‘˜åˆ†ç¦»å±•ç¤º  â”‚ åç«¯ API + å‰ç«¯ç»„ä»¶       â”‚
â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ä¼˜åŒ–é¡¹ 1ï¼šæ ¹èŠ‚ç‚¹æ˜¾ç¤ºæ‰€æœ‰å­èŠ‚ç‚¹äººå‘˜æ€»æ•°

#### 3.2.1 æ€è·¯

åœ¨æ„å»ºç»„ç»‡æ ‘æ—¶ï¼Œ**è‡ªåº•å‘ä¸Šé€’å½’æ±‡æ€»**å­èŠ‚ç‚¹çš„ `member_count` åˆ°çˆ¶èŠ‚ç‚¹ã€‚

ä¸º `OrgTreeNode` æ–°å¢ä¸¤ä¸ªå­—æ®µï¼š
- `direct_member_count`ï¼šå½“å‰èŠ‚ç‚¹ç›´æ¥æˆå‘˜æ•°
- `total_member_count`ï¼šå½“å‰èŠ‚ç‚¹ + æ‰€æœ‰å­å­™èŠ‚ç‚¹çš„æˆå‘˜æ€»æ•°ï¼ˆå»é‡ï¼‰

#### 3.2.2 åç«¯æ”¹åŠ¨

**types/organization.go** â€” `OrgTreeNode` æ–°å¢å­—æ®µï¼š

```go
type OrgTreeNode struct {
    // ...å·²æœ‰å­—æ®µ...
    MemberCount       int  `json:"member_count"`        // ä¿æŒå…¼å®¹ï¼šæ”¹ä¸ºæ€»äººæ•°
    DirectMemberCount int  `json:"direct_member_count"` // æ–°å¢ï¼šç›´å±æˆå‘˜æ•°
    TotalMemberCount  int  `json:"total_member_count"`  // æ–°å¢ï¼šå­æ ‘æ€»äººæ•°ï¼ˆå»é‡ï¼‰
    // ...
}
```

**service/org_tree.go** â€” `GetTree` æ–¹æ³•æ”¹é€ ï¼š

```go
func (s *orgTreeService) GetTree(ctx context.Context, tenantID uint64) ([]*types.OrgTreeNode, error) {
    orgs, _ := s.orgTreeRepo.ListByTenantID(ctx, tenantID)
    
    // 1. æ‰¹é‡æŸ¥è¯¢æ¯ä¸ªèŠ‚ç‚¹çš„ç›´å±æˆå‘˜æ•°ï¼ˆä¸å˜ï¼‰
    memberCounts, _ := s.orgRepo.BatchCountMembers(ctx, orgIDs)
    
    // 2. æ‰¹é‡æŸ¥è¯¢æ¯ä¸ªèŠ‚ç‚¹çš„ç›´å±æˆå‘˜ UserID åˆ—è¡¨ï¼ˆæ–°å¢ï¼‰
    memberUserIDs, _ := s.orgRepo.BatchListMemberUserIDs(ctx, orgIDs)
    
    // 3. æ„å»ºæ ‘ç»“æ„ï¼ˆä¸å˜ï¼‰
    // ...
    
    // 4. è‡ªåº•å‘ä¸Šè®¡ç®— TotalMemberCountï¼ˆæ–°å¢ï¼‰
    for _, root := range roots {
        s.computeSubtreeMemberCount(root, memberUserIDs)
    }
    
    return roots, nil
}

// computeSubtreeMemberCount é€’å½’è®¡ç®—å­æ ‘æ€»äººæ•°ï¼ˆå»é‡ï¼‰
func (s *orgTreeService) computeSubtreeMemberCount(node *types.OrgTreeNode, memberUserIDs map[string][]string) map[string]bool {
    userSet := make(map[string]bool)
    
    // æ·»åŠ å½“å‰èŠ‚ç‚¹çš„ç›´å±æˆå‘˜
    for _, uid := range memberUserIDs[node.ID] {
        userSet[uid] = true
    }
    node.DirectMemberCount = len(memberUserIDs[node.ID])
    
    // é€’å½’å¤„ç†å­èŠ‚ç‚¹
    for _, child := range node.Children {
        childUsers := s.computeSubtreeMemberCount(child, memberUserIDs)
        for uid := range childUsers {
            userSet[uid] = true
        }
    }
    
    node.TotalMemberCount = len(userSet)
    node.MemberCount = node.TotalMemberCount  // ä¿æŒå…¼å®¹
    
    return userSet
}
```

**repository/organization.go** â€” æ–°å¢æ‰¹é‡æŸ¥è¯¢æ–¹æ³•ï¼š

```go
// BatchListMemberUserIDs æ‰¹é‡æŸ¥è¯¢æ¯ä¸ªç»„ç»‡èŠ‚ç‚¹çš„ç›´å±æˆå‘˜ UserID
func (r *organizationRepository) BatchListMemberUserIDs(ctx context.Context, orgIDs []string) (map[string][]string, error) {
    if len(orgIDs) == 0 {
        return make(map[string][]string), nil
    }
    type memberRow struct {
        OrganizationID string `gorm:"column:organization_id"`
        UserID         string `gorm:"column:user_id"`
    }
    var rows []memberRow
    err := r.db.WithContext(ctx).
        Model(&types.OrganizationMember{}).
        Select("organization_id, user_id").
        Where("organization_id IN ?", orgIDs).
        Find(&rows).Error
    if err != nil {
        return nil, err
    }
    result := make(map[string][]string, len(orgIDs))
    for _, r := range rows {
        result[r.OrganizationID] = append(result[r.OrganizationID], r.UserID)
    }
    return result, nil
}
```

#### 3.2.3 å‰ç«¯æ”¹åŠ¨

**`OrgTreeNodeItem.vue`** â€” å±•ç¤ºæ€»äººæ•°ï¼š

```html
<!-- æ”¹å‰ -->
<span class="node-member-count">
  <t-icon name="user" size="14px" />
  {{ node.member_count || 0 }}
</span>

<!-- æ”¹å -->
<span class="node-member-count" :title="`ç›´å± ${node.direct_member_count || 0} äººï¼Œå«ä¸‹çº§å…± ${node.total_member_count || node.member_count || 0} äºº`">
  <t-icon name="user" size="14px" />
  {{ node.total_member_count || node.member_count || 0 }}
  <span v-if="node.children && node.children.length > 0 && node.direct_member_count !== undefined" class="direct-count">
    (ç›´å± {{ node.direct_member_count }})
  </span>
</span>
```

#### 3.2.4 æ•ˆæœç¤ºæ„

```
æ€»å…¬å¸ ğŸ‘¤17 (ç›´å±2)
â”œâ”€â”€ æŠ€æœ¯éƒ¨ ğŸ‘¤12 (ç›´å±5)
â”‚   â”œâ”€â”€ å‰ç«¯ç»„ ğŸ‘¤3
â”‚   â””â”€â”€ åç«¯ç»„ ğŸ‘¤4
â””â”€â”€ å¸‚åœºéƒ¨ ğŸ‘¤3
```

---

### 3.3 ä¼˜åŒ–é¡¹ 2ï¼šå­èŠ‚ç‚¹æ¸…æ™°å±•ç¤ºç›´å±äººå‘˜

#### 3.3.1 æ€è·¯

å½“å‰ `ListOrgMembers` å·²ç»æ­£ç¡®åœ°åªè¿”å›å½“å‰èŠ‚ç‚¹çš„ç›´å±æˆå‘˜ã€‚ä¼˜åŒ–é‡ç‚¹åœ¨å‰ç«¯å±•ç¤ºä¸Šï¼š
- åœ¨èŠ‚ç‚¹çš„æˆå‘˜é¢æ¿ä¸­æ˜ç¡®æ ‡æ³¨"ç›´å±æˆå‘˜"
- å¯é€‰ï¼šæä¾›æŸ¥çœ‹å­èŠ‚ç‚¹æˆå‘˜çš„èšåˆè§†å›¾

#### 3.3.2 åç«¯æ”¹åŠ¨

æ–°å¢ APIï¼šæŸ¥è¯¢èŠ‚ç‚¹åŠå…¶æ‰€æœ‰å­èŠ‚ç‚¹çš„æˆå‘˜èšåˆè§†å›¾ã€‚

**handler/org_tree.go** â€” æ–°å¢ `ListOrgMembersWithChildren`ï¼š

```go
// ListOrgMembersRecursive è¿”å›å½“å‰èŠ‚ç‚¹åŠæ‰€æœ‰å­èŠ‚ç‚¹çš„æˆå‘˜åˆ—è¡¨
// @Summary      è·å–ç»„ç»‡åŠå­ç»„ç»‡æ‰€æœ‰æˆå‘˜
// @Description  è¿”å›å½“å‰èŠ‚ç‚¹åŠæ‰€æœ‰å­èŠ‚ç‚¹çš„æ‰€æœ‰æˆå‘˜ï¼ˆå»é‡ï¼‰ï¼Œå¹¶æ ‡æ³¨æ‰€å±ç»„ç»‡
// @Tags         ç»„ç»‡æ ‘ç®¡ç†
// @Param        id          path   string  true   "ç»„ç»‡ID"
// @Param        recursive   query  bool    false  "æ˜¯å¦åŒ…å«å­ç»„ç»‡æˆå‘˜" default(false)
// @Success      200  {object}  map[string]interface{}
// @Security     Bearer
// @Router       /org-tree/{id}/members [get]
func (h *OrgTreeHandler) ListOrgMembers(c *gin.Context) {
    // ç°æœ‰é€»è¾‘ä¿æŒä¸å˜
    // æ–°å¢ recursive å‚æ•°
    recursive := c.Query("recursive") == "true"
    
    if recursive {
        // è·å–å­æ ‘æ‰€æœ‰ç»„ç»‡ ID
        orgIDs, _ := h.orgTreeService.GetOrgAndDescendantIDs(ctx, orgID, tenantID)
        // æ‰¹é‡æŸ¥è¯¢æ‰€æœ‰æˆå‘˜ï¼ˆå»é‡ + æ ‡æ³¨æ¥æºç»„ç»‡ï¼‰
        // ...
    }
}
```

**types/organization.go** â€” æ–°å¢æˆå‘˜å±•ç¤ºç±»å‹ï¼š

```go
// OrgMemberWithSource åœ¨æˆå‘˜ä¿¡æ¯ä¸­é™„å¸¦æ¥æºç»„ç»‡ä¿¡æ¯
type OrgMemberWithSource struct {
    OrganizationMember
    SourceOrgID   string `json:"source_org_id"`   // æˆå‘˜æ‰€å±çš„ç»„ç»‡ID
    SourceOrgName string `json:"source_org_name"` // æˆå‘˜æ‰€å±çš„ç»„ç»‡åç§°
    IsDirect      bool   `json:"is_direct"`       // æ˜¯å¦ä¸ºå½“å‰èŠ‚ç‚¹çš„ç›´å±æˆå‘˜
}
```

#### 3.3.3 å‰ç«¯æ”¹åŠ¨

**`MemberTable.vue`** æ”¹é€ ï¼š

```html
<!-- æ–°å¢ï¼šæˆå‘˜æ¥æºæ ‡ç­¾ -->
<span v-if="showSource && !member.is_direct" class="member-source">
  <t-tag theme="default" variant="light" size="small">
    {{ member.source_org_name }}
  </t-tag>
</span>
```

æ–°å¢ Tab åˆ‡æ¢ï¼š

```html
<div class="member-tabs">
  <t-radio-group v-model="viewMode" variant="default-filled" size="small">
    <t-radio-button value="direct">ç›´å±æˆå‘˜ ({{ directCount }})</t-radio-button>
    <t-radio-button value="all">æ‰€æœ‰æˆå‘˜ ({{ totalCount }})</t-radio-button>
  </t-radio-group>
</div>
```

---

### 3.4 ä¼˜åŒ–é¡¹ 3ï¼šäºŒçº§ç®¡ç†å‘˜ä¸åœ¨ä¸‰çº§èŠ‚ç‚¹é‡å¤æ˜¾ç¤º

#### 3.4.1 é—®é¢˜æ ¹å› 

å½“å‰æ•°æ®æ¨¡å‹ä¸­ `organization_members` åŒæ—¶æ‰¿è½½ä¸¤ä¸ªè¯­ä¹‰ï¼š

| è¯­ä¹‰ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|
| **å½’å±å…³ç³»** | ç”¨æˆ·å±äºå“ªä¸ªç»„ç»‡èŠ‚ç‚¹ | å¼ ä¸‰ â†’ å‰ç«¯ç»„ |
| **ç®¡ç†æƒé™** | ç”¨æˆ·æ˜¯å“ªä¸ªç»„ç»‡çš„ç®¡ç†å‘˜ | æå›› â†’ æŠ€æœ¯éƒ¨(admin) |

å½“"æŠ€æœ¯éƒ¨"çš„ç®¡ç†å‘˜æå››ç®¡ç†å…¶ä¸‹çš„"å‰ç«¯ç»„"æ—¶ï¼š
- **æƒé™å±‚é¢**ï¼šæå››ä½œä¸ºæŠ€æœ¯éƒ¨ adminï¼Œé€šè¿‡ `GetTreeForUser` ä¸­çš„ `copyNodeTree` é€»è¾‘ï¼Œ`MyIsAdmin=true` è¢«ä¼ æ’­åˆ°å‰ç«¯ç»„ â†’ **æƒé™ç»§æ‰¿å·²æ­£ç¡®å®ç°**
- **æˆå‘˜å±•ç¤ºå±‚é¢**ï¼šå¦‚æœæå››æ²¡æœ‰è¢«æ˜¾å¼æ·»åŠ åˆ°"å‰ç«¯ç»„"çš„ `organization_members` ä¸­ï¼Œåˆ™å‰ç«¯å±•ç¤º"å‰ç«¯ç»„"æˆå‘˜æ—¶ä¸ä¼šå‡ºç°æå›› â†’ **æ­£å¸¸æƒ…å†µä¸ä¼šé‡å¤**

#### 3.4.2 å®é™…è§¦å‘é‡å¤æ˜¾ç¤ºçš„åœºæ™¯

ç»ä»£ç åˆ†æï¼Œé‡å¤æ˜¾ç¤ºå‘ç”Ÿåœ¨ä»¥ä¸‹åœºæ™¯ï¼š

**åœºæ™¯ A**ï¼šç®¡ç†å‘˜è¢«æ‰‹åŠ¨æ·»åŠ åˆ°å­èŠ‚ç‚¹

é€šè¿‡ `AssignUserToOrg` æ¥å£å°†äºŒçº§ç®¡ç†å‘˜ä¹Ÿæ·»åŠ åˆ°ä¸‰çº§èŠ‚ç‚¹ä½œä¸ºæˆå‘˜ã€‚æ­¤æ—¶è¯¥ç®¡ç†å‘˜ç¡®å®åœ¨ `organization_members` ä¸­å­˜åœ¨ä¸¤æ¡è®°å½•ï¼ˆäºŒçº§å’Œä¸‰çº§å„ä¸€æ¡ï¼‰ã€‚

**åœºæ™¯ B**ï¼šå¦‚æœåç«¯ `ListOrgMembers` è¢«ä¿®æ”¹ä¸ºé€’å½’æŸ¥è¯¢ï¼ˆå¦‚ä¼˜åŒ–é¡¹2ä¸­çš„ `recursive=true`ï¼‰ï¼Œåˆ™ä¸Šçº§ç®¡ç†å‘˜ä¼šå‡ºç°åœ¨ä¸‹çº§èŠ‚ç‚¹çš„èšåˆæˆå‘˜åˆ—è¡¨ä¸­ã€‚

#### 3.4.3 è§£å†³æ–¹æ¡ˆ

**æ ¸å¿ƒåŸåˆ™**ï¼šåŒºåˆ†"ç®¡ç†æƒé™"ä¸"äººå‘˜å½’å±"

```
æ–¹æ¡ˆï¼šåˆ†å±‚å±•ç¤º + åç«¯è¿‡æ»¤

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŠ€æœ¯éƒ¨ ğŸ‘¤12                       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ ğŸ“‹ ç®¡ç†å‘˜ (2)                     â”‚ â† æ˜¾ç¤ºå½“å‰èŠ‚ç‚¹çš„ admin è§’è‰²æˆå‘˜
â”‚   â€¢ æå›› (ç®¡ç†å‘˜)                  â”‚
â”‚   â€¢ ç‹äº” (ç®¡ç†å‘˜)                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ ğŸ‘¥ ç›´å±æˆå‘˜ (5)                    â”‚ â† æ˜¾ç¤ºå½“å‰èŠ‚ç‚¹çš„é admin æˆå‘˜
â”‚   â€¢ èµµå…­                          â”‚
â”‚   â€¢ é’±ä¸ƒ                          â”‚
â”‚   â€¢ ...                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ç»„ ğŸ‘¤3                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ ğŸ“‹ ç®¡ç†å‘˜ â€” ç»§æ‰¿è‡ªä¸Šçº§             â”‚ â† tooltip æˆ–æŠ˜å åŒºåŸŸæç¤º
â”‚   (æŠ€æœ¯éƒ¨: æå››ã€ç‹äº”)              â”‚ â† æµ…è‰²/æŠ˜å å±•ç¤ºï¼Œéä¸»è¦ä¿¡æ¯
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ ğŸ‘¥ ç›´å±æˆå‘˜ (3)                    â”‚ â† ä»…æ˜¾ç¤ºç›´æ¥åˆ†é…åˆ°å‰ç«¯ç»„çš„äºº
â”‚   â€¢ å­™å…«                          â”‚
â”‚   â€¢ å‘¨ä¹                          â”‚
â”‚   â€¢ å´å                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.4.4 åç«¯æ”¹åŠ¨

**handler/org_tree.go** â€” æ”¹é€  `ListOrgMembers` è¿”å›å€¼ï¼š

```go
func (h *OrgTreeHandler) ListOrgMembers(c *gin.Context) {
    // ... æƒé™æ£€æŸ¥ ...
    
    // 1. è·å–å½“å‰èŠ‚ç‚¹ç›´å±æˆå‘˜
    members, _ := h.orgTreeService.ListOrgMembers(ctx, orgID, tenantID)
    
    // 2. è·å–ç»§æ‰¿çš„ç®¡ç†å‘˜ï¼ˆä»ç¥–å…ˆèŠ‚ç‚¹ç»§æ‰¿ï¼‰
    inheritedAdmins, _ := h.orgTreeService.ListInheritedAdmins(ctx, orgID, tenantID)
    
    // 3. æ„å»ºåˆ†ç±»ç»“æœ
    directMembers := []gin.H{}
    directAdmins := []gin.H{}
    
    for _, m := range members {
        entry := gin.H{
            "user_id":  m.UserID,
            "username": m.User.Username,
            "email":    m.User.Email,
            "phone":    m.User.Phone,
            "role":     string(m.Role),
            "is_admin": m.Role == types.OrgRoleAdmin,
            "is_direct": true,   // æ ‡è®°ä¸ºç›´å±
        }
        if m.Role == types.OrgRoleAdmin {
            directAdmins = append(directAdmins, entry)
        } else {
            directMembers = append(directMembers, entry)
        }
    }
    
    c.JSON(http.StatusOK, gin.H{
        "success": true,
        "data": gin.H{
            "direct_admins":   directAdmins,     // ç›´å±ç®¡ç†å‘˜
            "direct_members":  directMembers,     // ç›´å±æ™®é€šæˆå‘˜
            "inherited_admins": inheritedAdmins,  // ç»§æ‰¿çš„ä¸Šçº§ç®¡ç†å‘˜
            "total_direct":    len(members),      // ç›´å±æ€»äººæ•°
        },
    })
}
```

**service/org_tree.go** â€” æ–°å¢ `ListInheritedAdmins`ï¼š

```go
// ListInheritedAdmins è¿”å›ä»ç¥–å…ˆèŠ‚ç‚¹ç»§æ‰¿çš„ç®¡ç†å‘˜åˆ—è¡¨
func (s *orgTreeService) ListInheritedAdmins(ctx context.Context, orgID string, tenantID uint64) ([]map[string]interface{}, error) {
    // 1. è·å–å½“å‰èŠ‚ç‚¹
    org, _ := s.orgTreeRepo.GetByIDAndTenant(ctx, orgID, tenantID)
    
    // 2. ä» path ä¸­è§£æå‡ºæ‰€æœ‰ç¥–å…ˆèŠ‚ç‚¹ ID
    parts := strings.Split(strings.TrimPrefix(org.Path, "/"), "/")
    
    // 3. æ’é™¤è‡ªèº« IDï¼Œå¾—åˆ°ç¥–å…ˆ ID åˆ—è¡¨
    ancestorIDs := []string{}
    for _, part := range parts {
        if part != "" && part != orgID {
            ancestorIDs = append(ancestorIDs, part)
        }
    }
    
    if len(ancestorIDs) == 0 {
        return nil, nil
    }
    
    // 4. æŸ¥è¯¢ç¥–å…ˆèŠ‚ç‚¹ä¸­ role=admin çš„æˆå‘˜
    var adminMembers []*types.OrganizationMember
    s.orgRepo.DB().Preload("User").
        Where("organization_id IN ? AND role = ?", ancestorIDs, types.OrgRoleAdmin).
        Find(&adminMembers)
    
    // 5. æŸ¥è¯¢ç¥–å…ˆèŠ‚ç‚¹åç§°
    ancestorOrgs, _ := s.orgTreeRepo.GetByIDs(ctx, ancestorIDs)
    orgNameMap := make(map[string]string)
    for _, ao := range ancestorOrgs {
        orgNameMap[ao.ID] = ao.Name
    }
    
    // 6. æ„å»ºç»“æœï¼Œå»æ‰å·²åœ¨å½“å‰èŠ‚ç‚¹ç›´å±çš„ç”¨æˆ·
    directMembers, _ := s.orgRepo.ListMembers(ctx, orgID)
    directUserIDs := make(map[string]bool)
    for _, dm := range directMembers {
        directUserIDs[dm.UserID] = true
    }
    
    result := []map[string]interface{}{}
    seen := make(map[string]bool)
    for _, m := range adminMembers {
        if directUserIDs[m.UserID] || seen[m.UserID] {
            continue
        }
        seen[m.UserID] = true
        entry := map[string]interface{}{
            "user_id":        m.UserID,
            "username":       "",
            "email":          "",
            "from_org_id":    m.OrganizationID,
            "from_org_name":  orgNameMap[m.OrganizationID],
            "role":           "admin",
            "is_inherited":   true,
        }
        if m.User != nil {
            entry["username"] = m.User.Username
            entry["email"] = m.User.Email
        }
        result = append(result, entry)
    }
    
    return result, nil
}
```

#### 3.4.5 å‰ç«¯æ”¹åŠ¨

**`MemberTable.vue`** â€” åˆ†åŒºå±•ç¤ºï¼š

```vue
<template>
  <div class="member-table">
    <!-- ç›´å±ç®¡ç†å‘˜åŒº -->
    <div v-if="directAdmins.length > 0" class="member-section">
      <div class="section-header">
        <t-icon name="secured" size="14px" />
        ç®¡ç†å‘˜ ({{ directAdmins.length }})
      </div>
      <div v-for="admin in directAdmins" :key="admin.user_id" class="table-row admin-row">
        <!-- ... ç®¡ç†å‘˜ä¿¡æ¯ ... -->
      </div>
    </div>
    
    <!-- ç»§æ‰¿ç®¡ç†å‘˜åŒºï¼ˆé»˜è®¤æŠ˜å ï¼‰ -->
    <div v-if="inheritedAdmins.length > 0" class="member-section inherited-section">
      <div class="section-header clickable" @click="showInherited = !showInherited">
        <t-icon :name="showInherited ? 'chevron-down' : 'chevron-right'" size="14px" />
        ä¸Šçº§ç®¡ç†å‘˜ ({{ inheritedAdmins.length }})
        <span class="hint">ç»§æ‰¿è‡ªä¸Šçº§ç»„ç»‡ï¼Œæ‹¥æœ‰æœ¬ç»„ç»‡ç®¡ç†æƒé™</span>
      </div>
      <template v-if="showInherited">
        <div v-for="admin in inheritedAdmins" :key="admin.user_id" class="table-row inherited-row">
          <span class="col-user">
            <t-icon name="user-circle" class="user-icon" />
            {{ admin.username }}
          </span>
          <span class="col-source">
            <t-tag size="small" variant="light" theme="default">
              æ¥è‡ª: {{ admin.from_org_name }}
            </t-tag>
          </span>
        </div>
      </template>
    </div>
    
    <!-- ç›´å±æˆå‘˜åŒº -->
    <div class="member-section">
      <div class="section-header">
        <t-icon name="user" size="14px" />
        ç›´å±æˆå‘˜ ({{ directMembers.length }})
      </div>
      <div v-for="member in directMembers" :key="member.user_id" class="table-row">
        <!-- ... æˆå‘˜ä¿¡æ¯ ... -->
      </div>
    </div>
  </div>
</template>
```

---

## å››ã€æ•°æ®æµå›¾

### 4.1 æƒé™åˆ¤æ–­æµç¨‹ï¼ˆä¿®å¤å‰ vs ä¿®å¤åï¼‰

```
ã€ä¿®å¤å‰ã€‘isOrgAdminOf æƒé™åˆ¤æ–­
  ç”¨æˆ·æ“ä½œå­èŠ‚ç‚¹ API
      â”‚
      â–¼
  isOrgAdminOf(å­èŠ‚ç‚¹ID)
      â”‚
      â–¼
  æŸ¥è¯¢ organization_members WHERE organization_id = å­èŠ‚ç‚¹ID
      â”‚
      â–¼
  ç”¨æˆ·ä¸åœ¨å­èŠ‚ç‚¹æˆå‘˜è¡¨ä¸­ â†’ return false â† âŒ æ“ä½œè¢«æ‹’ç»
  
  å˜é€šï¼šæ‰‹åŠ¨æŠŠçˆ¶èŠ‚ç‚¹adminæ·»åŠ åˆ°å­èŠ‚ç‚¹ â†’ ç®¡ç†å‘˜åœ¨æ¯ä¸ªå­èŠ‚ç‚¹é‡å¤å‡ºç°

ã€ä¿®å¤åã€‘isOrgAdminOf æƒé™åˆ¤æ–­
  ç”¨æˆ·æ“ä½œå­èŠ‚ç‚¹ API
      â”‚
      â–¼
  isOrgAdminOf(å­èŠ‚ç‚¹ID)
      â”‚
      â–¼
  Step 1: æŸ¥è¯¢ organization_members WHERE organization_id = å­èŠ‚ç‚¹ID
      â”‚
      â”œâ”€â”€ å‘½ä¸­ â†’ return true â† å¿«é€Ÿè·¯å¾„ï¼ˆå¤§å¤šæ•°åœºæ™¯ï¼‰
      â”‚
      â””â”€â”€ æœªå‘½ä¸­
          â”‚
          â–¼
  Step 2: è·å–å­èŠ‚ç‚¹çš„ path (å¦‚ /root_id/parent_id/self_id)
  Step 3: è§£æç¥–å…ˆIDåˆ—è¡¨ [root_id, parent_id]ï¼ˆçº¯å†…å­˜ï¼ŒO(1)ï¼‰
  Step 4: æŸ¥è¯¢ organization_members WHERE user_id = ? AND org_id IN ç¥–å…ˆåˆ—è¡¨ AND role = 'admin'
      â”‚
      â”œâ”€â”€ å‘½ä¸­ â†’ return true â† âœ… ç»§æ‰¿ç”Ÿæ•ˆ
      â”‚
      â””â”€â”€ æœªå‘½ä¸­ â†’ return false
```

### 4.2 ç»„ç»‡æ ‘å±•ç¤ºæµç¨‹æ”¹é€ 

```
GetOrgTree API
    â”‚
    â–¼
ListByTenantID â†’ æ‰€æœ‰ç»„ç»‡èŠ‚ç‚¹
    â”‚
    â–¼
BatchCountMembers â†’ æ¯ä¸ªèŠ‚ç‚¹çš„ã€Œç›´å±æˆå‘˜æ•°ã€
BatchListMemberUserIDs â†’ æ¯ä¸ªèŠ‚ç‚¹çš„ã€Œç›´å±æˆå‘˜IDåˆ—è¡¨ã€
    â”‚
    â–¼
æ„å»ºæ ‘ â†’ é€’å½’è®¡ç®—ï¼š
   â”œâ”€â”€ direct_member_count = ç›´å±æˆå‘˜æ•°
   â””â”€â”€ total_member_count = å­æ ‘å»é‡æ€»äººæ•°
    â”‚
    â–¼
å‰ç«¯æ¸²æŸ“ â†’ èŠ‚ç‚¹æ˜¾ç¤º total_member_count (direct X)

ListOrgMembers API (ç‚¹å‡»èŠ‚ç‚¹)
    â”‚
    â–¼
isOrgAdminOf æƒé™åˆ¤æ–­ï¼ˆæ”¯æŒç¥–å…ˆç»§æ‰¿ï¼‰
    â”‚
    â–¼
æŸ¥è¯¢ç›´å±æˆå‘˜ + æŸ¥è¯¢ç¥–å…ˆç®¡ç†å‘˜
    â”‚
    â–¼
å‰ç«¯åˆ†åŒºå±•ç¤ºï¼š
â”œâ”€â”€ ç®¡ç†å‘˜åŒºï¼ˆç›´å±adminï¼‰
â”œâ”€â”€ ç»§æ‰¿ç®¡ç†å‘˜åŒºï¼ˆä¸Šçº§adminï¼ŒæŠ˜å ï¼‰
â””â”€â”€ ç›´å±æˆå‘˜åŒºï¼ˆéadminæˆå‘˜ï¼‰
```

---

## äº”ã€å…·ä½“æ–‡ä»¶æ”¹åŠ¨æ¸…å•

### 5.1 åç«¯ â€” æ ¸å¿ƒä¿®å¤ï¼ˆç®¡ç†å‘˜æƒé™ç»§æ‰¿ï¼‰

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| `internal/handler/org_tree.go` | **ä¿®æ”¹** | `isOrgAdminOf` å¢åŠ ç¥–å…ˆèŠ‚ç‚¹æƒé™æ£€æŸ¥ï¼›æ–°å¢ `parseAncestorIDs` è¾…åŠ©å‡½æ•° |
| `internal/application/service/org_tree.go` | **ä¿®æ”¹** | æ–°å¢ `IsAdminOfAnyOrg` æ–¹æ³• |
| `internal/application/repository/organization.go` | **ä¿®æ”¹** | æ–°å¢ `IsAdminOfAnyOrg` æ–¹æ³•ï¼ˆå•æ¬¡ SQL æŸ¥è¯¢ï¼‰ |
| `internal/types/interfaces/org_tree.go` | **ä¿®æ”¹** | `OrgTreeService` æ–°å¢ `IsAdminOfAnyOrg` æ–¹æ³•ç­¾å |
| `internal/types/interfaces/organization.go` | **ä¿®æ”¹** | `OrganizationRepository` æ–°å¢ `IsAdminOfAnyOrg` æ–¹æ³•ç­¾å |

### 5.2 åç«¯ â€” å±•ç¤ºä¼˜åŒ–

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| `internal/types/organization.go` | ä¿®æ”¹ | `OrgTreeNode` æ–°å¢ `DirectMemberCount`ã€`TotalMemberCount` å­—æ®µ |
| `internal/types/interfaces/organization.go` | ä¿®æ”¹ | `OrganizationRepository` æ–°å¢ `BatchListMemberUserIDs` æ–¹æ³•ç­¾å |
| `internal/types/interfaces/org_tree.go` | ä¿®æ”¹ | `OrgTreeService` æ–°å¢ `ListInheritedAdmins` æ–¹æ³•ç­¾å |
| `internal/application/repository/organization.go` | ä¿®æ”¹ | æ–°å¢ `BatchListMemberUserIDs` å®ç° |
| `internal/application/service/org_tree.go` | ä¿®æ”¹ | `GetTree` å¢åŠ å­æ ‘èšåˆè®¡ç®—ï¼›æ–°å¢ `ListInheritedAdmins`ã€`computeSubtreeMemberCount` |
| `internal/handler/org_tree.go` | ä¿®æ”¹ | `ListOrgMembers` è¿”å›ç»“æ„åŒ–çš„åˆ†åŒºæ•°æ® |

### 5.2 å‰ç«¯

| æ–‡ä»¶ | æ”¹åŠ¨ç±»å‹ | è¯´æ˜ |
|------|----------|------|
| `frontend/src/views/admin/components/OrgTreeNodeItem.vue` | ä¿®æ”¹ | å±•ç¤º `total_member_count` + ç›´å±äººæ•° |
| `frontend/src/views/admin/components/MemberTable.vue` | ä¿®æ”¹ | åˆ†åŒºå±•ç¤ºç®¡ç†å‘˜/ç»§æ‰¿ç®¡ç†å‘˜/ç›´å±æˆå‘˜ |
| `frontend/src/api/org-tree.ts` (æˆ– .js) | ä¿®æ”¹ | `OrgTreeNode` ç±»å‹æ–°å¢ `direct_member_count`ã€`total_member_count` å­—æ®µï¼›`OrgMember` å“åº”ç±»å‹é€‚é…åˆ†åŒºæ•°æ® |
| `frontend/src/stores/orgTree.ts` | æ— éœ€ä¿®æ”¹ | store é€ä¼  API æ•°æ® |

### 5.3 æ•°æ®åº“

**æ— éœ€è¿ç§»**ã€‚æ‰€æœ‰æ”¹åŠ¨åœ¨åº”ç”¨å±‚è®¡ç®—ï¼Œä¸éœ€è¦ä¿®æ”¹è¡¨ç»“æ„ã€‚

---

## å…­ã€æ€§èƒ½è€ƒé‡

### 6.1 å­æ ‘äººæ•°èšåˆ

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| **A. åº”ç”¨å±‚é€’å½’è®¡ç®—ï¼ˆæ¨èï¼‰** | æ—  DB schema æ”¹åŠ¨ï¼›é€»è¾‘æ¸…æ™° | å¤§å‹ç»„ç»‡æ ‘éœ€è¦ä¸€æ¬¡åŠ è½½æ‰€æœ‰æˆå‘˜ ID |
| B. æ•°æ®åº“è§¦å‘å™¨ç»´æŠ¤è®¡æ•° | æŸ¥è¯¢å¿« | ç»´æŠ¤æˆæœ¬é«˜ï¼Œè§¦å‘å™¨å¤æ‚ |
| C. ç‰©åŒ–è§†å›¾ | æŸ¥è¯¢å¿« | éœ€è¦å®šæ—¶åˆ·æ–°ï¼Œå®æ—¶æ€§å·® |

**æ¨èæ–¹æ¡ˆ A**ï¼Œç†ç”±ï¼š
- ç»„ç»‡æ ‘é€šå¸¸è§„æ¨¡æœ‰é™ï¼ˆæ•°ååˆ°æ•°ç™¾èŠ‚ç‚¹ï¼‰
- `BatchListMemberUserIDs` å•æ¬¡ SQL æŸ¥è¯¢ï¼Œæ—  N+1
- åœ¨å†…å­˜ä¸­é€’å½’èšåˆï¼Œæ€§èƒ½å®Œå…¨å¯æ¥å—

### 6.2 ç»§æ‰¿ç®¡ç†å‘˜æŸ¥è¯¢

åˆ©ç”¨ç»„ç»‡çš„ `path` ç‰©åŒ–è·¯å¾„ï¼Œå¯ä»¥ O(1) è§£æå‡ºæ‰€æœ‰ç¥–å…ˆ IDï¼Œç„¶åä¸€æ¬¡æ‰¹é‡æŸ¥è¯¢å®Œæˆã€‚æ— éœ€é€’å½’ SQLã€‚

---

## ä¸ƒã€å…¼å®¹æ€§

| é¡¹ç›® | å…¼å®¹æ€§ |
|------|--------|
| **æƒé™æ¨¡å‹** | `isOrgAdminOf` ç”±"ä»…æŸ¥ç›´æ¥æˆå‘˜"æ”¹ä¸º"æŸ¥ç¥–å…ˆé“¾ç»§æ‰¿"ï¼Œæ‰©å¤§äº†æƒé™èŒƒå›´ã€‚åŸæœ¬éœ€è¦æ‰‹åŠ¨æ·»åŠ åˆ°å­èŠ‚ç‚¹æ‰èƒ½ç®¡ç†çš„åœºæ™¯ï¼Œç°åœ¨è‡ªåŠ¨ç»§æ‰¿ã€‚**æ— éœ€ä¿®æ”¹ä»»ä½•è°ƒç”¨ç‚¹**ã€‚|
| API ç‰ˆæœ¬ | `member_count` å­—æ®µå«ä¹‰ä»"ç›´å±"æ”¹ä¸º"æ€»è®¡"ï¼Œæ–°å¢ `direct_member_count`ã€`total_member_count`ã€‚æ—§å‰ç«¯ä»å¯ä½¿ç”¨ `member_count`ã€‚ |
| æ•°æ®åº“ | æ—  schema å˜æ›´ |
| å…±äº«ç©ºé—´ | å…±äº«ç©ºé—´ï¼ˆ`Organization` ä¸­ `tenant_id=NULL`ï¼‰ä¸æ¶‰åŠç»„ç»‡æ ‘ï¼Œä¸å—å½±å“ |
| å‰ç«¯ | `MyIsAdmin` ä¼ æ’­é€»è¾‘ä¸å˜ï¼Œ`canManageNode` è®¡ç®—ä¸å˜ã€‚åç«¯ä¿®å¤åå‰åç«¯è¡¨ç°ä¸€è‡´ã€‚ |

---

## å…«ã€æµ‹è¯•è¦ç‚¹

### 8.1 æ ¸å¿ƒä¿®å¤æµ‹è¯•ï¼ˆisOrgAdminOf ç»§æ‰¿ï¼‰

| ç”¨ä¾‹ | è¯´æ˜ |
|------|------|
| `TestIsOrgAdminOf_DirectAdmin` | ç”¨æˆ·æ˜¯ç›®æ ‡èŠ‚ç‚¹ç›´æ¥ admin â†’ true |
| `TestIsOrgAdminOf_ParentAdmin` | ç”¨æˆ·æ˜¯çˆ¶èŠ‚ç‚¹ admin â†’ trueï¼ˆç»§æ‰¿ï¼‰ |
| `TestIsOrgAdminOf_GrandparentAdmin` | ç”¨æˆ·æ˜¯ç¥–çˆ¶èŠ‚ç‚¹ admin â†’ trueï¼ˆå¤šçº§ç»§æ‰¿ï¼‰ |
| `TestIsOrgAdminOf_SiblingAdmin` | ç”¨æˆ·æ˜¯å…„å¼ŸèŠ‚ç‚¹ admin â†’ falseï¼ˆä¸åº”ç»§æ‰¿ï¼‰ |
| `TestIsOrgAdminOf_ChildAdmin` | ç”¨æˆ·æ˜¯å­èŠ‚ç‚¹ admin â†’ falseï¼ˆå‘ä¸Šä¸ç»§æ‰¿ï¼‰ |
| `TestIsOrgAdminOf_NonAdmin` | ç”¨æˆ·æ˜¯ viewer/editor è§’è‰² â†’ false |
| `TestIsOrgAdminOf_RootNode` | æ ¹èŠ‚ç‚¹æ— ç¥–å…ˆï¼Œåªæ£€æŸ¥ç›´æ¥æˆå‘˜ |
| `TestIsOrgAdminOf_SuperAdmin` | è¶…çº§ç®¡ç†å‘˜å¯¹ä»»ä½•èŠ‚ç‚¹éƒ½è¿”å› true |
| `TestParseAncestorIDs` | éªŒè¯è·¯å¾„è§£æï¼š`/a/b/c` â†’ `["a", "b"]`ï¼ˆä¸å« self `c`ï¼‰ |

### 8.2 å±•ç¤ºä¼˜åŒ–å•å…ƒæµ‹è¯•

| ç”¨ä¾‹ | è¯´æ˜ |
|------|------|
| `TestComputeSubtreeMemberCount_SingleNode` | æ— å­èŠ‚ç‚¹ï¼Œtotal = direct |
| `TestComputeSubtreeMemberCount_WithChildren` | å«å­èŠ‚ç‚¹ï¼ŒéªŒè¯é€’å½’æ±‡æ€» |
| `TestComputeSubtreeMemberCount_Dedup` | åŒä¸€ç”¨æˆ·åˆ†é…åˆ°å¤šä¸ªå­èŠ‚ç‚¹ï¼Œä»…è®¡ä¸€æ¬¡ |
| `TestListInheritedAdmins_NoAncestor` | æ ¹èŠ‚ç‚¹æ— ç»§æ‰¿ç®¡ç†å‘˜ |
| `TestListInheritedAdmins_WithAncestors` | å¤šå±‚ç»§æ‰¿ï¼ŒéªŒè¯è·¯å¾„è§£æ |
| `TestListInheritedAdmins_ExcludeDirect` | ç¥–å…ˆç®¡ç†å‘˜åŒæ—¶æ˜¯ç›´å±æˆå‘˜æ—¶æ’é™¤ |

### 8.3 é›†æˆæµ‹è¯•

| ç”¨ä¾‹ | è¯´æ˜ |
|------|------|
| **çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜æ“ä½œå­èŠ‚ç‚¹** | åˆ›å»ºä¸‰çº§ç»„ç»‡æ ‘ â†’ L2 admin ç¼–è¾‘/åˆ é™¤/åˆ†é… L3 èŠ‚ç‚¹ â†’ åº”å…¨éƒ¨æˆåŠŸ |
| **çˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜ä¸åœ¨å­èŠ‚ç‚¹æˆå‘˜åˆ—è¡¨** | yanfa ä¸º L2 admin â†’ L3 çš„ `ListOrgMembers` ä¸åŒ…å« yanfa |
| åˆ›å»ºä¸‰çº§ç»„ç»‡æ ‘ â†’ å„çº§åˆ†é…æˆå‘˜ â†’ éªŒè¯æ ¹èŠ‚ç‚¹ total count | ç«¯åˆ°ç«¯éªŒè¯ |
| é€’å½’æŸ¥è¯¢ `?recursive=true` è¿”å›æ‰€æœ‰å»é‡æˆå‘˜ | èšåˆè§†å›¾éªŒè¯ |
| **æ•°æ®æ¸…ç†ååŠŸèƒ½æ­£å¸¸** | æ¸…ç†å†—ä½™ admin è®°å½•åï¼Œæƒé™ç»§æ‰¿ä»æ­£å¸¸ |

---

## ä¹ã€å®æ–½è®¡åˆ’

| é˜¶æ®µ | å†…å®¹ | ä¼˜å…ˆçº§ | é¢„ä¼°å·¥æ—¶ |
|------|------|--------|----------|
| **Phase 0** | **åç«¯ï¼šä¿®å¤ `isOrgAdminOf` ç¥–å…ˆç»§æ‰¿ + `IsAdminOfAnyOrg`** | **P0 å…³é”®** | **2h** |
| Phase 1 | åç«¯ï¼š`BatchListMemberUserIDs` + `computeSubtreeMemberCount` | P1 | 2h |
| Phase 2 | åç«¯ï¼š`ListInheritedAdmins` + `ListOrgMembers` è¿”å›åˆ†åŒºæ•°æ® | P1 | 2h |
| Phase 3 | å‰ç«¯ï¼š`OrgTreeNodeItem.vue` å±•ç¤º total + direct | P2 | 1h |
| Phase 4 | å‰ç«¯ï¼š`MemberTable.vue` åˆ†åŒºå±•ç¤ºæ”¹é€  | P2 | 3h |
| Phase 5 | æ•°æ®æ¸…ç†ï¼šæ¸…ç†å†—ä½™ admin è®°å½• | P1 | 1h |
| Phase 6 | å•å…ƒæµ‹è¯• + é›†æˆæµ‹è¯• | P1 | 3h |
| **åˆè®¡** | | | **14h** |

> **Phase 0 æ˜¯æ ¸å¿ƒä¿®å¤**ï¼Œè§£å†³äº†ç®¡ç†å‘˜æƒé™ç»§æ‰¿ç¼ºé™·ï¼Œå¿…é¡»ä¼˜å…ˆå®æ–½ã€‚å…¶ä½™ Phase ä¸ºå±•ç¤ºå±‚ä¼˜åŒ–ï¼Œå¯æŒ‰éœ€æ’æœŸã€‚

---

## åã€ç®¡ç†å‘˜æƒé™ç»§æ‰¿ä¿®å¤æ–¹æ¡ˆï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰

### 10.1 æ–¹æ¡ˆæ¦‚è¿°

**ä¿®å¤ `isOrgAdminOf` æ–¹æ³•**ï¼Œä½¿å…¶æ”¯æŒåŸºäº `path` ç‰©åŒ–è·¯å¾„çš„ç¥–å…ˆèŠ‚ç‚¹æƒé™ç»§æ‰¿ã€‚è¿™æ˜¯ä¸€ä¸ª**å•ç‚¹ä¿®å¤**ï¼Œæ‰€æœ‰ 13 ä¸ªè°ƒç”¨ç‚¹è‡ªåŠ¨å—ç›Šï¼Œæ— éœ€é€ä¸ªä¿®æ”¹ã€‚

### 10.2 ä¿®å¤åçš„ isOrgAdminOf

```go
// handler/org_tree.go â€” æ›¿æ¢ç°æœ‰ isOrgAdminOf
// isOrgAdminOf checks if the given user is an admin of the specified organization
// or any of its ancestor organizations (permission inheritance via path).
// Super admins are always considered admin of any org.
func (h *OrgTreeHandler) isOrgAdminOf(c *gin.Context, user *types.User, orgID string, tenantID uint64) bool {
    if user.IsSuperAdmin {
        return true
    }
    ctx := c.Request.Context()

    // 1. å…ˆæ£€æŸ¥ç›®æ ‡èŠ‚ç‚¹æœ¬èº«ï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰
    orgMembers, err := h.orgTreeService.ListOrgMembers(ctx, orgID, tenantID)
    if err != nil {
        return false
    }
    for _, member := range orgMembers {
        if member.UserID == user.ID && member.Role == types.OrgRoleAdmin {
            return true
        }
    }

    // 2. è·å–ç›®æ ‡èŠ‚ç‚¹çš„ pathï¼Œè§£ææ‰€æœ‰ç¥–å…ˆ ID
    org, err := h.orgTreeService.GetNode(ctx, orgID, tenantID)
    if err != nil {
        return false
    }

    // path æ ¼å¼: /root_id/parent_id/self_id
    ancestorIDs := parseAncestorIDs(org.Path, orgID)
    if len(ancestorIDs) == 0 {
        return false // æ ¹èŠ‚ç‚¹ï¼Œæ— ç¥–å…ˆå¯æ£€æŸ¥
    }

    // 3. æ‰¹é‡æŸ¥è¯¢ç¥–å…ˆèŠ‚ç‚¹ä¸­ç”¨æˆ·æ˜¯å¦ä¸º admin
    return h.orgTreeService.IsAdminOfAnyOrg(ctx, user.ID, ancestorIDs, tenantID)
}

// parseAncestorIDs ä»ç‰©åŒ–è·¯å¾„ä¸­æå–ç¥–å…ˆèŠ‚ç‚¹ IDï¼ˆä¸å«è‡ªèº«ï¼‰
// path æ ¼å¼: /root_id/parent_id/self_id
func parseAncestorIDs(path string, selfID string) []string {
    parts := strings.Split(strings.TrimPrefix(path, "/"), "/")
    ancestors := make([]string, 0, len(parts)-1)
    for _, part := range parts {
        if part != "" && part != selfID {
            ancestors = append(ancestors, part)
        }
    }
    return ancestors
}
```

### 10.3 æ–°å¢ Service å±‚æ–¹æ³•

```go
// service/org_tree.go â€” æ–°å¢
// IsAdminOfAnyOrg checks if the user is an admin of any of the specified organizations
func (s *orgTreeService) IsAdminOfAnyOrg(ctx context.Context, userID string, orgIDs []string, tenantID uint64) bool {
    if len(orgIDs) == 0 {
        return false
    }
    return s.orgRepo.IsAdminOfAnyOrg(ctx, userID, orgIDs, tenantID)
}
```

### 10.4 æ–°å¢ Repository å±‚æ–¹æ³•

```go
// repository/organization.go â€” æ–°å¢
// IsAdminOfAnyOrg checks if user is admin of any org in the given list (single SQL query)
func (r *organizationRepository) IsAdminOfAnyOrg(ctx context.Context, userID string, orgIDs []string, tenantID uint64) bool {
    var count int64
    err := r.db.WithContext(ctx).
        Model(&types.OrganizationMember{}).
        Where("user_id = ? AND organization_id IN ? AND role = ? AND tenant_id = ?",
            userID, orgIDs, types.OrgRoleAdmin, tenantID).
        Limit(1).
        Count(&count).Error
    if err != nil {
        return false
    }
    return count > 0
}
```

### 10.5 æ¥å£å®šä¹‰æ›´æ–°

```go
// types/interfaces/org_tree.go â€” OrgTreeService æ–°å¢æ–¹æ³•ç­¾å
type OrgTreeService interface {
    // ...existing methods...
    IsAdminOfAnyOrg(ctx context.Context, userID string, orgIDs []string, tenantID uint64) bool
}

// types/interfaces/organization.go â€” OrganizationRepository æ–°å¢æ–¹æ³•ç­¾å
type OrganizationRepository interface {
    // ...existing methods...
    IsAdminOfAnyOrg(ctx context.Context, userID string, orgIDs []string, tenantID uint64) bool
}
```

### 10.6 æ€§èƒ½ä¼˜åŒ–

ä¿®å¤å `isOrgAdminOf` çš„æŸ¥è¯¢é€»è¾‘ï¼š

```
æ­¥éª¤ 1: æ£€æŸ¥ç›®æ ‡èŠ‚ç‚¹ç›´æ¥æˆå‘˜ï¼ˆç°æœ‰é€»è¾‘ï¼Œå¿«é€Ÿè·¯å¾„ï¼‰
    â†’ å‘½ä¸­åˆ™è¿”å› trueï¼ˆå¤§å¤šæ•°æƒ…å†µåœ¨æ­¤ç»“æŸï¼‰

æ­¥éª¤ 2: æœªå‘½ä¸­åˆ™è·å–èŠ‚ç‚¹ pathï¼ˆ1 æ¬¡ DB æŸ¥è¯¢ï¼Œæˆ–åˆ©ç”¨ç¼“å­˜ï¼‰

æ­¥éª¤ 3: è§£æ path ä¸­çš„ç¥–å…ˆ IDï¼ˆçº¯å†…å­˜æ“ä½œï¼ŒO(1)ï¼‰

æ­¥éª¤ 4: æ‰¹é‡æŸ¥è¯¢ç¥–å…ˆèŠ‚ç‚¹ä¸­çš„ admin è§’è‰²ï¼ˆ1 æ¬¡ SQLï¼š
    SELECT COUNT(*) FROM organization_members 
    WHERE user_id = ? AND organization_id IN (?) AND role = 'admin'
    LIMIT 1
ï¼‰
```

**æœ€åæƒ…å†µ**ï¼š2 æ¬¡é¢å¤– DB æŸ¥è¯¢ï¼ˆè·å–èŠ‚ç‚¹ + æŸ¥è¯¢ç¥–å…ˆ adminï¼‰  
**æœ€ä¼˜æƒ…å†µ**ï¼š0 æ¬¡é¢å¤–æŸ¥è¯¢ï¼ˆç”¨æˆ·æ˜¯ç›®æ ‡èŠ‚ç‚¹çš„ç›´æ¥ adminï¼Œåœ¨æ­¥éª¤ 1 å‘½ä¸­ï¼‰  
**ç¼“å­˜ä¼˜åŒ–**ï¼ˆå¯é€‰ï¼‰ï¼šå¯ä»¥å¯¹ `org.Path` åšå†…å­˜ç¼“å­˜ï¼Œå°†æ­¥éª¤ 2 çš„ DB æŸ¥è¯¢ä¹Ÿçœæ‰

### 10.7 ä¿®å¤åçš„æ•°æ®ä¸€è‡´æ€§

ä¿®å¤å‰åå¯¹æ¯”ï¼š

```
åœºæ™¯ï¼šyanfa æ˜¯"ç ”å‘éƒ¨"(L2)çš„ç®¡ç†å‘˜ï¼Œ"äº§å“éƒ¨"(L3)æ˜¯ç ”å‘éƒ¨çš„å­èŠ‚ç‚¹

ã€ä¿®å¤å‰ã€‘
  å‰ç«¯æ˜¾ç¤ºï¼šyanfa åœ¨äº§å“éƒ¨ â†’ MyIsAdmin=trueï¼ˆå¯ç®¡ç†ï¼‰  âœ… é€šè¿‡ copyNodeTree ä¼ æ’­
  åç«¯æƒé™ï¼šisOrgAdminOf("äº§å“éƒ¨") â†’ false             âŒ ä¸æŸ¥ç¥–å…ˆ
  å˜é€šæªæ–½ï¼šæ‰‹åŠ¨æŠŠ yanfa æ·»åŠ åˆ°äº§å“éƒ¨çš„ organization_members  â†’ ç®¡ç†å‘˜é‡å¤å‡ºç°

ã€ä¿®å¤åã€‘
  å‰ç«¯æ˜¾ç¤ºï¼šyanfa åœ¨äº§å“éƒ¨ â†’ MyIsAdmin=trueï¼ˆå¯ç®¡ç†ï¼‰  âœ… ä¸å˜
  åç«¯æƒé™ï¼šisOrgAdminOf("äº§å“éƒ¨") â†’ true              âœ… æ£€æŸ¥ç¥–å…ˆ â†’ ç ”å‘éƒ¨æœ‰ admin
  æˆå‘˜åˆ—è¡¨ï¼šäº§å“éƒ¨çš„ organization_members ä¸­æ²¡æœ‰ yanfa  âœ… ä¸å†éœ€è¦æ‰‹åŠ¨æ·»åŠ 
```

### 10.8 æ•°æ®æ¸…ç†

ä¿®å¤ä¸Šçº¿åï¼Œéœ€è¦æ¸…ç†å†å²ä¸Šå› å˜é€šæªæ–½äº§ç”Ÿçš„å†—ä½™ admin è®°å½•ï¼š

```sql
-- æ‰¾å‡ºé‡å¤çš„ admin è®°å½•ï¼šç”¨æˆ·åœ¨å­èŠ‚ç‚¹å’Œç¥–å…ˆèŠ‚ç‚¹éƒ½æœ‰ admin è§’è‰²
-- ä»¥ä¸‹ SQL ä»…ä¾›äººå·¥å®¡æŸ¥ï¼Œéœ€ DBA ç¡®è®¤åæ‰§è¡Œ
WITH admin_with_path AS (
    SELECT om.id, om.user_id, om.organization_id, o.path, o.parent_id
    FROM organization_members om
    JOIN organizations o ON o.id = om.organization_id
    WHERE om.role = 'admin'
)
SELECT child.id AS redundant_member_id, 
       child.user_id, 
       child.organization_id AS child_org_id,
       parent.organization_id AS parent_org_id
FROM admin_with_path child
JOIN admin_with_path parent 
  ON child.user_id = parent.user_id 
  AND child.path LIKE CONCAT(parent.path, '/%')
ORDER BY child.user_id, child.path;
```

---

## åä¸€ã€FAQ

**Q1ï¼šä¸ºä½•ä¸åœ¨æ•°æ®åº“ä¸­ç»´æŠ¤ä¸€ä¸ª `total_member_count` å­—æ®µï¼Ÿ**  
Aï¼šç»„ç»‡æ ‘è§„æ¨¡é€šå¸¸æœ‰é™ï¼ˆæ•°ååˆ°æ•°ç™¾èŠ‚ç‚¹ï¼‰ï¼Œåº”ç”¨å±‚è®¡ç®—æˆæœ¬ä½ã€‚æ•°æ®åº“å­—æ®µéœ€è¦åœ¨æ¯æ¬¡æˆå‘˜å˜åŠ¨æ—¶è§¦å‘æ›´æ–°ï¼ˆæ·»åŠ /ç§»é™¤/ç§»åŠ¨èŠ‚ç‚¹ï¼‰ï¼Œç»´æŠ¤æˆæœ¬é«˜ä¸”å®¹æ˜“ä¸ä¸€è‡´ã€‚

**Q2ï¼š`isOrgAdminOf` ä¿®å¤åï¼Œ`copyNodeTree` ä¸­çš„ `MyIsAdmin` ä¼ æ’­è¿˜æœ‰ç”¨å—ï¼Ÿ**  
Aï¼šæœ‰ç”¨ã€‚`copyNodeTree` çš„ `MyIsAdmin` ä¼ æ’­ç”¨äº**å‰ç«¯ UI æ˜¾ç¤º**ï¼ˆæ˜¯å¦æ˜¾ç¤ºç®¡ç†æŒ‰é’®ï¼‰ï¼Œé¿å…å‰ç«¯é€ä¸ªè°ƒç”¨ API åˆ¤æ–­æƒé™ã€‚`isOrgAdminOf` ç”¨äº**åç«¯ API å®é™…æƒé™åˆ¤æ–­**ã€‚ä¸¤è€…èŒè´£ä¸åŒï¼Œä½†ä¿®å¤åé€»è¾‘ä¸€è‡´â€”â€”éƒ½æ”¯æŒç¥–å…ˆç»§æ‰¿ã€‚

**Q3ï¼šå¦‚æœä¸€ä¸ªç”¨æˆ·åŒæ—¶è¢«åˆ†é…åˆ°äºŒçº§å’Œä¸‰çº§ç»„ç»‡ï¼Œç®—å‡ ä¸ªäººï¼Ÿ**  
Aï¼šåœ¨ `total_member_count` ä¸­åªç®— 1 ä¸ªäººï¼ˆå»é‡ï¼‰ã€‚åœ¨ `direct_member_count` ä¸­ï¼ŒäºŒçº§å’Œä¸‰çº§å„ç®— 1ã€‚åœ¨æˆå‘˜åˆ—è¡¨ä¸­ï¼Œè¯¥ç”¨æˆ·ä¼šå‡ºç°åœ¨å„è‡ªçš„ç›´å±æˆå‘˜åŒºä¸­ã€‚

**Q4ï¼šå…±äº«ç©ºé—´çš„ç»„ç»‡å—å½±å“å—ï¼Ÿ**  
Aï¼šä¸å—å½±å“ã€‚å…±äº«ç©ºé—´çš„ç»„ç»‡ï¼ˆ`tenant_id=NULL`ï¼‰ä½¿ç”¨ `OrganizationHandler` å’Œ `OrganizationService`ï¼ˆé OrgTree ç³»åˆ—ï¼‰ï¼Œä¸ç»è¿‡æœ¬æ–¹æ¡ˆæ¶‰åŠçš„ä»£ç è·¯å¾„ã€‚

**Q5ï¼šä¿®å¤ `isOrgAdminOf` ä¼šä¸ä¼šæœ‰å®‰å…¨é£é™©ï¼Ÿ**  
Aï¼šä¸ä¼šã€‚ä¿®å¤ä»…**æ‰©å¤§**äº†æƒé™ç»§æ‰¿èŒƒå›´ï¼ˆçˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜å¯ç®¡ç†å­èŠ‚ç‚¹ï¼‰ï¼Œè¿™ç¬¦åˆç»„ç»‡æ¶æ„çš„å¤©ç„¶å±‚çº§å…³ç³»ã€‚ä¸ä¼šè®©éç®¡ç†å‘˜è·å¾—é¢å¤–æƒé™ã€‚

**Q6ï¼šä¸ºä½•ä¸åœ¨ `CreateNode` ä¸­è‡ªåŠ¨æŠŠçˆ¶èŠ‚ç‚¹ç®¡ç†å‘˜å¤åˆ¶åˆ°å­èŠ‚ç‚¹ï¼Ÿ**  
Aï¼šè¿™æ­£æ˜¯å½“å‰çš„å˜é€šæªæ–½ï¼Œä¼šå¯¼è‡´ï¼š(1) ç®¡ç†å‘˜åœ¨æ¯ä¸ªå­èŠ‚ç‚¹é‡å¤å‡ºç°ï¼›(2) ç§»åŠ¨èŠ‚ç‚¹æ—¶éœ€è¦åŒæ­¥æ›´æ–°æˆå‘˜å…³ç³»ï¼›(3) ç§»é™¤ç®¡ç†å‘˜æ—¶éœ€è¦é€’å½’æ¸…ç†ã€‚é€šè¿‡åœ¨ `isOrgAdminOf` ä¸­æ”¯æŒç»§æ‰¿ï¼Œè¿™äº›é—®é¢˜éƒ½ä¸å­˜åœ¨ã€‚

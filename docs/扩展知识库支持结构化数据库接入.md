# ç»“æ„åŒ–æ•°æ®åº“æ¥å…¥çŸ¥è¯†åº“æ‰©å±•æŠ€æœ¯æ–¹æ¡ˆ

> **ç‰ˆæœ¬**: v1.0  
> **æ—¥æœŸ**: 2026-02-12  
> **æ–‡æ¡£çº§åˆ«**: æ¶æ„è¯„å®¡æ–‡æ¡£  
> **é€‚ç”¨è¯»è€…**: æ¶æ„å¸ˆã€åç«¯é«˜çº§å·¥ç¨‹å¸ˆã€AIåŸºç¡€è®¾æ–½å·¥ç¨‹å¸ˆã€CTO  

---

## ç›®å½•

- [ä¸€ã€ç°æœ‰ç³»ç»Ÿæ¶æ„åˆ†æ](#ä¸€ç°æœ‰ç³»ç»Ÿæ¶æ„åˆ†æ)
- [äºŒã€å½“å‰çŸ¥è¯†åº“èƒ½åŠ›è¾¹ç•Œä¸é—®é¢˜](#äºŒå½“å‰çŸ¥è¯†åº“èƒ½åŠ›è¾¹ç•Œä¸é—®é¢˜)
- [ä¸‰ã€æ‰©å±•ç›®æ ‡ä¸è®¾è®¡åŸåˆ™](#ä¸‰æ‰©å±•ç›®æ ‡ä¸è®¾è®¡åŸåˆ™)
- [å››ã€æ€»ä½“ç›®æ ‡æ¶æ„è®¾è®¡](#å››æ€»ä½“ç›®æ ‡æ¶æ„è®¾è®¡)
- [äº”ã€æ•°æ®åº“è¿æ¥å±‚è®¾è®¡](#äº”æ•°æ®åº“è¿æ¥å±‚è®¾è®¡)
- [å…­ã€æ•°æ®åŒæ­¥ä¸æŠ½å–ç­–ç•¥](#å…­æ•°æ®åŒæ­¥ä¸æŠ½å–ç­–ç•¥å…¨é‡--å¢é‡--cdc)
- [ä¸ƒã€ç»“æ„åŒ–ç´¢å¼•ä¸å‘é‡ç´¢å¼•èåˆç­–ç•¥](#ä¸ƒç»“æ„åŒ–ç´¢å¼•ä¸å‘é‡ç´¢å¼•èåˆç­–ç•¥)
- [å…«ã€å…ƒæ•°æ®æ³¨å†Œä¸ Schema ç®¡ç†æœºåˆ¶](#å…«å…ƒæ•°æ®æ³¨å†Œä¸-schema-ç®¡ç†æœºåˆ¶)
- [ä¹ã€æŸ¥è¯¢ä¸åˆ†ææµç¨‹è®¾è®¡](#ä¹æŸ¥è¯¢ä¸åˆ†ææµç¨‹è®¾è®¡)
- [åã€æŠ€æœ¯é€‰å‹å¯¹æ¯”åˆ†æ](#åæŠ€æœ¯é€‰å‹å¯¹æ¯”åˆ†æ)
- [åä¸€ã€æ€§èƒ½ä¸æ‰©å±•æ€§è®¾è®¡](#åä¸€æ€§èƒ½ä¸æ‰©å±•æ€§è®¾è®¡)
- [åäºŒã€å®‰å…¨ä¸æƒé™æ§åˆ¶è®¾è®¡](#åäºŒå®‰å…¨ä¸æƒé™æ§åˆ¶è®¾è®¡)
- [åä¸‰ã€é£é™©è¯„ä¼°](#åä¸‰é£é™©è¯„ä¼°)
- [åå››ã€åˆ†é˜¶æ®µå®æ–½è·¯çº¿](#åå››åˆ†é˜¶æ®µå®æ–½è·¯çº¿)
- [åäº”ã€æœªæ¥æ¼”è¿›æ–¹å‘](#åäº”æœªæ¥æ¼”è¿›æ–¹å‘)

---

## ä¸€ã€ç°æœ‰ç³»ç»Ÿæ¶æ„åˆ†æ

### 1.1 ç³»ç»Ÿæ€»ä½“æ¶æ„

WeKnora æ˜¯ä¸€ä¸ªåŸºäº Go è¯­è¨€å¼€å‘çš„ä¼ä¸šçº§çŸ¥è¯†åº“ç®¡ç†ä¸æ™ºèƒ½é—®ç­”å¹³å°ï¼Œé‡‡ç”¨åˆ†å±‚æ¶æ„è®¾è®¡ï¼Œæ ¸å¿ƒåˆ†å±‚å¦‚ä¸‹ï¼š

```mermaid
graph TB
    subgraph "æ¥å…¥å±‚"
        A[Gin HTTP Router] --> B[Handler å±‚]
        B --> C[Middleware é‰´æƒ/ç§Ÿæˆ·éš”ç¦»]
    end

    subgraph "ä¸šåŠ¡æœåŠ¡å±‚"
        D[KnowledgeBaseService]
        E[KnowledgeService]
        F[ChunkService]
        G[SessionService]
        H[AgentService]
        I[ChatPipeline]
        J[ModelService]
    end

    subgraph "æ£€ç´¢å¼•æ“å±‚"
        K[RetrieveEngineRegistry]
        L[CompositeRetrieveEngine]
        M[KVHybridRetrieveEngine]
    end

    subgraph "å­˜å‚¨å¼•æ“å±‚"
        N[PostgreSQL - pgvector]
        O[Elasticsearch v7/v8]
        P[Qdrant]
        Q[Neo4j - çŸ¥è¯†å›¾è°±]
        R[DuckDB - æ•°æ®åˆ†æ]
    end

    subgraph "å¤–éƒ¨æœåŠ¡"
        S[DocReader - æ–‡æ¡£è§£æ]
        T[Embedding Models]
        U[LLM Chat Models]
        V[Rerank Models]
    end

    B --> D & E & F & G & H
    H --> I
    I --> L
    D & E & F --> K
    K --> M
    M --> N & O & P
    H --> Q
    I --> R
    D & E --> S
    E --> T
    I --> U & V
```

### 1.2 ä¾èµ–æ³¨å…¥ä¸å®¹å™¨æœºåˆ¶

ç³»ç»Ÿé‡‡ç”¨ `uber/dig` ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œé€šè¿‡ `container.BuildContainer()` ç»Ÿä¸€ç®¡ç†æ‰€æœ‰æœåŠ¡å®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸã€‚æ ¸å¿ƒç»„ä»¶æ³¨å†Œé“¾è·¯ï¼š

1. **åŸºç¡€è®¾æ–½å±‚**: `Config â†’ Database (PostgreSQL/GORM) â†’ Redis â†’ AntsPool â†’ Tracer`
2. **å­˜å‚¨å±‚**: `KnowledgeBaseRepository â†’ KnowledgeRepository â†’ ChunkRepository â†’ ...`
3. **æ£€ç´¢å¼•æ“å±‚**: `RetrieveEngineRegistry â†’ PostgresRepo / ElasticsearchRepo / QdrantRepo`
4. **ä¸šåŠ¡å±‚**: `KnowledgeBaseService â†’ KnowledgeService â†’ ChunkService â†’ SessionService â†’ AgentService`
5. **Pipelineå±‚**: `EventManager â†’ PluginSearch â†’ PluginRerank â†’ PluginMerge â†’ PluginDataAnalysis â†’ PluginChatCompletion`
6. **æ¥å£å±‚**: `Handler â†’ Router`

### 1.3 çŸ¥è¯†åº“ç±»å‹å®šä¹‰

å½“å‰çŸ¥è¯†åº“ç±»å‹ä»…æ”¯æŒä¸¤ç§ï¼ˆ`internal/types/knowledgebase.go`ï¼‰ï¼š

| ç±»å‹ | å¸¸é‡ | è¯´æ˜ |
|------|------|------|
| æ–‡æ¡£çŸ¥è¯†åº“ | `KnowledgeBaseTypeDocument = "document"` | ä¸Šä¼ æ–‡æ¡£ï¼ˆPDF/Word/Markdownç­‰ï¼‰è¿›è¡Œåˆ‡ç‰‡ã€å‘é‡åŒ–ã€æ£€ç´¢ |
| FAQçŸ¥è¯†åº“ | `KnowledgeBaseTypeFAQ = "faq"` | é—®ç­”å¯¹æ ¼å¼ï¼Œæ”¯æŒç›¸ä¼¼é—®å¯¼å…¥ï¼Œä¸“ç”¨ç´¢å¼•æ¨¡å¼ |

### 1.4 æ£€ç´¢å¼•æ“æ¶æ„

ç³»ç»Ÿå®ç°äº†æ’ä»¶åŒ–çš„æ£€ç´¢å¼•æ“æ³¨å†Œæœºåˆ¶ï¼ˆ`RetrieveEngineRegistry`ï¼‰ï¼Œå½“å‰æ”¯æŒï¼š

| å¼•æ“ç±»å‹ | å¸¸é‡ | æ”¯æŒçš„æ£€ç´¢æ–¹å¼ | è¯´æ˜ |
|----------|------|----------------|------|
| PostgreSQL (pgvector) | `PostgresRetrieverEngineType` | å…³é”®è¯ + å‘é‡ | åŸºäº pgvector æ‰©å±•çš„å‘é‡æ£€ç´¢ |
| Elasticsearch v7/v8 | `ElasticsearchRetrieverEngineType` | å…³é”®è¯ + å‘é‡ | BM25 + dense vector |
| Qdrant | `QdrantRetrieverEngineType` | å…³é”®è¯ + å‘é‡ | ä¸“ä¸šå‘é‡æ•°æ®åº“ |

æ£€ç´¢å¼•æ“é€šè¿‡ `RETRIEVE_DRIVER` ç¯å¢ƒå˜é‡åŠ¨æ€åŠ è½½ï¼ˆæ”¯æŒé€—å·åˆ†éš”å¤šå¼•æ“ï¼‰ï¼Œæ‰€æœ‰å¼•æ“å®ç°ç»Ÿä¸€çš„ `RetrieveEngineRepository` æ¥å£ï¼š

```go
type RetrieveEngineRepository interface {
    Save(ctx context.Context, indexInfo *IndexInfo, params map[string]any) error
    BatchSave(ctx context.Context, indexInfoList []*IndexInfo, params map[string]any) error
    Retrieve(ctx context.Context, params RetrieveParams) ([]*RetrieveResult, error)
    DeleteByChunkIDList(ctx context.Context, indexIDList []string, dimension int, knowledgeType string) error
    // ...
}
```

### 1.5 Chat Pipeline æ¶æ„

å¯¹è¯å¤„ç†é‡‡ç”¨äº‹ä»¶é©±åŠ¨çš„ Pipeline æ¨¡å¼ï¼š

```
Rewrite â†’ Search â†’ SearchEntity â†’ SearchParallel â†’ Rerank â†’ FilterTopK â†’ Merge 
â†’ DataAnalysis â†’ IntoChatMessage â†’ ChatCompletion â†’ StreamFilter
```

å…¶ä¸­ `PluginDataAnalysis` å·²å®ç°äº†å¯¹ CSV/Excel ç»“æ„åŒ–æ–‡ä»¶çš„ DuckDB SQL åˆ†æèƒ½åŠ›ï¼Œæ˜¯ç»“æ„åŒ–æ•°æ®åˆ†æçš„åˆæ­¥æ¢ç´¢ã€‚

### 1.6 æ•°æ®å­˜å‚¨ä¸€è§ˆ

| ç»„ä»¶ | ç”¨é€” | æŠ€æœ¯ |
|------|------|------|
| PostgreSQL | ä¸šåŠ¡æ•°æ®ä¸»åº“ | GORM ORM |
| pgvector | å‘é‡å­˜å‚¨/æ£€ç´¢ | pgvector-go |
| Elasticsearch | å…¨æ–‡æ£€ç´¢ + å‘é‡æ£€ç´¢ | go-elasticsearch v7/v8 |
| Qdrant | å‘é‡å­˜å‚¨/æ£€ç´¢ | go-client |
| Neo4j | çŸ¥è¯†å›¾è°± | neo4j-go-driver |
| DuckDB | å†…å­˜æ•°æ®åˆ†æ | duckdb-go (å†…å­˜æ¨¡å¼) |
| Redis | ç¼“å­˜/æµç®¡ç†/ä¸Šä¸‹æ–‡å­˜å‚¨ | go-redis |
| MinIO/COS/Local | æ–‡ä»¶å¯¹è±¡å­˜å‚¨ | minio-go / COS SDK |

---

## äºŒã€å½“å‰çŸ¥è¯†åº“èƒ½åŠ›è¾¹ç•Œä¸é—®é¢˜

### 2.1 èƒ½åŠ›è¾¹ç•Œ

| ç»´åº¦ | å½“å‰èƒ½åŠ› | é™åˆ¶ |
|------|----------|------|
| **æ•°æ®æºç±»å‹** | æ–‡æ¡£æ–‡ä»¶ï¼ˆPDF/Word/MD/HTML/CSV/Excelï¼‰ã€æ‰‹åŠ¨å½•å…¥ã€FAQå¯¼å…¥ | ä¸æ”¯æŒå®æ—¶è¿æ¥å¤–éƒ¨æ•°æ®åº“ |
| **æ•°æ®æ¥å…¥æ–¹å¼** | æ–‡ä»¶ä¸Šä¼  â†’ DocReaderè§£æ â†’ åˆ‡ç‰‡ â†’ å‘é‡åŒ– â†’ å…¥åº“ | ä»…æ”¯æŒç¦»çº¿æ‰¹é‡å¯¼å…¥ï¼Œæ— åœ¨çº¿æŸ¥è¯¢èƒ½åŠ› |
| **ç»“æ„åŒ–æ•°æ®å¤„ç†** | CSV/Excelé€šè¿‡DuckDBä¸´æ—¶åŠ è½½åšSQLåˆ†æ | æ— æŒä¹…åŒ–è¿æ¥ï¼Œæ— Schemaç®¡ç†ï¼Œæ— å¢é‡åŒæ­¥ |
| **æ£€ç´¢æ–¹å¼** | å‘é‡æ£€ç´¢ + BM25å…³é”®è¯æ£€ç´¢ + çŸ¥è¯†å›¾è°±æ£€ç´¢ | ä¸æ”¯æŒSQLç›´æŸ¥ã€ä¸æ”¯æŒç»“æ„åŒ–è¿‡æ»¤æ¡ä»¶ |
| **çŸ¥è¯†åº“ç±»å‹** | Document / FAQ | ç¼ºå°‘ Database / Structured ç±»å‹ |
| **å¤šæ•°æ®åº“æ”¯æŒ** | ä»…PostgreSQLä½œä¸ºç³»ç»Ÿæ•°æ®åº“ | ä¸æ”¯æŒè¿æ¥å¤–éƒ¨MySQL/Oracle/SQL Server/ClickHouse |

### 2.2 æ ¸å¿ƒé—®é¢˜åˆ†æ

**é—®é¢˜ä¸€ï¼šç»“æ„åŒ–æ•°æ®æ— æ³•ä½œä¸ºçŸ¥è¯†æº**

ä¼ä¸šä¸­å¤§é‡å…³é”®æ•°æ®å­˜å‚¨åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼ˆCRMã€ERPã€è´¢åŠ¡ç³»ç»Ÿç­‰ï¼‰ï¼Œå½“å‰æ¶æ„è¦æ±‚æ•°æ®å¿…é¡»å…ˆå¯¼å‡ºä¸ºæ–‡ä»¶å†ä¸Šä¼ ï¼Œå­˜åœ¨ä»¥ä¸‹å¼Šç«¯ï¼š
- æ•°æ®æ—¶æ•ˆæ€§å·®ï¼šå¯¼å‡º â†’ ä¸Šä¼  â†’ è§£æé“¾è·¯é•¿ï¼Œæ— æ³•ä¿è¯å®æ—¶æ€§
- æ•°æ®å®Œæ•´æ€§å·®ï¼šæ–‡ä»¶å¯¼å‡ºä¸¢å¤±Schemaè¯­ä¹‰ã€å¤–é”®å…³ç³»ã€çº¦æŸä¿¡æ¯
- æ“ä½œæˆæœ¬é«˜ï¼šéœ€è¦ç”¨æˆ·æ‰‹åŠ¨è¿›è¡Œæ•°æ®å¯¼å‡ºå’Œæ ¼å¼è½¬æ¢

**é—®é¢˜äºŒï¼šDuckDBæ•°æ®åˆ†æèƒ½åŠ›å—é™**

å½“å‰ `PluginDataAnalysis` é€šè¿‡ DuckDB å†…å­˜æ¨¡å¼åŠ è½½ CSV/Excel åšåˆ†æï¼Œå­˜åœ¨å±€é™ï¼š
- æ•°æ®é‡å—æœåŠ¡å™¨å†…å­˜é™åˆ¶
- æ— æ³•è¿æ¥å¤–éƒ¨æ•°æ®åº“ç›´æ¥æŸ¥è¯¢
- ç¼ºä¹Schemaå…ƒä¿¡æ¯ç®¡ç†
- ä¸æ”¯æŒæ•°æ®æŒç»­åŒæ­¥æ›´æ–°

**é—®é¢˜ä¸‰ï¼šæ£€ç´¢/åˆ†æç•Œé¢æ¨¡ç³Š**

å½“å‰ç³»ç»Ÿæ²¡æœ‰æ˜ç¡®åŒºåˆ†"éç»“æ„åŒ–çŸ¥è¯†æ£€ç´¢"å’Œ"ç»“æ„åŒ–æ•°æ®åˆ†æ"ä¸¤ç§åœºæ™¯ï¼Œç¼ºå°‘ç»Ÿä¸€çš„æ··åˆæŸ¥è¯¢ç¼–æ’æœºåˆ¶ã€‚

---

## ä¸‰ã€æ‰©å±•ç›®æ ‡ä¸è®¾è®¡åŸåˆ™

### 3.1 æ‰©å±•ç›®æ ‡

1. **æ–°å¢çŸ¥è¯†åº“ç±»å‹**: å¼•å…¥ `KnowledgeBaseTypeDatabase = "database"` ç±»å‹ï¼Œæ”¯æŒå°†å¤–éƒ¨ç»“æ„åŒ–æ•°æ®åº“ä½œä¸ºçŸ¥è¯†æº
2. **å¤šæ•°æ®åº“é€‚é…**: æ”¯æŒ MySQLã€PostgreSQLã€Oracleã€SQL Serverã€ClickHouse åŠäº‘æ•°æ®åº“ RDS çš„è¿æ¥æ¥å…¥
3. **Schema è‡ªåŠ¨å‘ç°**: è¿æ¥æ•°æ®åº“åè‡ªåŠ¨æ¢æµ‹è¡¨ç»“æ„ã€å­—æ®µç±»å‹ã€çº¦æŸå…³ç³»ï¼Œç”Ÿæˆå…ƒæ•°æ®æè¿°
4. **æ··åˆæ£€ç´¢èƒ½åŠ›**: åœ¨ç°æœ‰å‘é‡æ£€ç´¢åŸºç¡€ä¸Šï¼Œå¢åŠ ç»“æ„åŒ–SQLæŸ¥è¯¢èƒ½åŠ›ï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€åˆ°SQLçš„è½¬æ¢ (NL2SQL)
5. **æ•°æ®åŒæ­¥æœºåˆ¶**: æä¾›å…¨é‡æŠ½å–ã€å¢é‡åŒæ­¥ã€CDCä¸‰ç§æ•°æ®åŒæ­¥ç­–ç•¥
6. **å®‰å…¨éš”ç¦»**: æ•°æ®åº“è¿æ¥å‡­æ®åŠ å¯†å­˜å‚¨ï¼ŒæŸ¥è¯¢æƒé™æ²™ç®±åŒ–ï¼Œé˜²æ­¢SQLæ³¨å…¥åŠè¶Šæƒè®¿é—®

### 3.2 è®¾è®¡åŸåˆ™

| åŸåˆ™ | è¯´æ˜ |
|------|------|
| **æœ€å°ä¾µå…¥** | æ‰©å±•ç°æœ‰æ¶æ„è€Œéé‡æ„ï¼Œæ–°å¢æ¨¡å—é€šè¿‡æ¥å£æ³¨å…¥ï¼Œä¸æ”¹å˜æ ¸å¿ƒæ•°æ®æµ |
| **æ¥å£ä¸€è‡´** | æ–°å¢ Database ç±»å‹çŸ¥è¯†åº“å¤ç”¨ç°æœ‰ Knowledge/Chunk æ•°æ®æ¨¡å‹ï¼Œé€šè¿‡ ChunkType æ‰©å±•åŒºåˆ† |
| **å¼•æ“æ’ä»¶åŒ–** | æ•°æ®åº“è¿æ¥å™¨å’ŒåŒæ­¥é©±åŠ¨å‡ä»¥æ’ä»¶å½¢å¼æ³¨å†Œï¼Œæ”¯æŒè¿è¡Œæ—¶åŠ¨æ€åŠ è½½ |
| **å®‰å…¨ä¼˜å…ˆ** | æ‰€æœ‰æ•°æ®åº“å‡­æ®åŠ å¯†å­˜å‚¨ï¼ŒæŸ¥è¯¢é€šè¿‡ç™½åå•å’Œæ²™ç®±æœºåˆ¶é™åˆ¶ |
| **æ¸è¿›å¢å¼º** | åˆ†é˜¶æ®µå®æ–½ï¼Œå…ˆæ”¯æ ¸å¿ƒçš„è¯»å–å’ŒSchemaå¯¼å…¥ï¼Œå†é€æ­¥å¢åŠ CDCå’Œé«˜çº§åˆ†æ |

---

## å››ã€æ€»ä½“ç›®æ ‡æ¶æ„è®¾è®¡

### 4.1 æ‰©å±•åæ€»ä½“æ¶æ„

```mermaid
graph TB
    subgraph "æ¥å…¥å±‚"
        A[HTTP API / WebSocket]
    end

    subgraph "ä¸šåŠ¡æœåŠ¡å±‚"
        B[KnowledgeBaseService]
        C[DatabaseConnectorService<br/>æ–°å¢]
        D[SchemaRegistryService<br/>æ–°å¢]
        E[DataSyncService<br/>æ–°å¢]
        F[NL2SQLService<br/>æ–°å¢]
    end

    subgraph "æ•°æ®è¿æ¥æŠ½è±¡å±‚ æ–°å¢"
        G[ConnectorRegistry]
        G1[MySQLConnector]
        G2[PostgreSQLConnector]
        G3[OracleConnector]
        G4[SQLServerConnector]
        G5[ClickHouseConnector]
        G6[RDSConnector]
    end

    subgraph "æ··åˆæ£€ç´¢å±‚"
        H[CompositeRetrieveEngine<br/>æ‰©å±•]
        I[SQLæŸ¥è¯¢å¼•æ“<br/>æ–°å¢]
        J[å‘é‡æ£€ç´¢å¼•æ“<br/>ç°æœ‰]
        K[å…³é”®è¯æ£€ç´¢å¼•æ“<br/>ç°æœ‰]
    end

    subgraph "æ•°æ®åŒæ­¥å±‚ æ–°å¢"
        L[FullSyncWorker]
        M[IncrementalSyncWorker]
        N[CDCWorker - Debezium]
    end

    subgraph "AI æŸ¥è¯¢ç¼–æ’å±‚"
        O[ChatPipeline - æ‰©å±•]
        P[PluginStructuredSearch<br/>æ–°å¢]
        Q[PluginNL2SQL<br/>æ–°å¢]
        R[PluginDataAnalysis<br/>å¢å¼º]
    end

    subgraph "å¤–éƒ¨ç»“æ„åŒ–æ•°æ®æº"
        S1[(MySQL)]
        S2[(PostgreSQL)]
        S3[(Oracle)]
        S4[(SQL Server)]
        S5[(ClickHouse)]
        S6[(Cloud RDS)]
    end

    A --> B & C & D
    B --> C
    C --> G
    G --> G1 & G2 & G3 & G4 & G5 & G6
    G1 --> S1
    G2 --> S2
    G3 --> S3
    G4 --> S4
    G5 --> S5
    G6 --> S6
    D --> G
    E --> G
    E --> L & M & N
    O --> P & Q & R
    P --> H
    Q --> F
    F --> I
    H --> I & J & K
```

### 4.2 æ ¸å¿ƒæ‰©å±•ç‚¹

| æ¨¡å— | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `types/knowledgebase.go` | æ‰©å±• | æ–°å¢ `KnowledgeBaseTypeDatabase` ç±»å‹å¸¸é‡ |
| `types/database_connector.go` | æ–°å¢ | å®šä¹‰æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€Schemaå…ƒæ•°æ®ç­‰ç±»å‹ |
| `interfaces/database_connector.go` | æ–°å¢ | å®šä¹‰è¿æ¥å™¨ã€Schemaæ³¨å†Œã€åŒæ­¥ç­‰æ¥å£ |
| `application/repository/connector/` | æ–°å¢ | å„æ•°æ®åº“è¿æ¥å™¨å®ç° |
| `application/service/database_connector.go` | æ–°å¢ | æ•°æ®åº“è¿æ¥å™¨ç®¡ç†æœåŠ¡ |
| `application/service/schema_registry.go` | æ–°å¢ | Schemaè‡ªåŠ¨å‘ç°å’Œæ³¨å†ŒæœåŠ¡ |
| `application/service/data_sync.go` | æ–°å¢ | æ•°æ®åŒæ­¥æœåŠ¡ |
| `application/service/nl2sql.go` | æ–°å¢ | è‡ªç„¶è¯­è¨€è½¬SQLæœåŠ¡ |
| `chat_pipline/structured_search.go` | æ–°å¢ | ç»“æ„åŒ–æœç´¢Pipelineæ’ä»¶ |
| `handler/database_connector.go` | æ–°å¢ | æ•°æ®åº“è¿æ¥ç®¡ç†HTTPæ¥å£ |
| `container/container.go` | æ‰©å±• | æ³¨å†Œæ–°å¢æœåŠ¡å’Œè¿æ¥å™¨ |

---

## äº”ã€æ•°æ®åº“è¿æ¥å±‚è®¾è®¡

### 5.1 è¿æ¥å™¨æŠ½è±¡æ¥å£

```go
// DatabaseConnector æ•°æ®åº“è¿æ¥å™¨æ¥å£
type DatabaseConnector interface {
    // Type è¿”å›æ•°æ®åº“ç±»å‹æ ‡è¯†
    Type() DatabaseType
    
    // Connect å»ºç«‹æ•°æ®åº“è¿æ¥
    Connect(ctx context.Context, config *DatabaseConnectionConfig) error
    
    // Ping æµ‹è¯•è¿æ¥å¯ç”¨æ€§
    Ping(ctx context.Context) error
    
    // Close å…³é—­è¿æ¥
    Close() error
    
    // DiscoverSchemas å‘ç°æ•°æ®åº“ä¸­çš„æ‰€æœ‰Schema/Database
    DiscoverSchemas(ctx context.Context) ([]*SchemaInfo, error)
    
    // DiscoverTables å‘ç°æŒ‡å®šSchemaä¸‹çš„æ‰€æœ‰è¡¨
    DiscoverTables(ctx context.Context, schema string) ([]*TableInfo, error)
    
    // DescribeTable è·å–è¡¨çš„è¯¦ç»†ç»“æ„ä¿¡æ¯ï¼ˆåˆ—ã€ç´¢å¼•ã€çº¦æŸï¼‰
    DescribeTable(ctx context.Context, schema, table string) (*TableDetail, error)
    
    // SampleData è·å–è¡¨çš„é‡‡æ ·æ•°æ®
    SampleData(ctx context.Context, schema, table string, limit int) ([]map[string]interface{}, error)
    
    // ExecuteQuery æ‰§è¡Œåªè¯»SQLæŸ¥è¯¢ï¼ˆå¸¦è¶…æ—¶å’Œè¡Œæ•°é™åˆ¶ï¼‰
    ExecuteQuery(ctx context.Context, sql string, args []interface{}, opts *QueryOptions) (*QueryResult, error)
    
    // EstimateRowCount ä¼°ç®—è¡¨è¡Œæ•°
    EstimateRowCount(ctx context.Context, schema, table string) (int64, error)
}
```

### 5.2 è¿æ¥é…ç½®æ•°æ®æ¨¡å‹

```go
// DatabaseType æ•°æ®åº“ç±»å‹
type DatabaseType string

const (
    DatabaseTypeMySQL      DatabaseType = "mysql"
    DatabaseTypePostgreSQL DatabaseType = "postgresql"
    DatabaseTypeOracle     DatabaseType = "oracle"
    DatabaseTypeSQLServer  DatabaseType = "sqlserver"
    DatabaseTypeClickHouse DatabaseType = "clickhouse"
    DatabaseTypeRDS        DatabaseType = "rds"
)

// DatabaseConnectionConfig æ•°æ®åº“è¿æ¥é…ç½®
type DatabaseConnectionConfig struct {
    ID               string       `json:"id" gorm:"type:varchar(36);primaryKey"`
    KnowledgeBaseID  string       `json:"knowledge_base_id" gorm:"type:varchar(36);index"`
    TenantID         uint64       `json:"tenant_id"`
    Type             DatabaseType `json:"type" gorm:"type:varchar(32)"`
    Host             string       `json:"host"`
    Port             int          `json:"port"`
    Database         string       `json:"database"`
    Username         string       `json:"username"`
    EncryptedPassword string      `json:"-" gorm:"column:encrypted_password"`   // AES-256-GCM åŠ å¯†å­˜å‚¨
    SSLMode          string       `json:"ssl_mode" gorm:"type:varchar(32)"`
    ExtraParams      JSON         `json:"extra_params" gorm:"type:json"`        // æ•°æ®åº“ç‰¹å®šå‚æ•°
    MaxConnections   int          `json:"max_connections" gorm:"default:5"`
    ConnectTimeout   int          `json:"connect_timeout" gorm:"default:30"`    // ç§’
    QueryTimeout     int          `json:"query_timeout" gorm:"default:60"`      // ç§’
    MaxRowsPerQuery  int          `json:"max_rows_per_query" gorm:"default:10000"`
    CreatedAt        time.Time    `json:"created_at"`
    UpdatedAt        time.Time    `json:"updated_at"`
    DeletedAt        gorm.DeletedAt `json:"deleted_at" gorm:"index"`
}
```

### 5.3 è¿æ¥å™¨æ³¨å†Œä¸­å¿ƒ

```go
// ConnectorRegistry è¿æ¥å™¨æ³¨å†Œä¸­å¿ƒ
type ConnectorRegistry struct {
    factories map[DatabaseType]ConnectorFactory
    pools     map[string]*ConnectorPool   // key: connectionConfigID
    mu        sync.RWMutex
}

type ConnectorFactory func(config *DatabaseConnectionConfig) (DatabaseConnector, error)

// Register æ³¨å†Œè¿æ¥å™¨å·¥å‚
func (r *ConnectorRegistry) Register(dbType DatabaseType, factory ConnectorFactory)

// GetConnector è·å–æˆ–åˆ›å»ºè¿æ¥å™¨å®ä¾‹ï¼ˆå¸¦è¿æ¥æ± ç®¡ç†ï¼‰
func (r *ConnectorRegistry) GetConnector(ctx context.Context, configID string) (DatabaseConnector, error)
```

### 5.4 å„æ•°æ®åº“é€‚é…å®ç°è¦ç‚¹

| æ•°æ®åº“ | Go Driver | Schemaå‘ç°æ–¹å¼ | ç‰¹æ®Šè€ƒé‡ |
|--------|-----------|----------------|----------|
| **MySQL** | `go-sql-driver/mysql` | `INFORMATION_SCHEMA.TABLES/COLUMNS` | å­—ç¬¦é›†ç¼–ç ã€å¤§å°å†™æ•æ„Ÿæ€§ |
| **PostgreSQL** | `lib/pq` / `pgx` | `pg_catalog` / `information_schema` | Schemaéš”ç¦»ã€è‡ªå®šä¹‰ç±»å‹ |
| **Oracle** | `godror` | `ALL_TABLES` / `ALL_TAB_COLUMNS` | TNSè¿æ¥ä¸²ã€æƒé™ä½“ç³»å¤æ‚ |
| **SQL Server** | `go-mssqldb` | `sys.tables` / `sys.columns` | Windowsè®¤è¯ã€Schemaå‘½åç©ºé—´ |
| **ClickHouse** | `clickhouse-go` | `system.tables` / `system.columns` | åˆ—å¼å­˜å‚¨ç‰¹æ€§ã€MergeTreeå¼•æ“ |
| **äº‘RDS** | å¤ç”¨å¯¹åº”Driver | åŒä¸Š | SSLè¯ä¹¦ã€VPCç½‘ç»œæ‰“é€šã€IAMè®¤è¯ |

### 5.5 è¿æ¥æ± ä¸å¥åº·æ£€æŸ¥

```mermaid
sequenceDiagram
    participant User
    participant ConnectorService
    participant ConnectorPool
    participant TargetDB

    User->>ConnectorService: åˆ›å»º/æµ‹è¯•è¿æ¥
    ConnectorService->>ConnectorPool: GetOrCreate(configID)
    ConnectorPool->>TargetDB: TCPè¿æ¥ + è®¤è¯
    TargetDB-->>ConnectorPool: è¿æ¥æˆåŠŸ
    ConnectorPool-->>ConnectorService: connector instance
    
    loop å¥åº·æ£€æŸ¥ (æ¯30s)
        ConnectorPool->>TargetDB: Ping()
        alt è¿æ¥æ­£å¸¸
            TargetDB-->>ConnectorPool: OK
        else è¿æ¥å¤±æ•ˆ
            ConnectorPool->>ConnectorPool: é‡å»ºè¿æ¥
        end
    end
    
    User->>ConnectorService: æ‰§è¡ŒæŸ¥è¯¢
    ConnectorService->>ConnectorPool: Borrow(configID)
    ConnectorPool->>TargetDB: ExecuteQuery(SQL)
    TargetDB-->>ConnectorPool: ResultSet
    ConnectorPool-->>ConnectorService: QueryResult
    ConnectorService-->>User: è¿”å›ç»“æœ
```

---

## å…­ã€æ•°æ®åŒæ­¥ä¸æŠ½å–ç­–ç•¥ï¼ˆå…¨é‡ / å¢é‡ / CDCï¼‰

### 6.0 æ ¸å¿ƒè®¾è®¡ç†å¿µï¼šå…ƒæ•°æ®é¢„ç´¢å¼• + å®æ—¶è¿œç¨‹æŸ¥è¯¢

> **é‡è¦æ¶æ„å†³ç­–**: æœ¬æ–¹æ¡ˆ**ä¸å°†å¤–éƒ¨æ•°æ®åº“çš„ä¸šåŠ¡è¡Œæ•°æ®åŒæ­¥åˆ°æœ¬åœ°**ï¼Œè€Œæ˜¯é‡‡ç”¨ã€Œå…ƒæ•°æ®é¢„ç´¢å¼• + å®æ—¶è¿œç¨‹æŸ¥è¯¢ã€æ¨¡å¼ã€‚

| åŒæ­¥å¯¹è±¡ | åŒæ­¥æ–¹å¼ | ç›®çš„ |
|----------|----------|------|
| **Schema å…ƒæ•°æ®**ï¼ˆè¡¨ç»“æ„ã€åˆ—ä¿¡æ¯ã€DDLã€å¤–é”®ç­‰ï¼‰ | å…¨é‡/å¢é‡/CDC | å»ºç«‹å‘é‡ç´¢å¼•ï¼Œè®©æ£€ç´¢èƒ½æ‰¾åˆ°ã€Œç”¨æˆ·é—®é¢˜ç›¸å…³çš„è¡¨ã€ |
| **LLM ç”Ÿæˆæè¿°**ï¼ˆè¡¨æ‘˜è¦ã€åˆ—æè¿°ï¼‰ | åŸºäºå…ƒæ•°æ®å˜æ›´è§¦å‘ | ä¾›å‘é‡è¯­ä¹‰æ£€ç´¢ä½¿ç”¨ |
| **ä¸šåŠ¡è¡Œæ•°æ®** | âŒ **ä¸åŒæ­¥** | é€šè¿‡ NL2SQL å®æ—¶è¿œç¨‹æŸ¥è¯¢å¤–éƒ¨æ•°æ®åº“è·å– |

**ä¸åŒæ­¥ä¸šåŠ¡æ•°æ®çš„ç†ç”±ï¼š**
- ä¼ä¸šæ•°æ®åº“å¯èƒ½æœ‰æ•°åäº¿è¡Œï¼Œæœ¬åœ°å­˜å‚¨æ”¾ä¸ä¸‹
- åŒæ­¥æœ‰å»¶è¿Ÿï¼Œç”¨æˆ·æœŸæœ›æŸ¥åˆ°çš„æ˜¯æœ€æ–°æ•°æ®
- ä¸šåŠ¡æ•°æ®æ¬è¿æ¶‰åŠåˆè§„å®¡æ‰¹ï¼Œç›´æŸ¥æƒé™æ›´å¯æ§
- ç°æœ‰æ£€ç´¢å¼•æ“ä¸ºæ–‡æœ¬å‘é‡ç´¢å¼•ï¼Œä¸é€‚åˆå­˜å‚¨åŸå§‹ä¸šåŠ¡è¡Œæ•°æ®

**ä¸ç°æœ‰ CSV/Excel å¤„ç†æµç¨‹çš„å¯¹æ¯”ï¼š**

| ç»´åº¦ | CSV/Excelï¼ˆç°æœ‰ï¼‰ | å¤–éƒ¨æ•°æ®åº“ï¼ˆæ–°å¢ï¼‰ |
|------|-------------------|--------------------|
| æ•°æ®ä½ç½® | æ–‡ä»¶å·²ä¸Šä¼ åˆ°æœ¬åœ° | æ•°æ®åœ¨å¤–éƒ¨æ•°æ®åº“ |
| å…ƒæ•°æ®ç´¢å¼• | DuckDB åŠ è½½ â†’ LLM ç”Ÿæˆæè¿° â†’ å‘é‡åŒ– | è¿æ¥å™¨å‘ç° Schema â†’ LLM ç”Ÿæˆæè¿° â†’ å‘é‡åŒ– |
| æŸ¥è¯¢æ‰§è¡Œ | DuckDB å†…å­˜ä¸´æ—¶åŠ è½½æ–‡ä»¶ â†’ SQL | ç›´æ¥è¿œç¨‹æŸ¥è¯¢å¤–éƒ¨æ•°æ®åº“ â†’ SQL |
| æŸ¥è¯¢åå¤„ç† | DuckDB Cleanup åˆ é™¤ä¸´æ—¶è¡¨ | å…³é—­è¿æ¥å½’è¿˜è¿æ¥æ±  |

### 6.1 å…ƒæ•°æ®åŒæ­¥ç­–ç•¥æ€»è§ˆ

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | å…ƒæ•°æ®æ—¶æ•ˆæ€§ | ç³»ç»Ÿå¼€é”€ | å®ç°å¤æ‚åº¦ |
|------|----------|------------|----------|------------|
| **å…¨é‡å‘ç°** | åˆæ¬¡æ¥å…¥ã€è¡¨æ•°é‡å°‘ | æ¯æ¬¡åŒæ­¥æ—¶é—´ç‚¹ | ä½ï¼ˆä»…æ‰«æINFORMATION_SCHEMAï¼‰ | ä½ |
| **å¢é‡æ£€æµ‹** | å®šæœŸåˆ·æ–°Schemaå˜æ›´ | åˆ†é’Ÿçº§~å°æ—¶çº§ | æä½ï¼ˆå¯¹æ¯”å…ƒæ•°æ®å·®å¼‚ï¼‰ | ä¸­ |
| **CDC (Change Data Capture)** | DDLå˜æ›´å®æ—¶æ„ŸçŸ¥ | ç§’çº§~äºšç§’çº§ | ä½ï¼ˆåŸºäºbinlog DDLäº‹ä»¶ï¼‰ | é«˜ |

### 6.2 å…¨é‡ Schema å‘ç°

```mermaid
flowchart LR
    A[å®šæ—¶è§¦å‘ / æ‰‹åŠ¨è§¦å‘] --> B[è¿æ¥å¤–éƒ¨æ•°æ®åº“]
    B --> C[éå†INFORMATION_SCHEMA<br/>è·å–è¡¨/åˆ—/ç´¢å¼•/å¤–é”®]
    C --> D[é‡‡æ ·æ¯è¡¨ TOP N è¡Œ<br/>ç”¨äºç†è§£æ•°æ®å«ä¹‰]
    D --> E[LLM ç”Ÿæˆè¡¨æ‘˜è¦<br/>+ åˆ—æè¿°]
    E --> F[Embedding å‘é‡åŒ–]
    F --> G[å†™å…¥æ£€ç´¢å¼•æ“ç´¢å¼•<br/>ChunkTypeTableSummary<br/>ChunkTypeTableColumn<br/>ChunkTypeSchemaMetadata]
    G --> H[æ›´æ–° SchemaRegistry]
```

- **ä¸æŠ½å–ä¸šåŠ¡æ•°æ®**: ä»…æ‰«æ `INFORMATION_SCHEMA`ï¼ˆMySQLï¼‰ã€`pg_catalog`ï¼ˆPGï¼‰ç­‰ç³»ç»Ÿè¡¨è·å–å…ƒæ•°æ®
- **é‡‡æ ·æœ‰é™**: æ¯è¡¨é‡‡æ · TOP 10-100 è¡Œï¼Œä»…ç”¨äº LLM ç†è§£åˆ—å«ä¹‰ï¼Œç”¨å®Œå³ä¸¢
- **å¹¶å‘æ§åˆ¶**: å¤šè¡¨é—´å¯é…ç½®å¹¶å‘åº¦ï¼ˆé»˜è®¤ 3 å¼ è¡¨å¹¶è¡Œå‘ç°ï¼‰
- **å¹‚ç­‰æ€§**: å…ƒæ•°æ®å†™å…¥é‡‡ç”¨ `ON CONFLICT (knowledge_base_id, table_name) DO UPDATE`

### 6.3 å¢é‡ Schema å˜æ›´æ£€æµ‹

```go
// SchemaRefreshConfig Schema åˆ·æ–°é…ç½®
type SchemaRefreshConfig struct {
    RefreshInterval string `json:"refresh_interval"` // cron è¡¨è¾¾å¼ï¼Œå¦‚ "0 */6 * * *" æ¯6å°æ—¶
    AutoRefresh     bool   `json:"auto_refresh"`     // æ˜¯å¦å¯ç”¨è‡ªåŠ¨åˆ·æ–°
}
```

- **å¯¹æ¯”æ–¹å¼**: æ¯æ¬¡åˆ·æ–°æ—¶é‡æ–°æŸ¥è¯¢ `INFORMATION_SCHEMA`ï¼Œä¸ `SchemaRegistry` ä¸­å­˜å‚¨çš„å¿«ç…§å¯¹æ¯”
- **æ£€æµ‹å†…å®¹**: æ–°å¢è¡¨ã€åˆ é™¤è¡¨ã€åˆ—ç±»å‹å˜æ›´ã€æ–°å¢/åˆ é™¤åˆ—ã€æ³¨é‡Šå˜æ›´
- **å¢é‡å¤„ç†**:
  - æ–°å¢è¡¨ â†’ é‡‡æ · + LLMæè¿° + å‘é‡åŒ–
  - åˆ é™¤è¡¨ â†’ ç§»é™¤å…³è” Chunk å’Œç´¢å¼•
  - åˆ—å˜æ›´ â†’ é‡æ–°ç”Ÿæˆåˆ—æè¿° + æ›´æ–°ç´¢å¼•
- **è°ƒåº¦æ–¹å¼**: é€šè¿‡ Asynq å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼ˆå¤ç”¨ç°æœ‰å¼‚æ­¥ä»»åŠ¡åŸºç¡€è®¾æ–½ï¼‰
- **æ€§èƒ½å½±å“**: æä½ï¼Œä»…æŸ¥è¯¢ç³»ç»Ÿå…ƒæ•°æ®è¡¨ï¼ˆé€šå¸¸æ¯«ç§’çº§å®Œæˆï¼‰

### 6.4 CDC (Change Data Capture) â€” ä»…ç›‘å¬ DDL å˜æ›´

```mermaid
flowchart LR
    A[(Source DB)] -->|binlog / WAL| B[Debezium Connect]
    B -->|DDL Events| C[Kafka Topic]
    C --> D[CDC Consumer<br/>Go Service]
    D --> E{DDLäº‹ä»¶ç±»å‹}
    E -->|CREATE TABLE| F[æ–°å¢ Schema æ³¨å†Œ<br/>+ LLM æè¿° + ç´¢å¼•]
    E -->|ALTER TABLE| G[æ›´æ–°åˆ—æè¿°<br/>+ é‡å»ºç´¢å¼•]
    E -->|DROP TABLE| H[åˆ é™¤ Schema æ³¨å†Œ<br/>+ ç§»é™¤ç´¢å¼•]
```

- **ä»…ç›‘å¬ DDL äº‹ä»¶**ï¼ˆCREATE/ALTER/DROP TABLEï¼‰ï¼Œ**ä¸ç›‘å¬ DML äº‹ä»¶**ï¼ˆINSERT/UPDATE/DELETEï¼‰
- ä¸šåŠ¡æ•°æ®å˜æ›´ä¸éœ€è¦æœ¬åœ°æ„ŸçŸ¥ï¼Œå› ä¸ºæŸ¥è¯¢æ—¶ä¼šå®æ—¶è¿œç¨‹æŸ¥è¯¢å¤–éƒ¨æ•°æ®åº“
- **Debezium** ä½œä¸º CDC å¼•æ“ï¼Œé…ç½®è¿‡æ»¤ DDL-only äº‹ä»¶
- **æ¶ˆæ¯é˜Ÿåˆ—**: Kafka ä½œä¸ºå˜æ›´äº‹ä»¶ç®¡é“ï¼ˆå¯é€‰ Redis Streams è½»é‡çº§æ›¿ä»£ï¼‰
- **äº‹ä»¶å¤„ç†**: Go Consumer æ¶ˆè´¹ DDL å˜æ›´äº‹ä»¶ï¼Œè§¦å‘ `SchemaRegistryService.RefreshSchema()` æ›´æ–°å…ƒæ•°æ®ç´¢å¼•

### 6.5 Schema åŒæ­¥ä»»åŠ¡ç®¡ç†

```go
// SchemaSyncTask SchemaåŒæ­¥ä»»åŠ¡
type SchemaSyncTask struct {
    ID                 string        `json:"id" gorm:"type:varchar(36);primaryKey"`
    KnowledgeBaseID    string        `json:"knowledge_base_id"`
    ConnectionConfigID string        `json:"connection_config_id"`
    SyncType           string        `json:"sync_type"`    // "full_discovery", "incremental_detect", "cdc_ddl"
    Status             string        `json:"status"`       // "pending", "running", "completed", "failed"
    TablesDiscovered   int           `json:"tables_discovered"`   // å‘ç°çš„è¡¨æ•°
    TablesUpdated      int           `json:"tables_updated"`      // æ›´æ–°çš„è¡¨æ•°
    TablesRemoved      int           `json:"tables_removed"`      // ç§»é™¤çš„è¡¨æ•°
    ChunksCreated      int           `json:"chunks_created"`      // åˆ›å»ºçš„æè¿°Chunkæ•°
    ErrorMessage       string        `json:"error_message"`
    StartedAt          *time.Time    `json:"started_at"`
    CompletedAt        *time.Time    `json:"completed_at"`
    CreatedAt          time.Time     `json:"created_at"`
    UpdatedAt          time.Time     `json:"updated_at"`
}
```

---

## ä¸ƒã€ç»“æ„åŒ–ç´¢å¼•ä¸å‘é‡ç´¢å¼•èåˆç­–ç•¥

### 7.1 èåˆæ¶æ„

```mermaid
graph TB
    subgraph "ç´¢å¼•å±‚"
        A[ç»“æ„åŒ–å…ƒæ•°æ®ç´¢å¼•<br/>Schema/è¡¨æè¿°/åˆ—æè¿°]
        B[å‘é‡ç´¢å¼•<br/>è¡¨æ‘˜è¦+åˆ—æè¿°çš„Embedding]
        C[SQLæŸ¥è¯¢ç´¢å¼•<br/>NL2SQL ç”Ÿæˆçš„SQLç¼“å­˜]
    end

    subgraph "æ£€ç´¢æ–¹å¼"
        D[å‘é‡è¯­ä¹‰æ£€ç´¢] --> B
        E[å…³é”®è¯æ£€ç´¢] --> A
        F[SQLç›´æ¥æŸ¥è¯¢] --> C
    end

    subgraph "èåˆç­–ç•¥"
        G[RRF äº’å€’æ’åºèåˆ]
        H[LLM æ„å›¾è¯†åˆ«è·¯ç”±]
    end

    D & E --> G
    H -->|åˆ†æç±»| F
    H -->|çŸ¥è¯†æ£€ç´¢ç±»| G
```

### 7.2 ç»“æ„åŒ–æ•°æ®çš„ç´¢å¼•æ–¹æ¡ˆ

ä¸æ–‡æ¡£çŸ¥è¯†åº“å¯¹æ–‡æœ¬è¿›è¡Œåˆ‡ç‰‡ä¸åŒï¼Œç»“æ„åŒ–æ•°æ®åº“çŸ¥è¯†åº“é‡‡ç”¨ä»¥ä¸‹ç´¢å¼•ç­–ç•¥ï¼š

| Chunkç±»å‹ | å¸¸é‡ | å†…å®¹ | ç”¨é€” |
|-----------|------|------|------|
| è¡¨æ‘˜è¦ | `ChunkTypeTableSummary` (å·²å­˜åœ¨) | LLMç”Ÿæˆçš„è¡¨æ ¼åŠŸèƒ½æè¿° | è¯­ä¹‰æ£€ç´¢ï¼šæ‰¾åˆ°ç›¸å…³è¡¨ |
| åˆ—æè¿° | `ChunkTypeTableColumn` (å·²å­˜åœ¨) | LLMç”Ÿæˆçš„åˆ—å…ƒæ•°æ®æè¿° | è¯­ä¹‰æ£€ç´¢ï¼šæ‰¾åˆ°ç›¸å…³åˆ— |
| Schemaå…ƒæ•°æ® | `ChunkTypeSchemaMetadata` (æ–°å¢) | DDL + çº¦æŸ + ç´¢å¼•ä¿¡æ¯ | NL2SQLï¼šç”Ÿæˆå‡†ç¡®SQL |
| é‡‡æ ·æè¿° | `ChunkTypeSampleSummary` (æ–°å¢) | åŸºäºé‡‡æ ·æ•°æ®çš„å€¼åˆ†å¸ƒæè¿° | è¾…åŠ©ç†è§£å­—æ®µå«ä¹‰ |

### 7.3 å‘é‡åŒ–ç­–ç•¥

```
è¡¨çº§å‘é‡ = Embedding("è¡¨å: orders | æè¿°: è®¢å•äº¤æ˜“è®°å½•è¡¨ï¼Œè®°å½•æ‰€æœ‰ç”¨æˆ·çš„è´­ä¹°è¡Œä¸º...")  
åˆ—çº§å‘é‡ = Embedding("è¡¨: orders | åˆ—: total_amount | å«ä¹‰: è®¢å•æ€»é‡‘é¢(å…ƒ) | ç±»å‹: decimal(10,2)")
```

- å¤ç”¨ç°æœ‰ `BatchEmbedder` å’Œ `EmbeddingModel` è¿›è¡Œå‘é‡åŒ–
- ç´¢å¼•å†™å…¥å¤ç”¨ç°æœ‰ `RetrieveEngineService.BatchIndex()` æ¥å£
- æ£€ç´¢æ—¶é€šè¿‡ `KnowledgeType` å­—æ®µåŒºåˆ†æ™®é€šæ–‡æ¡£æ£€ç´¢å’Œç»“æ„åŒ–å…ƒæ•°æ®æ£€ç´¢

### 7.4 æ··åˆæ£€ç´¢æµç¨‹

```mermaid
sequenceDiagram
    participant User
    participant Pipeline
    participant IntentRouter
    participant VectorSearch
    participant NL2SQL
    participant SQLEngine
    participant Merger

    User->>Pipeline: ç”¨æˆ·æé—®
    Pipeline->>IntentRouter: æ„å›¾è¯†åˆ«
    
    alt åˆ†æå‹é—®é¢˜ï¼ˆå¦‚"ä¸Šå­£åº¦é”€å”®é¢æ˜¯å¤šå°‘"ï¼‰
        IntentRouter->>NL2SQL: è½¬æ¢ä¸ºSQL
        NL2SQL->>VectorSearch: æ£€ç´¢ç›¸å…³è¡¨Schema
        VectorSearch-->>NL2SQL: ç›¸å…³Schemaä¸Šä¸‹æ–‡
        NL2SQL->>SQLEngine: ç”Ÿæˆ+æ‰§è¡ŒSQL
        SQLEngine-->>Merger: SQLç»“æœ
    else çŸ¥è¯†æ£€ç´¢å‹é—®é¢˜
        IntentRouter->>VectorSearch: è¯­ä¹‰æ£€ç´¢
        VectorSearch-->>Merger: æ£€ç´¢ç»“æœ
    else æ··åˆå‹é—®é¢˜
        par å¹¶è¡Œæ‰§è¡Œ
            IntentRouter->>VectorSearch: è¯­ä¹‰æ£€ç´¢
            IntentRouter->>NL2SQL: SQLæŸ¥è¯¢
        end
        VectorSearch-->>Merger: å‘é‡ç»“æœ
        NL2SQL-->>Merger: SQLç»“æœ
    end
    
    Merger->>Pipeline: åˆå¹¶ç»“æœ
    Pipeline->>User: LLMç”Ÿæˆå›ç­”
```

---

## å…«ã€å…ƒæ•°æ®æ³¨å†Œä¸ Schema ç®¡ç†æœºåˆ¶

### 8.1 Schema è‡ªåŠ¨å‘ç°æµç¨‹

```mermaid
flowchart TB
    A[ç”¨æˆ·é€‰æ‹©æ•°æ®åº“è¿æ¥] --> B[è¿æ¥ç›®æ ‡æ•°æ®åº“]
    B --> C[éå†Schema/Database]
    C --> D[éå†Table]
    D --> E[è·å–Columnè¯¦æƒ…<br/>ç±»å‹/çº¦æŸ/æ³¨é‡Š]
    E --> F[è·å–ç´¢å¼•/å¤–é”®]
    F --> G[é‡‡æ ·æ•°æ® TOP N]
    G --> H[LLMç”Ÿæˆè¡¨æ‘˜è¦]
    H --> I[LLMç”Ÿæˆåˆ—æè¿°]
    I --> J[å†™å…¥SchemaRegistry]
    J --> K[å‘é‡åŒ–ç´¢å¼•]
```

### 8.2 Schema æ³¨å†Œæ•°æ®æ¨¡å‹

```go
// SchemaRegistry å…ƒæ•°æ®æ³¨å†Œè¡¨
type SchemaRegistry struct {
    ID                string    `json:"id" gorm:"type:varchar(36);primaryKey"`
    KnowledgeBaseID   string    `json:"knowledge_base_id" gorm:"index"`
    ConnectionConfigID string   `json:"connection_config_id"`
    SchemaName        string    `json:"schema_name"`
    TableName         string    `json:"table_name"`
    TableComment      string    `json:"table_comment"`          // åŸå§‹æ³¨é‡Š
    TableSummary      string    `json:"table_summary"`          // LLM ç”Ÿæˆçš„æ‘˜è¦
    DDL               string    `json:"ddl"`                    // CREATE TABLE è¯­å¥
    EstimatedRows     int64     `json:"estimated_rows"`
    Columns           JSON      `json:"columns" gorm:"type:json"` // []ColumnMeta
    Indexes           JSON      `json:"indexes" gorm:"type:json"` // []IndexMeta
    ForeignKeys       JSON      `json:"foreign_keys" gorm:"type:json"` // []ForeignKeyMeta
    SyncStatus        string    `json:"sync_status"`            // "pending", "synced", "error"
    LastSyncAt        *time.Time `json:"last_sync_at"`
    CreatedAt         time.Time `json:"created_at"`
    UpdatedAt         time.Time `json:"updated_at"`
}

// ColumnMeta åˆ—å…ƒæ•°æ®
type ColumnMeta struct {
    Name         string `json:"name"`
    DataType     string `json:"data_type"`
    Nullable     bool   `json:"nullable"`
    IsPrimaryKey bool   `json:"is_primary_key"`
    DefaultValue string `json:"default_value,omitempty"`
    Comment      string `json:"comment,omitempty"`
    Description  string `json:"description,omitempty"`  // LLM ç”Ÿæˆæè¿°
}
```

### 8.3 Schema å˜æ›´æ£€æµ‹

- **å®šæœŸå¯¹æ¯”**: æ¯æ¬¡åŒæ­¥æ—¶é‡æ–°è·å– `INFORMATION_SCHEMA`ï¼Œä¸ `SchemaRegistry` å¯¹æ¯”
- **å˜æ›´ç±»å‹**: æ–°å¢è¡¨/åˆ—ã€åˆ é™¤è¡¨/åˆ—ã€ç±»å‹å˜æ›´ã€æ³¨é‡Šå˜æ›´
- **å½±å“å¤„ç†**:
  - æ–°å¢è¡¨ï¼šè§¦å‘LLMæè¿°ç”Ÿæˆ + å‘é‡åŒ–
  - åˆ é™¤è¡¨ï¼šç§»é™¤ç›¸å…³Chunkå’Œç´¢å¼•
  - åˆ—å˜æ›´ï¼šé‡æ–°ç”Ÿæˆåˆ—æè¿° + æ›´æ–°ç´¢å¼•
  - Schemaé‡å¤§å˜æ›´ï¼šé€šçŸ¥ç®¡ç†è€…ç¡®è®¤

---

## ä¹ã€æŸ¥è¯¢ä¸åˆ†ææµç¨‹è®¾è®¡

### 9.1 NL2SQL æœåŠ¡è®¾è®¡

```go
// NL2SQLService è‡ªç„¶è¯­è¨€è½¬SQLæœåŠ¡
type NL2SQLService interface {
    // GenerateSQL æ ¹æ®ç”¨æˆ·é—®é¢˜å’ŒSchemaä¸Šä¸‹æ–‡ç”ŸæˆSQL
    GenerateSQL(ctx context.Context, params *NL2SQLParams) (*NL2SQLResult, error)
    
    // ValidateSQL éªŒè¯SQLå®‰å…¨æ€§ï¼ˆé˜²æ³¨å…¥ã€é™åˆ¶å†™æ“ä½œï¼‰
    ValidateSQL(ctx context.Context, sql string) error
    
    // ExecuteAndFormat æ‰§è¡ŒSQLå¹¶æ ¼å¼åŒ–ç»“æœ
    ExecuteAndFormat(ctx context.Context, connectorID string, sql string) (*FormattedResult, error)
}

// NL2SQLParams NL2SQLå‚æ•°
type NL2SQLParams struct {
    Query          string          // ç”¨æˆ·è‡ªç„¶è¯­è¨€é—®é¢˜
    SchemaContexts []*SchemaRegistry // ç›¸å…³è¡¨çš„Schemaä¿¡æ¯
    Dialect        DatabaseType    // æ•°æ®åº“æ–¹è¨€
    MaxRows        int             // æœ€å¤§è¿”å›è¡Œæ•°
    History        []ChatMessage   // å¯¹è¯å†å²ï¼ˆç”¨äºå¤šè½®SQLç”Ÿæˆï¼‰
}

// NL2SQLResult NL2SQLç»“æœ
type NL2SQLResult struct {
    SQL           string                   // ç”Ÿæˆçš„SQL
    Explanation   string                   // SQLè§£é‡Š
    Confidence    float64                  // ç½®ä¿¡åº¦
    QueryResult   *QueryResult             // æŸ¥è¯¢ç»“æœ
    Visualization *VisualizationSuggestion // å¯è§†åŒ–å»ºè®®
}
```

### 9.2 SQL å®‰å…¨éªŒè¯

```go
// SQLValidator SQLå®‰å…¨éªŒè¯å™¨
type SQLValidator struct {
    // ç™½åå•ç­–ç•¥
    allowedStatements []string  // ä»…å…è®¸ SELECT
    blockedKeywords   []string  // é˜»æ­¢ DROP, DELETE, UPDATE, INSERT, ALTER, TRUNCATE, EXEC
    maxQueryLength    int       // SQLæœ€å¤§é•¿åº¦
    maxJoinTables     int       // æœ€å¤§JOINè¡¨æ•°
    maxSubqueries     int       // æœ€å¤§å­æŸ¥è¯¢æ·±åº¦
}
```

å®‰å…¨éªŒè¯é“¾:
1. **è¯­å¥ç±»å‹ç™½åå•**: ä»…å…è®¸ `SELECT` è¯­å¥
2. **å…³é”®è¯é»‘åå•**: æ‹’ç»å«æœ‰ DDL/DML å…³é”®è¯çš„æŸ¥è¯¢
3. **SQL AST è§£æ**: ä½¿ç”¨ `pg_query_go`ï¼ˆå·²å¼•å…¥ä¾èµ–ï¼‰è§£æSQLè¯­æ³•æ ‘ï¼Œè¿›è¡Œæ·±åº¦å®‰å…¨æ£€æŸ¥
4. **èµ„æºé™åˆ¶**: å¼ºåˆ¶æ·»åŠ  `LIMIT` å­å¥ã€è®¾ç½®æŸ¥è¯¢è¶…æ—¶
5. **è¡¨æƒé™æ ¡éªŒ**: éªŒè¯æŸ¥è¯¢æ¶‰åŠçš„è¡¨æ˜¯å¦åœ¨å½“å‰ç”¨æˆ·æœ‰æƒè®¿é—®çš„èŒƒå›´å†…

### 9.3 æŸ¥è¯¢ç»“æœå¤„ç†

```mermaid
flowchart LR
    A[SQLæŸ¥è¯¢ç»“æœ] --> B{ç»“æœç±»å‹åˆ¤æ–­}
    B -->|å•å€¼| C[ç›´æ¥å›ç­”]
    B -->|è¡¨æ ¼æ•°æ®| D[Markdownè¡¨æ ¼æ ¼å¼åŒ–]
    B -->|èšåˆæ•°æ®| E[å›¾è¡¨å¯è§†åŒ–å»ºè®®]
    B -->|å¤§ç»“æœé›†| F[æ‘˜è¦ + åˆ†é¡µ]
    C & D & E & F --> G[ä½œä¸ºContextæ³¨å…¥LLM]
    G --> H[ç”Ÿæˆè‡ªç„¶è¯­è¨€å›ç­”]
```

### 9.4 ä¸ç°æœ‰ Pipeline çš„é›†æˆ

åœ¨ ChatPipeline çš„ `Search` é˜¶æ®µä¹‹åã€`Merge` é˜¶æ®µä¹‹å‰æ’å…¥æ–°çš„å¤„ç†ç¯èŠ‚ï¼š

```
Rewrite â†’ Search â†’ SearchEntity â†’ SearchParallel â†’ [StructuredSearch] â†’ [NL2SQL] 
â†’ Rerank â†’ FilterTopK â†’ Merge â†’ DataAnalysis(å¢å¼º) â†’ IntoChatMessage â†’ ChatCompletion
```

- `PluginStructuredSearch`: å¯¹ Database ç±»å‹çŸ¥è¯†åº“è¿›è¡Œå…ƒæ•°æ®æ£€ç´¢ï¼Œæ‰¾åˆ°ç›¸å…³ Schema
- `PluginNL2SQL`: åŸºäº Schema ä¸Šä¸‹æ–‡è°ƒç”¨ LLM ç”Ÿæˆ SQLï¼Œæ‰§è¡ŒæŸ¥è¯¢ï¼Œå°†ç»“æœæ³¨å…¥ `ChatManage.MergeResult`

---

## åã€æŠ€æœ¯é€‰å‹å¯¹æ¯”åˆ†æ

### 10.1 æ•°æ®åº“è¿æ¥æ–¹å¼å¯¹æ¯”

| æ–¹æ¡ˆ | æ”¯æŒæ•°æ®åº“ | Goç”Ÿæ€æ”¯æŒ | æ€§èƒ½ | ç»Ÿä¸€æ€§ | æ¨èåº¦ |
|------|-----------|------------|------|--------|--------|
| **åŸç”ŸGo Driver** | å„æ•°æ®åº“ä¸“ç”¨ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜† | â­â­â­â­â­ |
| **database/sql + Driver** | æ‰€æœ‰SQLæ•°æ®åº“ | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜… | â­â­â­â­â­ |
| **SQLAlchemy(Python)** | å…¨é¢ | â˜…â˜†â˜† (éœ€è·¨è¯­è¨€) | â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â­â­ |
| **JDBC (JVM)** | å…¨é¢ | â˜…â˜†â˜† (éœ€è·¨è¯­è¨€) | â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â­â­ |
| **ODBC** | å…¨é¢ | â˜…â˜…â˜… | â˜…â˜…â˜… | â˜…â˜…â˜…â˜… | â­â­â­ |
| **Trino/Presto** | å…¨é¢ï¼ˆè”é‚¦æŸ¥è¯¢ï¼‰ | â˜…â˜…â˜… | â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… | â­â­â­ (åæœŸè€ƒè™‘) |

**æ¨èæ–¹æ¡ˆ**: é‡‡ç”¨ Go `database/sql` æ ‡å‡†æ¥å£ + å„æ•°æ®åº“åŸç”Ÿ Driver çš„ç»„åˆæ–¹æ¡ˆã€‚

**ç†ç”±**:
- WeKnora ä¸»ä½“ä¸º Go é¡¹ç›®ï¼ŒåŸç”Ÿ Go Driver æ€§èƒ½æœ€ä¼˜ã€éƒ¨ç½²æœ€ç®€
- `database/sql` æä¾›ç»Ÿä¸€çš„è¿æ¥æ± ç®¡ç†å’Œäº‹åŠ¡æ¥å£ï¼Œä¾¿äºæŠ½è±¡
- é¿å…å¼•å…¥ JVM/Python è¿è¡Œæ—¶å¸¦æ¥çš„é¢å¤–è¿ç»´å¤æ‚åº¦å’Œæ€§èƒ½å¼€é”€
- å„æ•°æ®åº“ Go Driver æˆç†Ÿåº¦é«˜ï¼š`go-sql-driver/mysql`ã€`pgx`ã€`godror`ã€`go-mssqldb`ã€`clickhouse-go`

### 10.2 æ•°æ®åŒæ­¥æ–¹å¼å¯¹æ¯”

| æ–¹æ¡ˆ | å®æ—¶æ€§ | å®ç°å¤æ‚åº¦ | è¿ç»´æˆæœ¬ | å¯¹æºåº“å½±å“ | é€‚ç”¨åœºæ™¯ |
|------|--------|------------|----------|------------|----------|
| **å…¨é‡æŠ½å–** | ä½ | ä½ | ä½ | ä¸­ï¼ˆå…¨è¡¨æ‰«æï¼‰ | åˆæ¬¡åŒæ­¥ã€å°è¡¨ã€æ— å¢é‡æ ‡è¯† |
| **å¢é‡åŒæ­¥(æ—¶é—´æˆ³/ä¸»é”®)** | ä¸­ | ä¸­ | ä½ | ä½ | æœ‰è§„èŒƒæ›´æ–°æ—¶é—´æˆ³çš„è¡¨ |
| **CDC (Debezium)** | é«˜ | é«˜ | é«˜ï¼ˆéœ€Kafka+Debeziumï¼‰ | æä½ï¼ˆè¯»binlogï¼‰ | å®æ—¶æ€§è¦æ±‚é«˜çš„æ ¸å¿ƒè¡¨ |

**æ¨èæ–¹æ¡ˆ**: é˜¶æ®µåŒ–é‡‡ç”¨ã€‚

- **ç¬¬ä¸€é˜¶æ®µ**: å…¨é‡æŠ½å– + å¢é‡åŒæ­¥ï¼ˆè¦†ç›–80%åœºæ™¯ï¼Œå®ç°æˆæœ¬ä½ï¼‰
- **ç¬¬äºŒé˜¶æ®µ**: å¼•å…¥ CDC æ”¯æŒï¼ˆé’ˆå¯¹é«˜å®æ—¶æ€§éœ€æ±‚åœºæ™¯ï¼‰

### 10.3 ç´¢å¼•æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å‘é‡æ£€ç´¢ | å…¨æ–‡æ£€ç´¢ | ç»“æ„åŒ–è¿‡æ»¤ | æ··åˆæŸ¥è¯¢ | ç°æœ‰é›†æˆåº¦ |
|------|----------|----------|------------|----------|------------|
| **Elasticsearch** | âœ… dense_vector | âœ… BM25 | âœ… | âœ… | â˜…â˜…â˜…â˜…â˜… å·²é›†æˆ |
| **PostgreSQL + pgvector** | âœ… | âœ… tsvector | âœ… | âœ… | â˜…â˜…â˜…â˜…â˜… å·²é›†æˆ |
| **Qdrant** | âœ… | âŒ | âœ… payload filter | éƒ¨åˆ† | â˜…â˜…â˜…â˜… å·²é›†æˆ |
| **Milvus** | âœ… | âŒ | âœ… scalar filter | éƒ¨åˆ† | â˜† æœªé›†æˆ |
| **Weaviate** | âœ… | âœ… | âœ… | âœ… | â˜† æœªé›†æˆ |
| **OpenSearch** | âœ… knn | âœ… | âœ… | âœ… | â˜† æœªé›†æˆï¼ˆESå…¼å®¹ï¼‰ |
| **ClickHouse** | âœ… (å®éªŒæ€§) | âœ… | â˜…â˜…â˜…â˜…â˜… | éƒ¨åˆ† | â˜† æœªé›†æˆ |

**æ¨èæ–¹æ¡ˆ**: å¤ç”¨ç°æœ‰ Elasticsearch/PostgreSQL ä½œä¸ºå…ƒæ•°æ®ç´¢å¼•å¼•æ“ã€‚

**ç†ç”±**:
- ç»“æ„åŒ–æ•°æ®åº“çŸ¥è¯†åº“çš„å…ƒæ•°æ®ç´¢å¼•ï¼ˆè¡¨æ‘˜è¦ã€åˆ—æè¿°ï¼‰æœ¬è´¨ä¸Šä»æ˜¯æ–‡æœ¬ç´¢å¼•
- ç°æœ‰ `RetrieveEngineService` æ¥å£å®Œå…¨å¯ä»¥å¤ç”¨
- é¿å…å¼•å…¥æ–°çš„å‘é‡æ•°æ®åº“å¸¦æ¥çš„è¿ç»´æˆæœ¬
- Elasticsearch å¤©ç„¶æ”¯æŒç»“æ„åŒ–å­—æ®µè¿‡æ»¤ + å‘é‡æ£€ç´¢çš„æ··åˆæŸ¥è¯¢

### 10.4 è°ƒåº¦ä¸æ•°æ®ç®¡é“å¯¹æ¯”

| æ–¹æ¡ˆ | åŠŸèƒ½ä¸°å¯Œåº¦ | Goé›†æˆ | è¿ç»´å¤æ‚åº¦ | æ¨èåº¦ |
|------|-----------|--------|------------|--------|
| **Asynq (ç°æœ‰)** | â˜…â˜…â˜… | â˜…â˜…â˜…â˜…â˜… (åŸç”ŸGo) | â˜…â˜† (å·²é›†æˆRedis) | â­â­â­â­â­ |
| **Apache Airflow** | â˜…â˜…â˜…â˜…â˜… | â˜…â˜… (Python) | â˜…â˜…â˜…â˜… | â­â­ |
| **Apache NiFi** | â˜…â˜…â˜…â˜… | â˜…â˜… (Java) | â˜…â˜…â˜…â˜… | â­â­ |
| **Kafka** | â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜… | â˜…â˜…â˜…â˜… | â­â­â­ (CDCåœºæ™¯) |

**æ¨èæ–¹æ¡ˆ**: 
- **åŸºç¡€è°ƒåº¦**: å¤ç”¨ç°æœ‰ Asynqï¼ˆå·²é›†æˆ Redis åç«¯ï¼Œæ»¡è¶³å®šæ—¶ä»»åŠ¡/å¢é‡åŒæ­¥éœ€æ±‚ï¼‰
- **CDCåœºæ™¯**: å¼•å…¥ Kafka ä½œä¸ºå˜æ›´äº‹ä»¶ç®¡é“ï¼ˆä»…åœ¨ç¬¬äºŒé˜¶æ®µCDCéœ€æ±‚æ—¶ï¼‰

---

## åä¸€ã€æ€§èƒ½ä¸æ‰©å±•æ€§è®¾è®¡

### 11.1 æ€§èƒ½è®¾è®¡

#### è¿æ¥æ± ç®¡ç†

```go
// ConnectorPool è¿æ¥å™¨æ± 
type ConnectorPool struct {
    maxSize          int
    idleTimeout      time.Duration
    healthCheckInterval time.Duration
    connectors       sync.Pool
    activeCount      atomic.Int64
}
```

- æ¯ä¸ªå¤–éƒ¨æ•°æ®åº“è¿æ¥é…ç½®ç»´æŠ¤ç‹¬ç«‹è¿æ¥æ± ï¼Œé»˜è®¤ 5 ä¸ªè¿æ¥/æ± 
- ç©ºé—²è¿æ¥è¶…æ—¶å›æ”¶ï¼ˆé»˜è®¤ 10 åˆ†é’Ÿï¼‰
- åå°å¥åº·æ£€æŸ¥ï¼ˆé»˜è®¤ 30 ç§’é—´éš”ï¼‰

#### æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–

| ç­–ç•¥ | è¯´æ˜ |
|------|------|
| **æŸ¥è¯¢ç¼“å­˜** | å¯¹çƒ­ç‚¹NL2SQLç»“æœåšRedisç¼“å­˜ï¼ˆkey=query_hash+schema_hash, TTL=5minï¼‰ |
| **é‡‡æ ·é¢„çƒ­** | Schemaå‘ç°æ—¶é¢„åŠ è½½TOP 1000é‡‡æ ·æ•°æ®ï¼Œç”Ÿæˆç»Ÿè®¡ä¿¡æ¯è¾…åŠ©æŸ¥è¯¢ä¼˜åŒ– |
| **åˆ†é¡µæµå¼** | å¤§ç»“æœé›†ä½¿ç”¨cursor-based paginationï¼Œé¿å…å†…å­˜æº¢å‡º |
| **æŸ¥è¯¢è¶…æ—¶** | æ‰€æœ‰å¤–éƒ¨æŸ¥è¯¢å¼ºåˆ¶60ç§’è¶…æ—¶ï¼ˆå¯é…ç½®ï¼‰ï¼Œé˜²æ­¢æ…¢æŸ¥è¯¢é˜»å¡ |
| **å¹¶å‘é™åˆ¶** | å•ç§Ÿæˆ·åŒæ—¶æŸ¥è¯¢å¹¶å‘æ•°é™åˆ¶ï¼ˆé»˜è®¤10ï¼‰ï¼Œé€šè¿‡ä¿¡å·é‡æ§åˆ¶ |

#### ç´¢å¼•æ€§èƒ½

- å…ƒæ•°æ®ç´¢å¼•é‡è¿œå°äºæ–‡æ¡£åˆ‡ç‰‡ç´¢å¼•é‡ï¼ˆé€šå¸¸ <10000 æ¡/çŸ¥è¯†åº“ï¼‰ï¼Œå¯¹ç°æœ‰æ£€ç´¢å¼•æ“æ— æ€§èƒ½å‹åŠ›
- Schemaå˜æ›´æ£€æµ‹å’Œé‡æ–°ç´¢å¼•ä¸ºå¼‚æ­¥ä»»åŠ¡ï¼Œä¸é˜»å¡åœ¨çº¿æŸ¥è¯¢

### 11.2 æ‰©å±•æ€§è®¾è®¡

| ç»´åº¦ | è®¾è®¡ |
|------|------|
| **æ°´å¹³æ‰©å±•** | å„æ•°æ®åº“è¿æ¥å™¨æ— çŠ¶æ€ï¼Œå¯éƒ¨ç½²å¤šå®ä¾‹ï¼Œè¿æ¥æ± åˆ†å¸ƒåœ¨å„å®ä¾‹ |
| **æ–°æ•°æ®åº“ç±»å‹** | å®ç° `DatabaseConnector` æ¥å£ + åœ¨ `ConnectorRegistry` æ³¨å†Œå³å¯ |
| **æ–°æ£€ç´¢æ–¹å¼** | å®ç° `RetrieveEngineRepository` æ¥å£ + åœ¨ `RetrieveEngineRegistry` æ³¨å†Œå³å¯ |
| **æ–°åŒæ­¥ç­–ç•¥** | å®ç° `SyncWorker` æ¥å£ + æ³¨å†Œ Asynq ä»»åŠ¡å¤„ç†å™¨å³å¯ |
| **å¤šç§Ÿæˆ·éš”ç¦»** | è¿æ¥é…ç½®æŒ‰ `TenantID` éš”ç¦»ï¼Œæ¯ä¸ªç§Ÿæˆ·ç‹¬ç«‹çš„è¿æ¥æ± ä¸Šé™ |

---

## åäºŒã€å®‰å…¨ä¸æƒé™æ§åˆ¶è®¾è®¡

### 12.1 å®‰å…¨æ¶æ„

```mermaid
graph TB
    subgraph "åº”ç”¨å®‰å…¨å±‚"
        A[JWT é‰´æƒ]
        B[ç§Ÿæˆ·éš”ç¦»]
        C[RBAC æƒé™æ§åˆ¶]
    end

    subgraph "æ•°æ®åº“è¿æ¥å®‰å…¨å±‚"
        D[å‡­æ®åŠ å¯†å­˜å‚¨<br/>AES-256-GCM]
        E[è¿æ¥ç™½åå•<br/>IP/ç«¯å£é™åˆ¶]
        F[SSL/TLS è¿æ¥]
    end

    subgraph "æŸ¥è¯¢å®‰å…¨å±‚"
        G[SQL ç™½åå•éªŒè¯<br/>ä»…å…è®¸SELECT]
        H[SQL AST æ·±åº¦åˆ†æ<br/>pg_query_go]
        I[æŸ¥è¯¢èµ„æºé™åˆ¶<br/>è¶…æ—¶/è¡Œæ•°/è¡¨æ•°]
        J[è¡¨çº§æƒé™æ§åˆ¶]
    end

    subgraph "æ•°æ®å®‰å…¨å±‚"
        K[æ•æ„Ÿå­—æ®µè„±æ•]
        L[å®¡è®¡æ—¥å¿—]
        M[ç»“æœé›†å¤§å°é™åˆ¶]
    end

    A --> B --> C
    C --> D & G
    D --> E --> F
    G --> H --> I --> J
    J --> K --> L --> M
```

### 12.2 å…·ä½“å®‰å…¨æªæ–½

| å®‰å…¨å±‚é¢ | æªæ–½ | å®ç°æ–¹å¼ |
|----------|------|----------|
| **å‡­æ®å­˜å‚¨** | å¯†ç  AES-256-GCM åŠ å¯† | åŠ å¯†å¯†é’¥ä»ç¯å¢ƒå˜é‡è¯»å–ï¼Œå¯†ç ä¸æ˜æ–‡å­˜åº“ |
| **ç½‘ç»œå®‰å…¨** | å¼ºåˆ¶ SSL è¿æ¥é€‰é¡¹ | è¿æ¥é…ç½®ä¸­ `ssl_mode` å‚æ•°æ§åˆ¶ |
| **æŸ¥è¯¢å®‰å…¨** | SQL ç™½åå• + AST å®¡æŸ¥ | `pg_query_go` è§£æè¯­æ³•æ ‘ï¼Œæ‹’ç»é SELECT è¯­å¥ |
| **èµ„æºé˜²æŠ¤** | æŸ¥è¯¢è¶…æ—¶ + è¡Œæ•°é™åˆ¶ | `QueryOptions.Timeout`, `QueryOptions.MaxRows` |
| **æƒé™æ§åˆ¶** | è¡¨çº§ç™½åå• | `SchemaRegistry` ä¸­æ ‡è®°å…è®¸æŸ¥è¯¢çš„è¡¨ |
| **æ•°æ®è„±æ•** | æ•æ„Ÿåˆ—æ ‡è®° + è„±æ•è§„åˆ™ | `ColumnMeta.Sensitive=true` æ—¶è‡ªåŠ¨è„±æ• |
| **å®¡è®¡æ—¥å¿—** | æ‰€æœ‰æŸ¥è¯¢è®°å½•å®¡è®¡ | è®°å½• who/when/what/result_count |

### 12.3 å¤šç§Ÿæˆ·å®‰å…¨éš”ç¦»

```
ç§Ÿæˆ·A â†’ è¿æ¥é…ç½®A1 â†’ MySQLå®ä¾‹1 â†’ ä»…å¯è§å·²æ³¨å†Œè¡¨
     â†’ è¿æ¥é…ç½®A2 â†’ PostgreSQLå®ä¾‹2 â†’ ä»…å¯è§å·²æ³¨å†Œè¡¨

ç§Ÿæˆ·B â†’ è¿æ¥é…ç½®B1 â†’ Oracleå®ä¾‹3 â†’ ç‹¬ç«‹å‘½åç©ºé—´
```

- è¿æ¥é…ç½®ä¸ `KnowledgeBase` ç»‘å®šï¼Œç»§æ‰¿çŸ¥è¯†åº“çš„å¯è§æ€§è§„åˆ™ï¼ˆ`global`/`org`/`private`ï¼‰
- æŸ¥è¯¢æ—¶è‡ªåŠ¨æ³¨å…¥ç§Ÿæˆ·IDè¿‡æ»¤ï¼Œé˜²æ­¢è·¨ç§Ÿæˆ·æ•°æ®æ³„éœ²
- è¿æ¥æ± æŒ‰ç§Ÿæˆ·-è¿æ¥é…ç½®äºŒçº§éš”ç¦»

---

## åä¸‰ã€é£é™©è¯„ä¼°

### 13.1 æŠ€æœ¯é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|------|------|------|----------|
| **å¤–éƒ¨æ•°æ®åº“ä¸å¯è¾¾** | ç»“æ„åŒ–æŸ¥è¯¢å¤±è´¥ï¼Œå½±å“ç”¨æˆ·ä½“éªŒ | ä¸­ | ğŸŸ¡ ä¸­ | è¿æ¥å¥åº·æ£€æŸ¥ + é™çº§ç­–ç•¥ï¼ˆè¿”å›ç¼“å­˜ç»“æœæˆ–æç¤ºç”¨æˆ·ï¼‰ |
| **NL2SQLç”Ÿæˆé”™è¯¯SQL** | æŸ¥è¯¢ç»“æœä¸æ­£ç¡®ï¼Œè¯¯å¯¼ç”¨æˆ· | é«˜ | ğŸ”´ é«˜ | SQLéªŒè¯é“¾ + ç»“æœç½®ä¿¡åº¦è¯„åˆ† + å¤šè½®ç¡®è®¤æœºåˆ¶ |
| **å¤§è¡¨å…¨é‡åŒæ­¥OOM** | åŒæ­¥æœåŠ¡å´©æºƒ | ä¸­ | ğŸŸ¡ ä¸­ | åˆ†é¡µæŠ½å– + å†…å­˜é™åˆ¶ + è¡Œæ•°ä¸Šé™ |
| **SQLæ³¨å…¥** | å®‰å…¨æ¼æ´ï¼Œæ•°æ®æ³„éœ²/ç ´å | ä½ | ğŸ”´ é«˜ | ASTéªŒè¯ + å‚æ•°åŒ–æŸ¥è¯¢ + ç™½åå• + åªè¯»è¿æ¥ |
| **è¿æ¥æ³„éœ²** | å¤–éƒ¨æ•°æ®åº“è¿æ¥è€—å°½ | ä½ | ğŸŸ¡ ä¸­ | è¿æ¥æ± ç®¡ç† + ç©ºé—²è¶…æ—¶ + æ³„éœ²æ£€æµ‹ |
| **Schemaå˜æ›´å¯¼è‡´ç´¢å¼•å¤±æ•ˆ** | æ£€ç´¢ç»“æœä¸å‡†ç¡® | ä¸­ | ğŸŸ¡ ä¸­ | å®šæœŸSchemaå¯¹æ¯” + å˜æ›´äº‹ä»¶é€šçŸ¥ |

### 13.2 ä¸šåŠ¡é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|------|------|------|----------|
| **ç”¨æˆ·è¯¯æ“ä½œæš´éœ²æ•æ„Ÿæ•°æ®** | æ•°æ®åˆè§„é—®é¢˜ | ä¸­ | ğŸ”´ é«˜ | æ•æ„Ÿåˆ—è¯†åˆ« + è‡ªåŠ¨è„±æ• + å®¡è®¡æ—¥å¿— |
| **æ•°æ®åº“è¿æ¥å‡­æ®ç®¡ç†å¤æ‚** | å®‰å…¨è¿ç»´è´Ÿæ‹… | é«˜ | ğŸŸ¡ ä¸­ | åŠ å¯†å­˜å‚¨ + å‡­æ®è½®è½¬æé†’ + äº‘IAMé›†æˆ |
| **NL2SQLç†è§£åå·®** | ç”¨æˆ·å¾—åˆ°é”™è¯¯åˆ†æç»“è®º | é«˜ | ğŸŸ¡ ä¸­ | å±•ç¤ºç”Ÿæˆçš„SQL + å…è®¸ç”¨æˆ·ä¿®æ”¹ + ç»“æœéªŒè¯ |

### 13.3 è¿ç»´é£é™©

| é£é™© | å½±å“ | æ¦‚ç‡ | ç­‰çº§ | ç¼“è§£æªæ–½ |
|------|------|------|------|----------|
| **CDCå¼•å…¥Kafka/Debeziumå¢åŠ è¿ç»´å¤æ‚åº¦** | ç³»ç»Ÿå¯é æ€§ä¸‹é™ | ä¸­ | ğŸŸ¡ ä¸­ | ç¬¬äºŒé˜¶æ®µæ‰å¼•å…¥ + æä¾›éCDCæ›¿ä»£æ–¹æ¡ˆ |
| **å¤šç§æ•°æ®åº“é©±åŠ¨çš„å…¼å®¹æ€§é—®é¢˜** | æŸäº›æ•°æ®åº“è¿æ¥å¼‚å¸¸ | ä¸­ | ğŸŸ¡ ä¸­ | å®Œå–„æ¯ç§æ•°æ®åº“çš„é›†æˆæµ‹è¯• + é€æ­¥ç°åº¦ |
| **åŒæ­¥ä»»åŠ¡ç§¯å‹** | æ•°æ®æ—¶æ•ˆæ€§ä¸‹é™ | ä½ | ğŸŸ¢ ä½ | Asynqé˜Ÿåˆ—ç›‘æ§ + ä¼˜å…ˆçº§è°ƒåº¦ + å‘Šè­¦ |

---

## åå››ã€åˆ†é˜¶æ®µå®æ–½è·¯çº¿

### é˜¶æ®µä¸€ï¼šåŸºç¡€æ¥å…¥ï¼ˆ4-6å‘¨ï¼‰

**ç›®æ ‡**: å®Œæˆæ•°æ®åº“è¿æ¥å±‚å’ŒSchemaå‘ç°èƒ½åŠ›

```mermaid
gantt
    title é˜¶æ®µä¸€ï¼šåŸºç¡€æ¥å…¥
    dateFormat  YYYY-MM-DD
    section æ•°æ®æ¨¡å‹
    æ–°å¢KnowledgeBaseType        :a1, 2026-03-01, 3d
    DatabaseConnectionConfigæ¨¡å‹  :a2, after a1, 3d
    SchemaRegistryæ¨¡å‹           :a3, after a2, 3d
    section è¿æ¥å™¨
    ConnectorRegistryæ¡†æ¶        :b1, 2026-03-01, 5d
    MySQLè¿æ¥å™¨                  :b2, after b1, 4d
    PostgreSQLè¿æ¥å™¨             :b3, after b1, 4d
    section Schemaå‘ç°
    Schemaè‡ªåŠ¨å‘ç°æœåŠ¡            :c1, after b2, 5d
    LLMè¡¨/åˆ—æè¿°ç”Ÿæˆ             :c2, after c1, 5d
    å…ƒæ•°æ®å‘é‡åŒ–ç´¢å¼•              :c3, after c2, 3d
    section API
    è¿æ¥ç®¡ç†HTTPæ¥å£              :d1, after a2, 5d
    è¿æ¥æµ‹è¯•æ¥å£                  :d2, after d1, 3d
```

**äº¤ä»˜ç‰©**:
- Database ç±»å‹çŸ¥è¯†åº“åˆ›å»º/ç®¡ç†
- MySQLã€PostgreSQL ä¸¤ç§æ•°æ®åº“è¿æ¥èƒ½åŠ›
- Schemaè‡ªåŠ¨å‘ç°å’Œå…ƒæ•°æ®æ³¨å†Œ
- LLMé©±åŠ¨çš„è¡¨/åˆ—æè¿°ç”Ÿæˆ
- å…ƒæ•°æ®å‘é‡åŒ–ç´¢å¼•

### é˜¶æ®µäºŒï¼šæŸ¥è¯¢èƒ½åŠ›ï¼ˆ4-6å‘¨ï¼‰

**ç›®æ ‡**: å®ç°NL2SQLå’Œç»“æ„åŒ–æŸ¥è¯¢èƒ½åŠ›

**äº¤ä»˜ç‰©**:
- NL2SQL æœåŠ¡ï¼ˆåŸºäºLLM + Schemaä¸Šä¸‹æ–‡ï¼‰
- SQL å®‰å…¨éªŒè¯é“¾
- ChatPipeline ç»“æ„åŒ–æœç´¢æ’ä»¶
- æ··åˆæ£€ç´¢ï¼ˆè¯­ä¹‰+SQLï¼‰
- æŸ¥è¯¢ç»“æœæ ¼å¼åŒ–
- Oracleã€SQL Server è¿æ¥å™¨

### é˜¶æ®µä¸‰ï¼šæ•°æ®åŒæ­¥ï¼ˆ3-4å‘¨ï¼‰

**ç›®æ ‡**: å®ç°å…¨é‡å’Œå¢é‡æ•°æ®åŒæ­¥

**äº¤ä»˜ç‰©**:
- å…¨é‡æŠ½å– Worker
- å¢é‡åŒæ­¥ Worker (åŸºäºæ—¶é—´æˆ³/ä¸»é”®)
- åŒæ­¥ä»»åŠ¡ç®¡ç†å’Œç›‘æ§
- æ–­ç‚¹ç»­ä¼ 
- ClickHouse è¿æ¥å™¨

### é˜¶æ®µå››ï¼šé«˜çº§ç‰¹æ€§ï¼ˆ4-6å‘¨ï¼‰

**ç›®æ ‡**: CDCã€é«˜çº§å®‰å…¨ã€æ€§èƒ½ä¼˜åŒ–

**äº¤ä»˜ç‰©**:
- CDC é›†æˆï¼ˆDebezium + Kafkaï¼‰
- æ•æ„Ÿæ•°æ®è¯†åˆ«ä¸è„±æ•
- æŸ¥è¯¢ç¼“å­˜ä¸æ€§èƒ½ä¼˜åŒ–
- äº‘RDSé€‚é…ï¼ˆIAMè®¤è¯ã€SSLï¼‰
- å®Œæ•´çš„å®¡è®¡æ—¥å¿—

### é‡Œç¨‹ç¢‘æ€»è§ˆ

| é‡Œç¨‹ç¢‘ | é¢„è®¡æ—¶é—´ | å…³é”®äº¤ä»˜ |
|--------|----------|----------|
| M1 - åŸºç¡€æ¥å…¥ | T+6å‘¨ | æ•°æ®åº“è¿æ¥ + Schemaå‘ç° + å…ƒæ•°æ®ç´¢å¼• |
| M2 - æŸ¥è¯¢èƒ½åŠ› | T+12å‘¨ | NL2SQL + æ··åˆæ£€ç´¢ + 4ç§æ•°æ®åº“ |
| M3 - æ•°æ®åŒæ­¥ | T+16å‘¨ | å…¨é‡/å¢é‡åŒæ­¥ + 5ç§æ•°æ®åº“ |
| M4 - é«˜çº§ç‰¹æ€§ | T+22å‘¨ | CDC + å®‰å…¨å¢å¼º + 6ç§æ•°æ®åº“ |

---

## åäº”ã€æœªæ¥æ¼”è¿›æ–¹å‘

### 15.1 çŸ­æœŸæ¼”è¿›ï¼ˆ6-12ä¸ªæœˆï¼‰

| æ–¹å‘ | è¯´æ˜ |
|------|------|
| **æ›´å¤šæ•°æ®åº“** | æ”¯æŒ TiDBã€GaussDBã€DMï¼ˆè¾¾æ¢¦ï¼‰ç­‰å›½äº§æ•°æ®åº“ |
| **è”é‚¦æŸ¥è¯¢** | å¼•å…¥ Trino ä½œä¸ºè”é‚¦æŸ¥è¯¢å¼•æ“ï¼Œæ”¯æŒè·¨åº“JOIN |
| **æ•°æ®è¡€ç¼˜** | è¿½è¸ªæ•°æ®æ¥æºå’Œè½¬æ¢é“¾è·¯ï¼Œè¾…åŠ©æ•°æ®æ²»ç† |
| **è‡ªåŠ¨å¯è§†åŒ–** | åŸºäºæŸ¥è¯¢ç»“æœè‡ªåŠ¨ç”Ÿæˆå›¾è¡¨ï¼ˆæŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾ã€é¥¼å›¾ï¼‰ |

### 15.2 ä¸­æœŸæ¼”è¿›ï¼ˆ1-2å¹´ï¼‰

| æ–¹å‘ | è¯´æ˜ |
|------|------|
| **æ™ºèƒ½æ•°æ®åˆ†æAgent** | åŸºäº Agent æ¡†æ¶å®ç°å¤šæ­¥éª¤æ•°æ®åˆ†æå·¥ä½œæµ |
| **æ•°æ®è´¨é‡ç›‘æ§** | è‡ªåŠ¨æ£€æµ‹æ•°æ®å¼‚å¸¸ã€ç¼ºå¤±ã€ä¸ä¸€è‡´ |
| **çŸ¥è¯†å›¾è°±èåˆ** | å°†ç»“æ„åŒ–æ•°æ®çš„è¡¨å…³ç³»å¯¼å…¥ Neo4jï¼Œä¸æ–‡æ¡£çŸ¥è¯†å›¾è°±èåˆ |
| **å®æ—¶æ•°æ®ä»ªè¡¨ç›˜** | æ”¯æŒå®šä¹‰æŒ‡æ ‡ã€åˆ›å»ºå®æ—¶ç›‘æ§ä»ªè¡¨ç›˜ |

### 15.3 é•¿æœŸæ„¿æ™¯ï¼ˆ2å¹´+ï¼‰

| æ–¹å‘ | è¯´æ˜ |
|------|------|
| **Data Fabric** | æ„å»ºä¼ä¸šçº§æ•°æ®ç¼–ç»‡å±‚ï¼Œç»Ÿä¸€æ‰€æœ‰æ•°æ®èµ„äº§è®¿é—® |
| **è‡ªæ²»æ•°æ®åº“ç®¡ç†** | AIé©±åŠ¨çš„ç´¢å¼•æ¨èã€æŸ¥è¯¢ä¼˜åŒ–ã€å®¹é‡è§„åˆ’ |
| **å¤šæ¨¡æ€æ•°æ®èåˆ** | æ–‡æ¡£ + æ•°æ®åº“ + API + å®æ—¶æµçš„ç»Ÿä¸€çŸ¥è¯†å±‚ |
| **éšç§è®¡ç®—** | æ”¯æŒè”é‚¦å­¦ä¹ ã€å®‰å…¨å¤šæ–¹è®¡ç®—ç­‰éšç§ä¿æŠ¤æ•°æ®åˆ†æ |

---

## é™„å½• Aï¼šå…³é”®æ¥å£å®šä¹‰æ±‡æ€»

```go
// â”€â”€â”€ æ–°å¢æ¥å£ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// interfaces/database_connector.go

type DatabaseConnector interface {
    Type() DatabaseType
    Connect(ctx context.Context, config *DatabaseConnectionConfig) error
    Ping(ctx context.Context) error
    Close() error
    DiscoverSchemas(ctx context.Context) ([]*SchemaInfo, error)
    DiscoverTables(ctx context.Context, schema string) ([]*TableInfo, error)
    DescribeTable(ctx context.Context, schema, table string) (*TableDetail, error)
    SampleData(ctx context.Context, schema, table string, limit int) ([]map[string]interface{}, error)
    ExecuteQuery(ctx context.Context, sql string, args []interface{}, opts *QueryOptions) (*QueryResult, error)
    EstimateRowCount(ctx context.Context, schema, table string) (int64, error)
}

type ConnectorRegistry interface {
    Register(dbType DatabaseType, factory ConnectorFactory)
    GetConnector(ctx context.Context, configID string) (DatabaseConnector, error)
    CloseAll() error
}

type SchemaRegistryService interface {
    DiscoverAndRegister(ctx context.Context, kbID string, connConfigID string) error
    GetRegisteredSchemas(ctx context.Context, kbID string) ([]*SchemaRegistry, error)
    RefreshSchema(ctx context.Context, registryID string) error
}

type DataSyncService interface {
    FullSync(ctx context.Context, kbID string, tableFilter []string) error
    IncrementalSync(ctx context.Context, kbID string) error
    GetSyncStatus(ctx context.Context, kbID string) ([]*SyncTask, error)
}

type NL2SQLService interface {
    GenerateSQL(ctx context.Context, params *NL2SQLParams) (*NL2SQLResult, error)
    ValidateSQL(ctx context.Context, sql string) error
    ExecuteAndFormat(ctx context.Context, connectorID string, sql string) (*FormattedResult, error)
}
```

## é™„å½• Bï¼šç¯å¢ƒå˜é‡é…ç½®å‚è€ƒ

| ç¯å¢ƒå˜é‡ | è¯´æ˜ | é»˜è®¤å€¼ |
|----------|------|--------|
| `DB_CONNECTOR_ENCRYPTION_KEY` | æ•°æ®åº“å‡­æ®åŠ å¯†å¯†é’¥ï¼ˆ32å­—èŠ‚Base64ï¼‰ | å¿…å¡« |
| `DB_CONNECTOR_MAX_POOL_SIZE` | æ¯ä¸ªå¤–éƒ¨è¿æ¥çš„è¿æ¥æ± ä¸Šé™ | 5 |
| `DB_CONNECTOR_IDLE_TIMEOUT` | ç©ºé—²è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰ | 600 |
| `DB_CONNECTOR_QUERY_TIMEOUT` | æŸ¥è¯¢è¶…æ—¶ï¼ˆç§’ï¼‰ | 60 |
| `DB_CONNECTOR_MAX_ROWS` | å•æ¬¡æŸ¥è¯¢æœ€å¤§è¡Œæ•° | 10000 |
| `NL2SQL_CONFIDENCE_THRESHOLD` | NL2SQLæœ€ä½ç½®ä¿¡åº¦é˜ˆå€¼ | 0.7 |
| `CDC_KAFKA_BROKERS` | Kafka Broker åœ°å€ï¼ˆCDCå¯ç”¨æ—¶ï¼‰ | - |
| `CDC_DEBEZIUM_CONNECT_URL` | Debezium Connect API åœ°å€ | - |

## é™„å½• Cï¼šä¸ç°æœ‰æ¨¡å—å˜æ›´å½±å“åˆ†æ

| æ¨¡å— | å˜æ›´ç±»å‹ | å½±å“èŒƒå›´ | é£é™©ç­‰çº§ |
|------|----------|----------|----------|
| `types/knowledgebase.go` | æ–°å¢å¸¸é‡ | æå°ï¼ˆä»…æ–°å¢ï¼Œä¸æ”¹å·²æœ‰ï¼‰ | ğŸŸ¢ ä½ |
| `types/chunk.go` | æ–°å¢ChunkType | æå°ï¼ˆä»…æ–°å¢å¸¸é‡ï¼‰ | ğŸŸ¢ ä½ |
| `container/container.go` | æ–°å¢æœåŠ¡æ³¨å†Œ | å°ï¼ˆè¿½åŠ æ³¨å†Œï¼Œä¸æ”¹å·²æœ‰é“¾è·¯ï¼‰ | ğŸŸ¢ ä½ |
| `chat_pipline/` | æ–°å¢2ä¸ªPlugin | å°ï¼ˆæ’ä»¶æ¨¡å¼ï¼ŒæŒ‰äº‹ä»¶æ¿€æ´»ï¼‰ | ğŸŸ¢ ä½ |
| `handler/` | æ–°å¢Handler | æ— ï¼ˆæ–°å¢æ–‡ä»¶ï¼‰ | ğŸŸ¢ ä½ |
| `router/` | æ–°å¢è·¯ç”± | å°ï¼ˆè¿½åŠ è·¯ç”±ç»„ï¼‰ | ğŸŸ¢ ä½ |
| `RetrieveEngineRegistry` | æ— å˜æ›´ | æ— ï¼ˆå¤ç”¨ç°æœ‰æ¥å£ï¼‰ | ğŸŸ¢ ä½ |

---

> **æ–‡æ¡£ä¿®è®¢è®°å½•**
> 
> | ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®è®¢å†…å®¹ | ä½œè€… |
> |------|------|----------|------|
> | v1.0 | 2026-02-12 | åˆå§‹ç‰ˆæœ¬ | WeKnora Architecture Team |
